<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Feed - Publicações</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            overflow-x: hidden;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #5D5CDE 0%, #8B5A87 100%);
        }
        
        .post-card, .profile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .like-animation {
            animation: likeScale 0.3s ease;
        }
        
        @keyframes likeScale {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .fullscreen-modal {
            background: rgba(0,0,0,0.95);
        }
        
        .fullscreen-content {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #5D5CDE;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4F46E5;
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-google {
            background-color: #4285F4;
            color: white;
        }
        
        .btn-google:hover {
            background-color: #3367D6;
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-follow {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 14px;
        }
        
        .btn-follow:hover {
            background-color: #059669;
        }
        
        .btn-following {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 14px;
        }
        
        .btn-following:hover {
            background-color: #4b5563;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
        }
        
        .textarea-field {
            resize: vertical;
            min-height: 100px;
        }
        
        .image-preview {
            position: relative;
            display: inline-block;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        
        .image-preview img {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .video-embed {
            position: relative;
            width: 100%;
            height: 315px;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .video-embed iframe {
            width: 100%;
            height: 100%;
        }
        
        .user-avatar {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-avatar-fallback {
            background: linear-gradient(135deg, #5D5CDE, #8B5A87);
            color: white;
            font-weight: bold;
            border-radius: 50%;
        }
        
        .hidden {
            display: none !important;
        }
        
        .comments-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .comment-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .comment-content {
            background: #f3f4f6;
            padding: 0.75rem;
            border-radius: 8px;
            flex: 1;
        }
        
        .engagement-bar {
            display: flex;
            gap: 1.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 1rem;
        }
        
        .engagement-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: none;
            background: none;
            color: #6b7280;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .engagement-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .engagement-btn.liked {
            color: #ef4444;
        }
        
        .engagement-btn.reported {
            color: #f59e0b;
        }
        
        .image-grid {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .image-grid.single {
            grid-template-columns: 1fr;
        }
        
        .image-grid.multiple {
            grid-template-columns: 1fr 1fr;
        }
        
        .image-grid img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .app-icon {
            display:none;
            width: 58%;
      height: 58%;
        }
        
        .empty-feed {
            text-align: center;
            padding: 3rem 2rem;
            color: #6b7280;
        }
        
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            color: #374151;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .category-badge.geral { background: #ddd6fe; color: #5b21b6; }
        .category-badge.tecnologia { background: #dbeafe; color: #1e40af; }
        .category-badge.esportes { background: #dcfce7; color: #166534; }
        .category-badge.entretenimento { background: #fef3c7; color: #d97706; }
        .category-badge.noticias { background: #fee2e2; color: #dc2626; }
        .category-badge.educacao { background: #e0f2fe; color: #0e7490; }
        
        .svg-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .full-timestamp {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .header-search {
            position: relative;
            max-width: 400px;
            flex: 1;
        }
        
        .header-search input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .header-search input:focus {
            outline: none;
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
        }
        
        .header-search .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        .header-filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .header-filters select {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        /* Profile */
        .profile-header {
            background: linear-gradient(135deg, #5D5CDE 0%, #8B5A87 100%);
            color: white;
            padding: 0;
            border-radius: 12px 12px 0 0;
            position: relative;
            min-height: 200px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        
        .profile-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 2rem;
        }
        
        .profile-info {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: end;
            gap: 1rem;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border: 4px solid white;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .profile-details {
            flex: 1;
            margin-bottom: 1rem;
        }
        
        .profile-stats {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            justify-content: center;
        }
        
        .stat-item {
            text-align: center;
            cursor: pointer;
        }
        
        .stat-item:hover {
            color: #5D5CDE;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .profile-actions {
            padding: 0 2rem 2rem 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab-button {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: #5D5CDE;
            border-bottom-color: #5D5CDE;
        }
        
        .user-list-item {
            display: flex;
            items-center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .user-list-item:last-child {
            border-bottom: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            flex: 1;
        }
        
        .user-info:hover {
            color: #5D5CDE;
        }

        /* Enhanced link styles */
        .processed-content {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .processed-content a {
            text-decoration: none;
            border-radius: 4px;
            padding: 2px 4px;
            transition: all 0.2s ease;
        }

        .processed-content a:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .processed-content .mention {
            background-color: rgba(147, 51, 234, 0.1);
            padding: 2px 6px;
            border-radius: 12px;
        }

        .processed-content .hashtag {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 12px;
        }

        .clickable-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
            margin: 0 2px;
        }

        .clickable-icon:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: scale(1.1);
        }

        /* Text wrapping improvements */
        .post-card {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .comment-content {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* Container width constraints */
        .max-w-4xl {
            max-width: 100%;
            width: 100%;
        }

        @media (min-width: 768px) {
            .max-w-4xl {
                max-width: 896px;
            }
        }
        
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .image-preview img {
                width: 120px;
                height: 80px;
            }
            
            .engagement-bar {
                gap: 1rem;
            }
            
            .login-card {
                padding: 2rem;
            }
            
            .profile-stats {
                gap: 1rem;
            }
            
            .header-filters {
                display: none;
            }
            
            .header-search {
                max-width: 200px;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #181818;
                color: #e5e7eb;
            }
            
            .post-card, .profile-card {
                background: #2d2d2d;
                color: #e5e7eb;
            }
            
            .input-field {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }
            
            .input-field:focus {
                border-color: #5D5CDE;
            }
            
            .modal-content {
                background: #2d2d2d;
                color: #e5e7eb;
            }
            
            .login-card {
                background: #2d2d2d;
                color: #e5e7eb;
            }
            
            .comment-content {
                background: #374151;
            }
            
            .engagement-btn:hover {
                background: #374151;
            }
            
            .category-badge {
                background: #374151;
                color: #d1d5db;
            }
            
            .header-search input {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }
            
            .header-filters select {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }

            .processed-content a:hover {
                background-color: rgba(59, 130, 246, 0.2);
            }

            .processed-content .mention {
                background-color: rgba(147, 51, 234, 0.2);
            }

            .processed-content .hashtag {
                background-color: rgba(59, 130, 246, 0.2);
            }

            .clickable-icon:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }
        }
    
    
    .logo-wrap {
      width: clamp(72px, 20vw, 120px);
      height: clamp(72px, 20vw, 120px);
      display: grid;
      place-items: center;
      border-radius: 24px;
      background: radial-gradient(120% 120% at 20% 20%, rgba(168,85,247,0.18), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(168,85,247,0.25);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      box-shadow:
        0 10px 30px rgba(0,0,0,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.03);
      animation: float 3.5s ease-in-out infinite;
    }

    .logo {
      width: 58%;
      height: 58%;
    }

    .brand {
      font-size: clamp(24px, 6vw, 40px);
      font-weight: 700;
    }
    .plus {
      color: var(--brand);
      text-shadow: 0 0 16px rgba(168,85,247,0.35);
    }

    .tagline {
      font-size: clamp(12px, 3.2vw, 14px);
      color: var(--muted);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50%      { transform: translateY(-6px); }
    }
    
    #btn-open-overlay2 {
  background: linear-gradient(135deg, #6a0dad, #9b4dff);
  color: #fff;
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}
/* Habilita cliques apenas quando aberto */
#overlay2 { pointer-events: none; }
#overlay2.is-open2 { pointer-events: auto; }

/* Garante que o painel receba cliques normalmente */
#overlay2-panel { pointer-events: auto; }
#overlay2 {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: grid;
  grid-template-areas: "stack";
  pointer-events: none;
}

#overlay2[aria-hidden="true"] {
  display: none;
}

#overlay2-backdrop {
  grid-area: stack;
  background: rgba(0, 0, 0, 0.4);
  opacity: 0;
  transition: opacity 0.2s ease;
}

#overlay2-panel {
  grid-area: stack;
  height: 100dvh;
  width: 100vw;
  background: #f9f9fb;
  color: #222;
  transform: translateY(8%);
  opacity: 0;
  transition: transform 0.25s ease, opacity 0.2s ease;
  display: grid;
  grid-template-rows: 56px 1fr;
}

#overlay2-header {
  display: grid;
  grid-template-columns: 56px 1fr 56px;
  align-items: center;
  padding: 0 6px;
  border-bottom: 1px solid #ddd;
  background: #fff;
}

#overlay2-back {
  height: 40px;
  width: 40px;
  margin-left: 6px;
  display: grid;
  place-items: center;
  background: transparent;
  color: #6a0dad;
  border: 1px solid transparent;
  border-radius: 10px;
  cursor: pointer;
}

#overlay2-back:focus-visible {
  border-color: #6a0dad;
  outline: none;
}

#overlay2-title {
  margin: 0;
  font-size: 1.05rem;
  font-weight: 700;
  text-align: left;
}

    /* Área à direita no header do overlay2 */
#overlay2-right {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px; /* espaço entre múltiplos itens */
  padding-right: 6px;
  margin-right: 20px;
}
    
#overlay2-body {
  padding: 0px;
  overflow: auto;
}

    /* Container */
#sortFilter {
  display: inline-flex;
  gap: 8px;
  background: #f9f9fb;
  padding: 6px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

/* Botões */
#sortFilter .sf-option {
  background: #fff;
  color: #6a0dad;
  border: 1px solid #d0c4e8;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}

/* Efeito hover */
#sortFilter .sf-option:hover {
  background: #f3eaff;
  border-color: #b08ae0;
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(106, 13, 173, 0.15);
}

/* Estado ativo */
#sortFilter .sf-option.active {
  background: linear-gradient(135deg, #6a0dad, #9b4dff);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 3px 8px rgba(106, 13, 173, 0.3);
}

/* Animação de clique */
#sortFilter .sf-option:active {
  transform: scale(0.96);
}

/* Pequeno efeito de "onda" ao clicar */
#sortFilter .sf-option::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.4);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
  pointer-events: none;
}

#sortFilter .sf-option:active::after {
  width: 200%;
  height: 200%;
  opacity: 0;
}
/* Estado aberto */
#overlay2.is-open2 #overlay2-backdrop {
  opacity: 1;
}

#overlay2.is-open2 #overlay2-panel {
  transform: translateY(0);
  opacity: 1;
}
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div style="display:;"  id="loadingScreen" class="login-container gradient-bg">
        <div style="display:;"  class="login-card">
            <div class="app-icon">
                <svg class="logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="8" y="8" width="48" height="48" rx="12" fill="url(#g1)"/>
        <path d="M22 44V20h6v9.8L41 20h7l-12 12 12 12h-7L28 34.2V44h-6z" fill="white" fill-opacity="0.96"/>
        <defs>
          <linearGradient id="g1" x1="8" y1="8" x2="56" y2="56" gradientUnits="userSpaceOnUse">
            <stop stop-color="#a855f7"/>
            <stop offset="1" stop-color="#7e22ce"/>
          </linearGradient>
        </defs>
      </svg></div>
            
    <div class="brand">
      Kuia<span class="plus">+</span>
    </div>
            <div style="display:none;"  class="loading-spinner"></div>
            <p class="text-gray-600 mt-4">Organizando publicações... </p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden login-container gradient-bg">
        <div style="display:none; class="login-card">
            <div class="app-icon"></div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2"></h1>
            <p class="text-gray-600 mb-8"></p>
            
            <button onclick="signInWithGoogle()" class="btn btn-google w-full mb-4">
                <svg class="svg-icon" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
            </button>
            
            <p class="text-sm text-gray-500">
                Entre automaticamente se já estiver logado no Google
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40" style="background: white;">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center space-x-3">
                      <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="user-avatar" id="headerUserAvatar" style="width: 32px; height: 32px;" onclick="showProfile(currentUser?.uid)"></div>
                            <span id="currentUser" class="text-gray-600 font-medium hidden md:inline cursor-pointer" onclick="showProfile(currentUser?.uid)"></span>
                        </div>
                    
                    <!-- Search and Filters -->
                    <div class="flex items-center gap-3 flex-1 max-w-2xl">
                        <div class="header-search">
                            <svg class="search-icon svg-icon" viewBox="0 0 24 24">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            <input type="text" id="searchInput" placeholder="Pesquisar posts ou usuários...">
                        </div>
                         
                        <div class="header-filters">
                            <select id="categoryFilter">
                                <option value="">Todas</option>
                                <option value="geral">Geral</option>
                                <option value="tecnologia">Tecnologia</option>
                                <option value="esportes">Esportes</option>
                                <option value="entretenimento">Entretenimento</option>
                                <option value="noticias">Notícias</option>
                                <option value="educacao">Educação</option>
                            </select>
                            
                            
                        </div>
                    </div>
                    
                    
            <!-- Botão que abre o overlay2 -->
<button id="btn-open-overlay2" type="button" aria-haspopup="dialog" aria-controls="overlay2"> 
  <span id="btn-text2">Publicar</span>
</button>
<!-- Overlay2 -->
<div id="overlay2" aria-hidden="true">
  <div id="overlay2-backdrop" data-close2="true"></div>

  <div id="overlay2-panel" role="dialog" aria-modal="true" aria-labelledby="overlay2-title" tabindex="-1">
    <header id="overlay2-header">
      <button id="overlay2-back" type="button" aria-label="Voltar" data-close2="true">←</button>
      <h2 id="overlay2-title">Painel</h2>
      <div id="overlay2-right">
                 <select id="sortFilter">
                                <option value="relevance">Relevantes</option>
                                <option value="newest">Recentes</option>
                                <option value="oldest">Antigos</option>
                                <option value="most_liked">Curtidos</option>
                            </select>  
          <button onclick="signOut()" class="text-gray-500 hover:text-red-500 transition-colors">                             
  <svg id="sair" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
       viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M15 3h-6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6"/>
    <path d="M10 12h10"/>
    <path d="M19 12l-3-3"/>
    <path d="M19 12l-3 3"/>
  </svg>
  <span id="btn-sair-text2">Sair</span>
</button>
                       
        
      </div>
        
    </header>

    <main id="overlay2-body">
        <!-- Create Post -->
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="post-card">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="user-avatar" id="postAuthorAvatar" style="width: 40px; height: 40px;"></div>
                        <span class="font-medium text-gray-800" id="postAuthor"></span>
                    </div>
                    
                    <div id="createPostForm">
                        <textarea id="postContent" placeholder="O que você está pensando?" 
                                  class="input-field textarea-field w-full" 
                                  maxlength="1000"></textarea>
                        
                        <input type="text" id="videoUrl" placeholder="Cole aqui o link do vídeo (YouTube, Vimeo, Dailymotion, TikTok)" 
                               class="input-field w-full mt-3">
                        
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                           <select id="postCategory" class="input-field">
    <option value="geral">Geral</option>
    <option value="tecnologia">Tecnologia</option>
    <option value="esportes">Esportes</option>
    <option value="entretenimento">Entretenimento</option>
    <option value="noticias">Notícias</option>
    <option value="educacao">Educação</option>
    <option value="musica">Música</option>
    <option value="arte">Arte</option>
    <option value="fotografia">Fotografia</option>
    <option value="viagem">Viagem</option>
    <option value="gastronomia">Gastronomia</option>
    <option value="moda">Moda</option>
    <option value="ciencia">Ciência</option>
    <option value="saude">Saúde</option>
    <option value="negocios">Negócios</option>
    <option value="humor">Humor</option>
    <option value="animais">Animais</option>
    <option value="games">Games</option>
    <option value="opiniao">Opinião</option>
    <option value="politica">Política</option>
    <option value="meio-ambiente">Meio Ambiente</option>
    <option value="carreira">Carreira</option>
    <option value="voluntariado">Voluntariado</option>
    <option value="eventos">Eventos</option>
</select>
                        </div>
                        
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-4">
                                <label for="imageUpload" class="flex items-center space-x-2 text-gray-600 hover:text-purple-600 cursor-pointer">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                    </svg>
                                    <span>Fotos</span>
                                </label>
                                <input type="file" id="imageUpload" multiple accept="image/*" class="hidden">
                                <span id="imageCount" class="text-sm text-gray-500">0/4 imagens</span>
                            </div>
                            <button onclick="createPost()" id="postBtn" class="btn btn-primary">
                                Publicar
                            </button>
                        </div>
                        
                        <div id="imagePreview" class="mt-4"></div>
                        <div id="videoPreview" class="mt-4"></div>
                    </div>
                </div>
        </main>
  </div>
</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Feed Content -->
        <div id="feedContent">
            

                <!-- Feed -->
                <div id="feedContainer">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="hidden">
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="profile-card" style="padding: 0; margin-bottom: 2rem;">
                    <div class="profile-header" id="profileHeader" onclick="openProfileCover()">
                        <div class="profile-overlay">
                            <div class="profile-info">
                                <div class="profile-avatar" id="profileAvatar" onclick="openProfilePhoto(event)"></div>
                                <div class="profile-details">
                                    <h2 class="text-2xl font-bold" id="profileName">Nome do Usuário</h2>
                                    <p id="profileBio" class="text-gray-200 mt-1">Bio do usuário...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showFeed()">
                            <svg class="svg-icon" viewBox="0 0 24 24" >
  <g transform="scale(-1,1) translate(-24,0)">
    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5z"/>
  </g>
</svg>

                        </button>
                    <div class="profile-stats">
                        <div class="stat-item" onclick="showProfileTab('posts')">
                            <div class="stat-number" id="postsCount">0</div>
                            <div class="stat-label">Posts</div>
                        </div>
                        <div class="stat-item" onclick="showProfileTab('followers')">
                            <div class="stat-number" id="followersCount">0</div>
                            <div class="stat-label">Seguidores</div>
                        </div>
                        <div class="stat-item" onclick="showProfileTab('following')">
                            <div class="stat-number" id="followingCount">0</div>
                            <div class="stat-label">Seguindo</div>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button id="followBtn" class="btn btn-follow hidden" onclick="toggleFollow()">
                            Seguir
                        </button>
                        <button id="editProfileBtn" class="btn btn-secondary hidden" onclick="showEditProfile()">
                            Editar Perfil
                        </button>
                                                 </div>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showProfileTab('posts')" id="postsTabBtn">Posts</button>
                        <button class="tab-button" onclick="showProfileTab('followers')" id="followersTabBtn">Seguidores</button>
                        <button class="tab-button" onclick="showProfileTab('following')" id="followingTabBtn">Seguindo</button>
                    </div>
                </div>
                
                <div id="profileTabContent">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Confirmar ação</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmModal')" class="btn btn-secondary">Cancelar</button>
                <button id="confirmBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Aviso</h3>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeModal('alertModal')" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Editar Perfil</h3>
            <form id="editProfileForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                  <input type="text" id="editName" class="input-field" maxlength="50" required disabled>
                </div>
                <div class="mb-4">
                    <label  class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                    <textarea id="editBio" class="input-field" rows="3" maxlength="160" placeholder="Conte um pouco sobre você..."></textarea>
                </div>
                <div class="mb-4">
                    <label style="display:none" class="block text-sm font-medium text-gray-700 mb-2">Foto de Perfil</label>
                    <input  style="display:none;"  type="file" id="editProfilePic" accept="image/*" class="input-field">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto de Capa</label>
                     <label for="editCoverPic" class="flex items-center space-x-2 text-gray-600 hover:text-purple-600 cursor-pointer">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                    </svg>              
                         Mudar a foto de Capa
                                </label>
                    <input type="file" id="editCoverPic" accept="image/*" class="hidden">

                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('editProfileModal')" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveProfileBtn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreenModal" class="modal fullscreen-modal">
        <button onclick="closeModal('fullscreenModal')" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; z-index: 1001;">×</button>
        <div id="fullscreenContent"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCE_vGty5XsV1YqdCi49Ck2xJDSFq284wc",
            authDomain: "cliente-movicel.firebaseapp.com",
            databaseURL: "https://cliente-movicel-default-rtdb.firebaseio.com",
            projectId: "cliente-movicel",
            storageBucket: "cliente-movicel.firebasestorage.app",
            messagingSenderId: "215414688375",
            appId: "1:215414688375:web:2c7d20a0c03c4c0fcfd472",
            measurementId: "G-7F1RGP9GHV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // API Config
        const apiKeyImgBB = 'e073e02267a1f0259cd69c562e780659';

        // App State
        let currentUser = null;
        let selectedImages = [];
        let posts = {};
        let postsListener = null;
        let filteredPosts = {};
        let currentViewingProfile = null;
        let currentProfileData = null;

        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Navigation Functions
        function showFeed() {
            document.getElementById('feedContent').classList.remove('hidden');
            document.getElementById('profileContent').classList.add('hidden');
            currentViewingProfile = null;
        }

        function showProfile(userId) {
            if (!userId) return;
            
            console.log('Loading profile for userId:', userId);
            currentViewingProfile = userId;
            document.getElementById('feedContent').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');
            
            // Show loading
            document.getElementById('profileTabContent').innerHTML = '<div class="loading-spinner"></div>';
            
            loadProfile(userId);
        }

        // Search and Filter Functions
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            // Filter posts
            filteredPosts = {};
            Object.entries(posts).forEach(([id, post]) => {
                if (!post) return;
                
                // Search filter
                const matchesSearch = !searchTerm || 
                    (post.content && post.content.toLowerCase().includes(searchTerm)) ||
                    (post.author && post.author.toLowerCase().includes(searchTerm));
                
                // Category filter
                const matchesCategory = !categoryFilter || post.category === categoryFilter;
                
                if (matchesSearch && matchesCategory) {
                    filteredPosts[id] = post;
                }
            });
            
            renderFeed();
        }

        // Video Platform Functions
        function getVideoInfo(url) {
            // YouTube
            const youtubeRegExp = /^.*(youtul.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const youtubeMatch = url.match(youtubeRegExp);
            if (youtubeMatch && youtubeMatch[2].length === 11) {
                return {
                    platform: 'youtube',
                    id: youtubeMatch[2],
                    url: url
                };
            }

            // Vimeo
            const vimeoRegExp = /(?:https?:\/\/)?(?:www\.)?(?:player\.)?vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)/;
            const vimeoMatch = url.match(vimeoRegExp);
            if (vimeoMatch) {
                return {
                    platform: 'vimeo',
                    id: vimeoMatch[1],
                    url: url
                };
            }

            // Dailymotion
            const dailymotionRegExp = /(?:https?:\/\/)?(?:www\.)?dailymotion\.com\/video\/([^_]+)/;
            const dailymotionMatch = url.match(dailymotionRegExp);
            if (dailymotionMatch) {
                return {
                    platform: 'dailymotion',
                    id: dailymotionMatch[1],
                    url: url
                };
            }

            // TikTok
            const tiktokRegExp = /(?:https?:\/\/)?(?:www\.)?tiktok\.com\/@[\w.-]+\/video\/(\d+)/;
            const tiktokMatch = url.match(tiktokRegExp);
            if (tiktokMatch) {
                return {
                    platform: 'tiktok',
                    id: tiktokMatch[1],
                    url: url
                };
            }

            return null;
        }

        function createVideoEmbed(videoInfo) {
            const { platform, id, url } = videoInfo;
            
            switch (platform) {
                case 'youtube':
                    return `
                        <div class="video-embed" onclick="openFullscreen('video', '${id}', '${platform}')">
                            <iframe src="https://www.youtube.com/embed/${id}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    `;
                    
                case 'vimeo':
                    return `
                        <div class="video-embed" onclick="openFullscreen('video', '${id}', '${platform}')">
                            <iframe src="https://player.vimeo.com/video/${id}" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    `;
                    
                case 'dailymotion':
                    return `
                        <div class="video-embed" onclick="openFullscreen('video', '${id}', '${platform}')">
                            <iframe src="https://www.dailymotion.com/embed/video/${id}" 
                                    frameborder="0" 
                                    allow="autoplay; fullscreen" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    `;
                    
                case 'tiktok':
                    return `
                        <div class="video-embed" style="height: 500px;" onclick="window.open('${url}', '_blank')">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #000; border-radius: 8px; color: white;">
                                <div style="text-align: center;">
                                    <svg style="width: 48px; height: 48px; margin-bottom: 1rem;" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-.88-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43V7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.43z"/>
                                    </svg>
                                    <div>Clique para assistir no TikTok</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                default:
                    return '';
            }
        }

        // Content Processing Functions
        function processTextContent(text) {
            if (!text) return '';
            
            let processedText = text;
            
            // Process phone numbers
            const phoneRegex = /(\+?\d{1,4}[\s-]?)?\(?\d{1,4}\)?[\s-]?\d{1,4}[\s-]?\d{1,9}/g;
            processedText = processedText.replace(phoneRegex, (match) => {
                // Only replace if it looks like a valid phone number (8+ digits)
                const digitsOnly = match.replace(/\D/g, '');
                if (digitsOnly.length >= 8) {
                    return `<a href="tel:${digitsOnly}" class="clickable-icon text-green-600 hover:text-green-800" title="Ligar para ${match}">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                        </svg>
                    </a>`;
                }
                return match;
            });
            
            // Process email addresses
            const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            processedText = processedText.replace(emailRegex, (match) => {
                return `<a href="mailto:${match}" class="clickable-icon text-red-600 hover:text-red-800" title="Enviar email para ${match}">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                </a>`;
            });
            
            // Process URLs (but exclude video URLs that will be processed separately)
            const urlRegex = /https?:\/\/[^\s<>"{}|\\^`\[\]]+/g;
            processedText = processedText.replace(urlRegex, (match) => {
                // Skip if it's a video URL
                if (getVideoInfo(match)) {
                    return match;
                }
                
                try {
                    const url = new URL(match);
                    const domain = url.hostname.replace('www.', '');
                    
                    return `<a href="${match}" target="_blank" rel="noopener noreferrer" class="clickable-icon text-blue-600 hover:text-blue-800" title="Abrir ${domain}">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                        </svg>
                    </a>`;
                } catch (e) {
                    return match;
                }
            });
            
            // Process @mentions
            const mentionRegex = /@(\w+)/g;
            processedText = processedText.replace(mentionRegex, (match, username) => {
                return `<span class="mention clickable-icon text-purple-600 font-medium cursor-pointer" onclick="searchUser('${username}')" title="Buscar usuário ${username}">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </span>`;
            });
            
            // Process hashtags
            const hashtagRegex = /#(\w+)/g;
            processedText = processedText.replace(hashtagRegex, (match, tag) => {
                return `<span class="hashtag clickable-icon text-blue-600 font-medium cursor-pointer" onclick="searchHashtag('${tag}')" title="Buscar posts com ${match}">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 8h-3.5L15 2H9L7.5 8H4l1 4h3.5L10 18h6l1.5-6H21l-1-4z"/>
                    </svg>
                </span>`;
            });
            
            return processedText;
        }

        function searchUser(username) {
            document.getElementById('searchInput').value = username;
            applyFilters();
        }

        function searchHashtag(tag) {
            document.getElementById('searchInput').value = '#' + tag;
            applyFilters();
        }

        // Authentication
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Login successful:', result.user);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    showAlert('Erro ao fazer login: ' + error.message);
                });
        }

        function signOut() {
            showConfirmDialog('Tem certeza que deseja sair?', () => {
                auth.signOut()
                    .then(() => {
                        console.log('Logout successful');
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                        showAlert('Erro ao fazer logout: ' + error.message);
                    });
            });
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            console.log('Auth state changed:', user);
            if (user) {
                currentUser = {
                    uid: user.uid,
                    username: user.displayName || 'Usuário',
                    email: user.email,
                    photoURL: user.photoURL
                };
                console.log('Current user set:', currentUser);
                initializeApp();
            } else {
                currentUser = null;
                if (postsListener) {
                    postsListener.off();
                    postsListener = null;
                }
                showLoginScreen();
            }
        });

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // Utility Functions
        function showConfirmDialog(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
            
            document.getElementById('confirmBtn').onclick = function() {
                closeModal('confirmModal');
                callback();
            };
        }

        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function createUserAvatar(user, size = 40) {
            if (!user) {
                return `<div class="user-avatar-fallback" style="width: ${size}px; height: ${size}px; font-size: ${size/3}px;">US</div>`;
            }
            
            if (user.photoURL) {
                return `<img src="${escapeHtml(user.photoURL)}" alt="${escapeHtml(user.username || 'Usuário')}" style="width: ${size}px; height: ${size}px; object-fit: cover;">`;
            } else {
                const initials = (user.username || user.author || 'Usuário').substring(0, 2).toUpperCase();
                return `<div class="user-avatar-fallback" style="width: ${size}px; height: ${size}px; font-size: ${size/3}px;">${escapeHtml(initials)}</div>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Image Processing
        function compressImage(file, maxSize = 100 * 1024) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    
                    const maxDimension = 800;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.8;
                    let dataUrl;
                    
                    do {
                        dataUrl = canvas.toDataURL('image/jpeg', quality);
                        quality -= 0.1;
                    } while (dataUrl.length * 0.75 > maxSize && quality > 0.1);
                    
                    resolve(dataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function uploadImageToImgBB(dataUrl) {
            try {
                const base64Data = dataUrl.split(',')[1];
                const formData = new FormData();
                formData.append('image', base64Data);
                
                const response = await fetch('https://api.imgbb.com/1/upload?key=' + apiKeyImgBB, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Erro no upload: ' + response.status);
                }
                
                const result = await response.json();
                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error('Upload falhou: ' + (result.error ? result.error.message : 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Fullscreen Functions
        function openFullscreen(type, src, platform = 'youtube') {
            const modal = document.getElementById('fullscreenModal');
            const content = document.getElementById('fullscreenContent');
            
            if (type === 'image') {
                content.innerHTML = `<img src="${src}" class="fullscreen-content" alt="Imagem em tela cheia">`;
            } else if (type === 'video') {
                let embedUrl = '';
                switch (platform) {
                    case 'youtube':
                        embedUrl = `https://www.youtube.com/embed/${src}`;
                        break;
                    case 'vimeo':
                        embedUrl = `https://player.vimeo.com/video/${src}`;
                        break;
                    case 'dailymotion':
                        embedUrl = `https://www.dailymotion.com/embed/video/${src}`;
                        break;
                }
                
                content.innerHTML = `
                    <div class="video-embed" style="max-width: 90vw; max-height: 90vh;">
                        <iframe src="${embedUrl}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    </div>
                `;
            }
            
            modal.classList.add('show');
        }

        function openProfilePhoto(event) {
            event.stopPropagation();
            if (currentProfileData && currentProfileData.photoURL) {
                openFullscreen('image', currentProfileData.photoURL);
            }
        }

        function openProfileCover() {
            if (currentProfileData && currentProfileData.coverURL) {
                openFullscreen('image', currentProfileData.coverURL);
            }
        }

        // Post Functions
        function calculatePostScore(post) {
            if (!post || !post.timestamp) return 0;
            
            const now = Date.now();
            const age = (now - post.timestamp) / (1000 * 60 * 60);
            const likes = Object.keys(post.likes || {}).length;
            const comments = Object.keys(post.comments || {}).length;
            
            const engagement = likes * 2 + comments * 3;
            const timeDecay = Math.max(0, 1 - age / 24);
            
            return engagement * timeDecay + (now - post.timestamp) / 1000000;
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Tempo desconhecido';
            
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Agora';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        function formatFullTimestamp(timestamp) {
            if (!timestamp) return 'Data desconhecida';
            
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
                return `Hoje às ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const isYesterday = date.toDateString() === yesterday.toDateString();
            
            if (isYesterday) {
                return `Ontem às ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Event Handlers
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('sortFilter').addEventListener('change', applyFilters);

        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (selectedImages.length + files.length > 4) {
                showAlert('Máximo de 4 imagens por post.');
                return;
            }
            
            processImages(files);
            e.target.value = '';
        });

        document.getElementById('videoUrl').addEventListener('input', function(e) {
            previewVideo();
        });

        async function processImages(files) {
            for (const file of files) {
                if (selectedImages.length >= 4) break;
                
                try {
                    const compressedImage = await compressImage(file);
                    selectedImages.push(compressedImage);
                    updateImagePreview();
                } catch (error) {
                    console.error('Error processing image:', error);
                    showAlert('Erro ao processar imagem.');
                }
            }
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            selectedImages.forEach((img, index) => {
                const size = Math.round((img.length * 0.75) / 1024);
                const div = document.createElement('div');
                div.className = 'image-preview';
                div.innerHTML = `
                    <img src="${img}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removeImage(${index})">×</button>
                    <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 12px; padding: 2px 6px; border-radius: 4px;">${size}KB</div>
                `;
                preview.appendChild(div);
            });
            
            document.getElementById('imageCount').textContent = `${selectedImages.length}/4 imagens`;
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
        }

        function previewVideo() {
            const url = document.getElementById('videoUrl').value.trim();
            const preview = document.getElementById('videoPreview');
            
            if (url) {
                const videoInfo = getVideoInfo(url);
                if (videoInfo) {
                    const platformIcon = {
                        'youtube': '📺',
                        'vimeo': '🎬',
                        'dailymotion': '▶️',
                        'tiktok': '🎵'
                    };
                    
                    preview.innerHTML = `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                <span style="font-size: 14px; color: #6b7280;">
                                    ${platformIcon[videoInfo.platform] || '🎬'} Vídeo do ${videoInfo.platform.charAt(0).toUpperCase() + videoInfo.platform.slice(1)}
                                </span>
                                <button type="button" onclick="clearVideo()" style="color: #ef4444; background: none; border: none; cursor: pointer;">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                </button>
                            </div>
                            ${createVideoEmbed(videoInfo)}
                        </div>
                    `;
                } else {
                    preview.innerHTML = `
                        <div style="color: #ef4444; font-size: 14px;">
                            <svg class="svg-icon" style="display: inline; margin-right: 8px;" viewBox="0 0 24 24">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                            </svg>
                            URL de vídeo inválida. Suportamos: YouTube, Vimeo, Dailymotion e TikTok
                        </div>
                    `;
                }
            } else {
                preview.innerHTML = '';
            }
        }

        function clearVideo() {
            document.getElementById('videoUrl').value = '';
            document.getElementById('videoPreview').innerHTML = '';
        }

        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const category = document.getElementById('postCategory').value;
            
            if (!content && selectedImages.length === 0 && !videoUrl) {
                showAlert('Por favor, adicione algum conteúdo ao seu post.');
                return;
            }
            
            if (!currentUser) {
                showAlert('Você precisa estar logado para postar.');
                return;
            }
            
            const postBtn = document.getElementById('postBtn');
            const originalText = postBtn.textContent;
            postBtn.textContent = 'Publicando...';
            postBtn.disabled = true;
            
            try {
                const post = {
                    author: currentUser.username,
                    authorId: currentUser.uid,
                    authorPhoto: currentUser.photoURL || null,
                    content: content,
                    category: category,
                    timestamp: Date.now(),
                    likes: {},
                    comments: {},
                    reports: {}
                };
                
                console.log('Creating post:', post);
                
                if (selectedImages.length > 0) {
                    post.images = [];
                    for (let i = 0; i < selectedImages.length; i++) {
                        try {
                            const url = await uploadImageToImgBB(selectedImages[i]);
                            post.images.push(url);
                        } catch (error) {
                            console.error('Error uploading image:', error);
                            showAlert('Erro ao enviar imagem ' + (i + 1) + '. Continuando com as outras...');
                        }
                    }
                }
                
                if (videoUrl) {
                    const videoInfo = getVideoInfo(videoUrl);
                    if (videoInfo) {
                        post.videoInfo = videoInfo;
                    }
                }
                
                // Save to Firebase
                const result = await database.ref('posts').push(post);
                console.log('Post saved with ID:', result.key);
                
                // Reset form
                document.getElementById('postContent').value = '';
                document.getElementById('videoUrl').value = '';
                document.getElementById('postCategory').value = 'geral';
                selectedImages = [];
                updateImagePreview();
                clearVideo();
                
                showAlert('Post publicado com sucesso!');
                
            } catch (error) {
                console.error('Error creating post:', error);
                showAlert('Erro ao publicar post: ' + error.message);
            } finally {
                postBtn.textContent = originalText;
                postBtn.disabled = false;
            }
        }

        // Post Actions
        function toggleLike(postId) {
            if (!currentUser || !postId) return;
            
            const postRef = database.ref('posts/' + postId + '/likes/' + currentUser.uid);
            const post = posts[postId];
            
            if (post && post.likes && post.likes[currentUser.uid]) {
                postRef.remove();
            } else {
                postRef.set(true);
            }
        }

        function toggleComments(postId) {
            if (!postId) return;
            
            const commentsSection = document.getElementById('comments-' + postId);
            if (commentsSection) {
                commentsSection.classList.toggle('hidden');
            }
        }

        function addComment(postId) {
            if (!currentUser || !postId) return;
            
            const input = document.getElementById('comment-input-' + postId);
            if (!input) return;
            
            const content = input.value.trim();
            if (!content) return;
            
            database.ref('posts/' + postId + '/comments').push({
                author: currentUser.username,
                authorId: currentUser.uid,
                authorPhoto: currentUser.photoURL || null,
                content: content,
                timestamp: Date.now()
            });
            
            input.value = '';
        }

        function sharePost(postId) {
            if (!postId || !posts[postId]) return;
            
            const post = posts[postId];
            const shareText = `Confira este post de ${post.author || 'alguém'}: ${(post.content || '').substring(0, 100)}...`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Social Feed',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showAlert('Link copiado para a área de transferência!');
                }).catch(() => {
                    showAlert('Não foi possível copiar o link.');
                });
            }
        }

        function reportPost(postId) {
            if (!currentUser || !postId) return;
            
            const post = posts[postId];
            if (!post) return;
            
            if (post.reports && post.reports[currentUser.uid]) {
                showAlert('Você já denunciou este post.');
                return;
            }
            
            showConfirmDialog('Tem certeza que deseja denunciar este post?', async () => {
                await database.ref('posts/' + postId + '/reports/' + currentUser.uid).set(true);
                
                // Check for auto-removal
                database.ref('posts/' + postId + '/reports').once('value').then((snapshot) => {
                    const reportCount = Object.keys(snapshot.val() || {}).length;
                    if (reportCount >= 5) {
                        database.ref('posts/' + postId).remove();
                        showAlert('Post removido automaticamente após 5 denúncias.');
                    } else {
                        showAlert('Denúncia registrada. Obrigado por ajudar a manter a comunidade segura.');
                    }
                });
            });
        }

        function deletePost(postId) {
            if (!currentUser || !postId) return;
            
            showConfirmDialog('Tem certeza que deseja excluir este post?', async () => {
                await database.ref('posts/' + postId).remove();
                showAlert('Post excluído com sucesso.');
            });
        }

        // Profile Functions
        async function loadProfile(userId) {
            try {
                console.log('Loading profile data for:', userId);
                
                // Load profile data
                const profileSnapshot = await database.ref(`profiles/${userId}`).once('value');
                const profile = profileSnapshot.val();
                console.log('Profile data:', profile);
                
                // Load user's posts
                const postsSnapshot = await database.ref('posts').orderByChild('authorId').equalTo(userId).once('value');
                const userPosts = postsSnapshot.val() || {};
                console.log('User posts:', Object.keys(userPosts).length);
                
                // Load followers/following
                const followersSnapshot = await database.ref(`follows/${userId}/followers`).once('value');
                const followingSnapshot = await database.ref(`follows/${userId}/following`).once('value');
                const myFollowingSnapshot = await database.ref(`follows/${currentUser.uid}/following`).once('value');
                
                const followers = followersSnapshot.val() || {};
                const following = followingSnapshot.val() || {};
                const myFollowing = myFollowingSnapshot.val() || {};
                
                console.log('Followers:', Object.keys(followers).length);
                console.log('Following:', Object.keys(following).length);
                
                // Load profile data for followers/following users
                const userProfiles = {};
                const allUserIds = [...Object.keys(followers), ...Object.keys(following)];
                
                for (const uid of allUserIds) {
                    if (uid !== userId) {
                        try {
                            const userProfileSnapshot = await database.ref(`profiles/${uid}`).once('value');
                            const userProfile = userProfileSnapshot.val();
                            userProfiles[uid] = userProfile || { username: uid };
                        } catch (error) {
                            console.error('Error loading user profile:', uid, error);
                            userProfiles[uid] = { username: uid };
                        }
                    }
                }
                
                renderProfile(userId, profile, userPosts, followers, following, userProfiles, myFollowing);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('Erro ao carregar perfil: ' + error.message);
            }
        }

        function renderProfile(userId, profile, userPosts, followers, following, userProfiles, myFollowing) {
            const isOwnProfile = userId === currentUser.uid;
            const isFollowing = !isOwnProfile && followers[currentUser.uid];
            
            console.log('Rendering profile for:', userId, 'isOwnProfile:', isOwnProfile);
            
            // Create default profile data
            let profileData = {
                username: 'Usuário',
                bio: 'Sem bio ainda...',
                photoURL: null,
                coverURL: null
            };
            
            // Use profile data if exists
            if (profile) {
                profileData = { ...profileData, ...profile };
            } else if (isOwnProfile) {
                profileData.username = currentUser.username;
                profileData.photoURL = currentUser.photoURL;
            }
            
            // Store current profile data globally
            currentProfileData = profileData;
            
            // Update profile header
            document.getElementById('profileName').textContent = profileData.username;
            document.getElementById('profileBio').textContent = profileData.bio;
            
            const profileAvatar = document.getElementById('profileAvatar');
            profileAvatar.innerHTML = createUserAvatar({
                username: profileData.username,
                photoURL: profileData.photoURL
            }, 96);
            
            // Update cover photo
            const profileHeader = document.getElementById('profileHeader');
            if (profileData.coverURL) {
                profileHeader.style.backgroundImage = `url(${profileData.coverURL})`;
                profileHeader.style.backgroundSize = 'cover';
                profileHeader.style.backgroundPosition = 'center';
            } else {
                profileHeader.style.backgroundImage = '';
            }
            
            // Update stats
            document.getElementById('postsCount').textContent = Object.keys(userPosts).length;
            document.getElementById('followersCount').textContent = Object.keys(followers).length;
            document.getElementById('followingCount').textContent = Object.keys(following).length;
            
            // Update buttons
            const followBtn = document.getElementById('followBtn');
            const editBtn = document.getElementById('editProfileBtn');
            
            if (isOwnProfile) {
                followBtn.classList.add('hidden');
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
                followBtn.classList.remove('hidden');
                followBtn.textContent = isFollowing ? 'Seguindo' : 'Seguir';
                followBtn.className = isFollowing ? 'btn btn-following' : 'btn btn-follow';
            }
            
            // Store data for tab functions
            currentProfileData.userPosts = userPosts;
            currentProfileData.followers = followers;
            currentProfileData.following = following;
            currentProfileData.userProfiles = userProfiles;
            currentProfileData.myFollowing = myFollowing;
            
            // Show posts by default
            showProfileTab('posts');
        }

        function showProfileTab(tab) {
            console.log('Showing profile tab:', tab);
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tab + 'TabBtn').classList.add('active');
            
            const content = document.getElementById('profileTabContent');
            
            if (!currentProfileData) {
                content.innerHTML = '<div class="post-card"><p class="text-gray-500">Erro ao carregar dados do perfil.</p></div>';
                return;
            }
            
            switch (tab) {
                case 'posts':
                    const userPosts = currentProfileData.userPosts || {};
                    const sortedPosts = Object.entries(userPosts).sort(([,a], [,b]) => b.timestamp - a.timestamp);
                    if (sortedPosts.length === 0) {
                        content.innerHTML = `
                            <div class="post-card">
                                <div class="text-center text-gray-500 py-8">
                                    <svg class="svg-icon mx-auto mb-4" style="width: 48px; height: 48px; opacity: 0.5;" viewBox="0 0 24 24">
                                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                    </svg>
                                    <p>Nenhum post ainda</p>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = sortedPosts.map(([id, post]) => renderPost(id, post)).join('');
                    }
                    break;
                    
                case 'followers':
                    const followers = currentProfileData.followers || {};
                    const followersList = Object.keys(followers);
                    content.innerHTML = `
                        <div class="post-card">
                            <h4 class="font-semibold mb-4">Seguidores (${followersList.length})</h4>
                            ${followersList.length === 0 ? 
                                '<p class="text-gray-500">Nenhum seguidor ainda</p>' :
                                followersList.map(userId => {
                                    const userProfile = currentProfileData.userProfiles[userId] || { username: userId };
                                    const isFollowingUser = currentProfileData.myFollowing[userId];
                                    const isMe = userId === currentUser.uid;
                                    
                                    return `
                                        <div class="user-list-item">
                                            <div class="user-info" onclick="showProfile('${userId}')">
                                                <div class="user-avatar" style="width: 40px; height: 40px;">${createUserAvatar(userProfile, 40)}</div>
                                                <div>
                                                    <div class="font-medium">${escapeHtml(userProfile.username)}</div>
                                                    ${userProfile.bio ? `<div class="text-sm text-gray-500">${escapeHtml(userProfile.bio)}</div>` : ''}
                                                </div>
                                            </div>
                                            ${!isMe ? `
                                                <button onclick="toggleFollowUser('${userId}')" class="btn ${isFollowingUser ? 'btn-following' : 'btn-follow'}" style="padding: 0.5rem 1rem; font-size: 12px;">
                                                    ${isFollowingUser ? 'Seguindo' : 'Seguir'}
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    `;
                    break;
                    
                case 'following':
                    const following = currentProfileData.following || {};
                    const followingList = Object.keys(following);
                    content.innerHTML = `
                        <div class="post-card">
                            <h4 class="font-semibold mb-4">Seguindo (${followingList.length})</h4>
                            ${followingList.length === 0 ? 
                                '<p class="text-gray-500">Não está seguindo ninguém ainda</p>' :
                                followingList.map(userId => {
                                    const userProfile = currentProfileData.userProfiles[userId] || { username: userId };
                                    const isFollowingUser = currentProfileData.myFollowing[userId];
                                    const isMe = userId === currentUser.uid;
                                    
                                    return `
                                        <div class="user-list-item">
                                            <div class="user-info" onclick="showProfile('${userId}')">
                                                <div class="user-avatar" style="width: 40px; height: 40px;">${createUserAvatar(userProfile, 40)}</div>
                                                <div>
                                                    <div class="font-medium">${escapeHtml(userProfile.username)}</div>
                                                    ${userProfile.bio ? `<div class="text-sm text-gray-500">${escapeHtml(userProfile.bio)}</div>` : ''}
                                                </div>
                                            </div>
                                            ${!isMe ? `
                                                <button onclick="toggleFollowUser('${userId}')" class="btn ${isFollowingUser ? 'btn-following' : 'btn-follow'}" style="padding: 0.5rem 1rem; font-size: 12px;">
                                                    ${isFollowingUser ? 'Seguindo' : 'Seguir'}
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    `;
                    break;
            }
        }

        async function toggleFollow() {
            if (!currentViewingProfile || currentViewingProfile === currentUser.uid) return;
            
            try {
                const isFollowingSnapshot = await database.ref(`follows/${currentViewingProfile}/followers/${currentUser.uid}`).once('value');
                
                if (isFollowingSnapshot.val()) {
                    // Unfollow
                    await database.ref(`follows/${currentViewingProfile}/followers/${currentUser.uid}`).remove();
                    await database.ref(`follows/${currentUser.uid}/following/${currentViewingProfile}`).remove();
                } else {
                    // Follow
                    await database.ref(`follows/${currentViewingProfile}/followers/${currentUser.uid}`).set(true);
                    await database.ref(`follows/${currentUser.uid}/following/${currentViewingProfile}`).set(true);
                }
                
                // Refresh profile
                loadProfile(currentViewingProfile);
                
            } catch (error) {
                console.error('Error toggling follow:', error);
                showAlert('Erro ao seguir/deixar de seguir: ' + error.message);
            }
        }

        async function toggleFollowUser(userId) {
            if (!userId || userId === currentUser.uid) return;
            
            try {
                const isFollowingSnapshot = await database.ref(`follows/${userId}/followers/${currentUser.uid}`).once('value');
                
                if (isFollowingSnapshot.val()) {
                    // Unfollow
                    await database.ref(`follows/${userId}/followers/${currentUser.uid}`).remove();
                    await database.ref(`follows/${currentUser.uid}/following/${userId}`).remove();
                } else {
                    // Follow
                    await database.ref(`follows/${userId}/followers/${currentUser.uid}`).set(true);
                    await database.ref(`follows/${currentUser.uid}/following/${userId}`).set(true);
                }
                
                // Refresh current profile view
                if (currentViewingProfile) {
                    loadProfile(currentViewingProfile);
                }
                
            } catch (error) {
                console.error('Error toggling follow user:', error);
                showAlert('Erro ao seguir/deixar de seguir: ' + error.message);
            }
        }

        function showEditProfile() {
            document.getElementById('editProfileModal').classList.add('show');
            
            // Load current data
            database.ref(`profiles/${currentUser.uid}`).once('value').then((snapshot) => {
                const profile = snapshot.val() || {};
                document.getElementById('editName').value = profile.username || currentUser.username;
                document.getElementById('editBio').value = profile.bio || '';
            });
        }

        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('editName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const profilePic = document.getElementById('editProfilePic').files[0];
            const coverPic = document.getElementById('editCoverPic').files[0];
            
            if (!name) {
                showAlert('Nome é obrigatório.');
                return;
            }
            
            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;
            
            try {
                const profileData = {
                    username: name,
                    bio: bio,
                    photoURL: currentUser.photoURL,
                    coverURL: null
                };
                
                // Load existing profile to preserve cover URL
                const existingProfile = await database.ref(`profiles/${currentUser.uid}`).once('value');
                const existing = existingProfile.val();
                if (existing && existing.coverURL) {
                    profileData.coverURL = existing.coverURL;
                }
                
                if (profilePic) {
                    const compressed = await compressImage(profilePic);
                    profileData.photoURL = await uploadImageToImgBB(compressed);
                }
                
                if (coverPic) {
                    const compressed = await compressImage(coverPic, 500 * 1024); // 500KB for cover
                    profileData.coverURL = await uploadImageToImgBB(compressed);
                }
                
                await database.ref(`profiles/${currentUser.uid}`).set(profileData);
                
                // Update current user data
                currentUser.username = name;
                currentUser.photoURL = profileData.photoURL;
                
                closeModal('editProfileModal');
                showAlert('Perfil atualizado com sucesso!');
                
                // Update header avatar
                document.getElementById('headerUserAvatar').innerHTML = createUserAvatar(currentUser, 32);
                document.getElementById('currentUser').textContent = currentUser.username;
                document.getElementById('postAuthor').textContent = currentUser.username;
                document.getElementById('postAuthorAvatar').innerHTML = createUserAvatar(currentUser);
                
                // Refresh profile if viewing own profile
                if (currentViewingProfile === currentUser.uid) {
                    loadProfile(currentUser.uid);
                }
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Erro ao atualizar perfil: ' + error.message);
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        });

        // Render Functions
        function renderPost(postId, postData) {
            if (!postData || !postId) {
                console.log('Invalid post data:', postId, postData);
                return '';
            }
            
            // Store original data to prevent changes
            const originalData = JSON.parse(JSON.stringify(postData));
            
            // Safe access to post data with defaults
            const author = originalData.author || 'Usuário Anônimo';
            const authorId = originalData.authorId || null;
            const authorPhoto = originalData.authorPhoto || null;
            const content = originalData.content || '';
            const category = originalData.category || 'geral';
            const timestamp = originalData.timestamp || Date.now();
            const likes = originalData.likes || {};
            const comments = originalData.comments || {};
            const reports = originalData.reports || {};
            
            const likesCount = Object.keys(likes).length;
            const commentsCount = Object.keys(comments).length;
            const reportsCount = Object.keys(reports).length;
            
            const userLiked = currentUser && likes[currentUser.uid];
            const userReported = currentUser && reports[currentUser.uid];
            const isAuthor = currentUser && authorId === currentUser.uid;
            
            const timeAgo = formatTimeAgo(timestamp);
            const fullTimestamp = formatFullTimestamp(timestamp);
            
            // Create author avatar
            const authorUser = {
                username: author,
                photoURL: authorPhoto,
                author: author
            };
            const authorAvatar = createUserAvatar(authorUser);
            
            let imagesHtml = '';
            if (originalData.images && originalData.images.length > 0) {
                const gridClass = originalData.images.length === 1 ? 'single' : 'multiple';
                imagesHtml = `
                    <div class="image-grid ${gridClass}">
                        ${originalData.images.map(img => `
                            <img src="${escapeHtml(img)}" alt="Post image" onclick="openFullscreen('image', '${escapeHtml(img)}')" onerror="this.style.display='none'">
                        `).join('')}
                    </div>
                `;
            }
            
            let videoHtml = '';
            if (originalData.videoInfo) {
                videoHtml = `<div style="margin-top: 1rem;">${createVideoEmbed(originalData.videoInfo)}</div>`;
            }
            
            const commentsHtml = renderComments(comments);
            
            // Process content for links, phones, etc.
            const processedContent = content ? processTextContent(content) : '';
            
            return `
                <div class="post-card" data-post-id="${postId}">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="user-avatar" style="width: 40px; height: 40px;" onclick="showProfile('${authorId}')">${authorAvatar}</div>
                            <div>
                                <div style="font-weight: 500; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                    <span onclick="showProfile('${authorId}')" style="cursor: pointer;">${escapeHtml(author)}</span>
                                    <span class="category-badge ${category}">${escapeHtml(category)}</span>
                                </div>
                                <div style="font-size: 14px; color: #6b7280;">${timeAgo}</div>
                                <div class="full-timestamp">${fullTimestamp}</div>
                            </div>
                        </div>
                        ${isAuthor ? `
                            <button onclick="deletePost('${postId}')" style="color: #9ca3af; background: none; border: none; cursor: pointer; transition: color 0.2s; padding: 0.5rem;" title="Excluir post">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                    
                    ${processedContent ? `<div class="processed-content" style="color: #1f2937; white-space: pre-wrap; margin-bottom: 1rem; line-height: 1.5;">${processedContent}</div>` : ''}
                    
                    ${imagesHtml}
                    ${videoHtml}
                    
                    <div class="engagement-bar">
                        <button onclick="toggleLike('${postId}')" class="engagement-btn ${userLiked ? 'liked' : ''}" title="Curtir">
                            <svg class="svg-icon ${userLiked ? 'like-animation' : ''}" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            <span>${likesCount}</span>
                        </button>
                        <button onclick="toggleComments('${postId}')" class="engagement-btn" title="Comentários">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M21.99 4c0-1.1-.89-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/>
                            </svg>
                            <span>${commentsCount}</span>
                        </button>
                        <button onclick="sharePost('${postId}')" class="engagement-btn" title="Compartilhar">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                        </button>
                        ${!isAuthor && currentUser ? `
                            <button onclick="reportPost('${postId}')" class="engagement-btn ${userReported ? 'reported' : ''}" title="Denunciar post">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/>
                                </svg>
                                ${reportsCount > 0 ? `<span>${reportsCount}</span>` : ''}
                            </button>
                        ` : ''}
                    </div>
                    
                    <div id="comments-${postId}" class="comments-section hidden">
                        <div style="margin-bottom: 1rem;">${commentsHtml}</div>
                        ${currentUser ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="comment-input-${postId}" placeholder="Escreva um comentário..." 
                                       class="input-field" style="flex: 1;" onkeypress="if(event.key==='Enter') addComment('${postId}')">
                                <button onclick="addComment('${postId}')" class="btn btn-primary">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                    </svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderComments(comments) {
            if (!comments || Object.keys(comments).length === 0) {
                return '';
            }
            
            return Object.entries(comments).map(([commentId, comment]) => {
                if (!comment) return '';
                
                const author = comment.author || 'Usuário Anônimo';
                const content = comment.content || '';
                const timestamp = comment.timestamp || Date.now();
                const authorPhoto = comment.authorPhoto || null;
                const authorId = comment.authorId || null;
                
                const commentUser = {
                    username: author,
                    photoURL: authorPhoto,
                    author: author
                };
                const commentAvatar = createUserAvatar(commentUser, 32);
                
                // Process comment content for links, phones, etc.
                const processedContent = processTextContent(content);
                
                return `
                    <div class="comment-item">
                        <div class="user-avatar" style="width: 32px; height: 32px;" onclick="showProfile('${authorId}')">${commentAvatar}</div>
                        <div class="comment-content">
                            <div style="font-weight: 500; font-size: 14px; color: #1f2937; cursor: pointer;" onclick="showProfile('${authorId}')">${escapeHtml(author)}</div>
                            <div class="processed-content" style="color: #374151; line-height: 1.4;">${processedContent}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${formatTimeAgo(timestamp)}</div>
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join('');
        }

        function renderFeed() {
            console.log('Rendering feed with posts:', Object.keys(filteredPosts).length);
            
            const postsToRender = Object.keys(filteredPosts).length > 0 ? filteredPosts : posts;
            
            if (!postsToRender || Object.keys(postsToRender).length === 0) {
                document.getElementById('feedContainer').innerHTML = `
                    <div class="empty-feed">
                        <svg class="svg-icon" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;" viewBox="0 0 24 24">
                            <path d="M21.99 4c0-1.1-.89-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/>
                        </svg>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Nenhum post encontrado</h3>
                        <p>Seja o primeiro a compartilhar algo interessante!</p>
                    </div>
                `;
                return;
            }
            
            const sortFilter = document.getElementById('sortFilter').value;
            
            let sortedPosts = Object.entries(postsToRender)
                .filter(([id, data]) => data !== null && data !== undefined)
                .map(([id, data]) => ({ id, data, score: calculatePostScore(data) }));
            
            // Apply sorting
            switch (sortFilter) {
                case 'newest':
                    sortedPosts.sort((a, b) => (b.data.timestamp || 0) - (a.data.timestamp || 0));
                    break;
                case 'oldest':
                    sortedPosts.sort((a, b) => (a.data.timestamp || 0) - (b.data.timestamp || 0));
                    break;
                case 'most_liked':
                    sortedPosts.sort((a, b) => {
                        const aLikes = Object.keys(a.data.likes || {}).length;
                        const bLikes = Object.keys(b.data.likes || {}).length;
                        return bLikes - aLikes;
                    });
                    break;
                default: // relevance
                    sortedPosts.sort((a, b) => b.score - a.score);
                    break;
            }
            
            console.log('Sorted posts:', sortedPosts.length);
            
            if (sortedPosts.length === 0) {
                document.getElementById('feedContainer').innerHTML = `
                    <div class="empty-feed">
                        <svg class="svg-icon" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Nenhum post encontrado</h3>
                        <p>Tente ajustar os filtros de pesquisa</p>
                    </div>
                `;
                return;
            }
            
            const feedHtml = sortedPosts.map(({ id, data }) => {
                try {
                    return renderPost(id, data);
                } catch (error) {
                    console.error('Error rendering post:', id, error);
                    return '';
                }
            }).filter(html => html !== '').join('');
            
            document.getElementById('feedContainer').innerHTML = feedHtml;
        }

        // Initialize App
        function initializeApp() {
            console.log('Initializing app for user:', currentUser);
            showMainApp();
            
            if (!currentUser) {
                console.error('No current user found');
                return;
            }
            
            document.getElementById('currentUser').textContent = currentUser.username;
            document.getElementById('postAuthor').textContent = currentUser.username;
            
            // Set user avatars
            document.getElementById('headerUserAvatar').innerHTML = createUserAvatar(currentUser, 32);
            document.getElementById('postAuthorAvatar').innerHTML = createUserAvatar(currentUser);
            
            // Initialize profile if not exists
            database.ref(`profiles/${currentUser.uid}`).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`profiles/${currentUser.uid}`).set({
                        username: currentUser.username,
                        bio: '',
                        photoURL: currentUser.photoURL,
                        coverURL: null
                    });
                }
            });
            
            // Listen to posts
            if (postsListener) {
                postsListener.off();
            }
            
            postsListener = database.ref('posts').on('value', (snapshot) => {
                console.log('Posts data received:', snapshot.exists());
                const data = snapshot.val();
                console.log('Raw posts data:', data);
                
                posts = data || {};
                console.log('Processed posts object:', posts);
                
                // Apply filters when data changes
                applyFilters();
            }, (error) => {
                console.error('Error listening to posts:', error);
                showAlert('O Kuia+ irá sair dentro de 3 segundos pra completar ação');
            });
            
            // Show feed by default
            showFeed();
        }

        // Add event listeners for Enter key
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey && e.target.id === 'postContent') {
                createPost();
            }
        });

        // Start the app - Firebase auth will handle the rest
        window.addEventListener('load', () => {
            console.log('App loaded, waiting for auth state...');
        });
    </script>
    <script>
    document.getElementById("sair").onclick = function() {
        setTimeout(function() {
            AndroidBridge1.resetLogin();
        }, 4000); // 4000 milissegundos = 4 segundo
    };
</script>
        <script>
(function(){
  const overlay2 = document.getElementById('overlay2');
  const openBtn2 = document.getElementById('btn-open-overlay2');
  const panel2   = document.getElementById('overlay2-panel');

  if (!overlay2 || !openBtn2 || !panel2) return; // garante IDs corretos

  function openOverlay2(){
    if (overlay2.classList.contains('is-open2')) return;
    overlay2.setAttribute('aria-hidden', 'false');
    overlay2.classList.add('is-open2');
    // opcional: foco
    try { panel2.focus({preventScroll:true}); } catch(e){}
  }

  function closeOverlay2(){
    if (!overlay2.classList.contains('is-open2')) return;
    overlay2.classList.remove('is-open2');
    overlay2.setAttribute('aria-hidden', 'true');
  }

  // Abrir
  openBtn2.addEventListener('click', openOverlay2);

  // Fechar por clique (usa closest para capturar filhos como SVG, spans, etc.)
  overlay2.addEventListener('click', (e) => {
    if (e.target.closest('[data-close2="true"]')) {
      closeOverlay2();
    }
  });

  // Fechar por ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay2.classList.contains('is-open2')) {
      e.preventDefault();
      closeOverlay2();
    }
  });
})();
</script>
        
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Anúncios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        
        .ad-container {
            background: rgba(0, 0, 0, 1);
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }
        
        .progress-bar {
            transition: width 0.1s linear;
        }
        
        .close-button {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .close-button:hover:not(.disabled) {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .close-button.disabled {
            background: rgba(128, 128, 128, 0.3) !important;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        .floating {
            animation: floating 6s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translate(0, 0px); }
            50% { transform: translate(0, -20px); }
            100% { transform: translate(0, 0px); }
        }
        
        .dots-loading {
            display: inline-block;
        }
        
        .dots-loading::after {
            content: '';
            animation: dots 2s linear infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .connection-status {
            transition: all 0.3s ease;
        }
        
        .status-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .status-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .status-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ripple {
            animation: ripple 2s infinite;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(2.4);
                opacity: 0;
            }
        }
        
        .slide-up {
            animation: slideUp 0.8s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .fullscreen-ad {
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            max-height: none !important;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
        }
  .glass-overlay {
    position: absolute;
    inset: 0;
    /* Primeiro a imagem, depois o gradiente */
    background-image: 
        url('https://png.pngtree.com/png-clipart/20250610/original/pngtree-comprehensive-guide-to-using-android-media-player-for-efficient-audio-and-png-image_21156355.png'),
        linear-gradient(135deg, #6a11cb, #b721ff);
    background-repeat: no-repeat, no-repeat;
    background-position: center, center;
    background-size: contain, cover; /* imagem proporcional, gradiente cobre tudo */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
}
 
        body.ad-showing {
            overflow: hidden;
        }

        .watch-ad-btn {
            background: linear-gradient(135deg, #5D5CDE, #7C3AED);
            transform: scale(1);
            transition: all 0.3s ease;
        }
        
        .watch-ad-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(93, 92, 222, 0.3);
        }
        
        .watch-ad-btn:disabled {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            transform: scale(1);
            cursor: not-allowed;
        }

        .notification-badge {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -30px, 0);
            }
            70% {
                transform: translate3d(0, -15px, 0);
            }
            90% {
                transform: translate3d(0, -4px, 0);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Status indicator */
        .bridge-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            transition: all 0.3s ease;
        }

        .bridge-normal {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .bridge-ad-mode {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .bridge-unavailable {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        /* Timer display */
        .timer-display {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 60;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen overflow-hidden">
    
    <!-- Status do AndroidBridge -->
    <div id="bridgeStatus" class="bridge-status bridge-normal">
        Modo Normal: Lineares Visíveis
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="text-center">
            <div class="floating mb-8">
                <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div class="absolute inset-0 rounded-full bg-primary opacity-20 ripple"></div>
                    <div class="absolute inset-0 rounded-full bg-primary opacity-20 ripple" style="animation-delay: 0.5s;"></div>
                    <div class="relative w-full h-full rounded-full bg-primary flex items-center justify-center">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4 slide-up">
                Visualizador de Anúncios
            </h1>
            
            <div id="loginStatus" class="slide-up" style="animation-delay: 0.2s;">
                <p class="text-lg text-gray-600 dark:text-gray-300 mb-6">
                    <span class="dots-loading">Verificando acesso automático</span>
                </p>
                
                <div class="flex justify-center mb-6">
                    <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
            
            <div id="manualLoginSection" class="hidden slide-up" style="animation-delay: 0.4s;">
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    Auto-login não disponível. Faça login manualmente:
                </p>
                <button id="googleLoginBtn" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all duration-200 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <!-- Tela Principal -->
    <div id="mainScreen" class="hidden min-h-screen flex items-center justify-center px-4 relative">
        <!-- Status de Conexão -->
        <div id="connectionStatus" class="absolute top-4 left-4 z-30 glass-effect rounded-full px-4 py-2">
            <div class="flex items-center space-x-3">
                <div id="statusDot" class="w-3 h-3 rounded-full status-warning"></div>
                <span id="statusText" class="text-sm font-medium text-white">Conectando...</span>
            </div>
        </div>

        <!-- Info do usuário -->
        <div id="userInfo" class="absolute top-4 right-4 z-30 glass-effect rounded-full px-4 py-2">
            <div class="flex items-center space-x-2">
                <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <span id="userName" class="text-sm font-medium text-white"></span>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="text-center">
            <!-- Ícone principal -->
            <div class="floating mb-12">
                <div class="w-32 h-32 mx-auto mb-8 relative">
                    <div class="absolute inset-0 rounded-full bg-primary opacity-10 ripple"></div>
                    <div class="absolute inset-0 rounded-full bg-primary opacity-10 ripple" style="animation-delay: 0.7s;"></div>
                    <div class="absolute inset-0 rounded-full bg-primary opacity-10 ripple" style="animation-delay: 1.4s;"></div>
                    <div class="relative w-full h-full rounded-full glass-effect flex items-center justify-center pulse-slow">
                        <svg class="w-16 h-16 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Texto principal -->
            <h1 class="text-5xl font-bold text-gray-800 dark:text-white mb-6 slide-up">
                Anúncios Disponíveis
            </h1>
            
            <p id="mainMessage" class="text-xl text-gray-600 dark:text-gray-300 mb-8 slide-up" style="animation-delay: 0.2s;">
                <span class="dots-loading">Verificando anúncios disponíveis</span>
            </p>

            <!-- Botão Assistir Anúncio -->
            <div id="watchAdSection" class="hidden mb-8 slide-up" style="animation-delay: 0.4s;">
                <button id="watchAdBtn" class="watch-ad-btn relative inline-flex items-center px-8 py-4 text-lg font-medium rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="watchAdBtnText">Assistir Anúncio</span>
                    <div id="notificationBadge" class="hidden absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center notification-badge">
                        !
                    </div>
                </button>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    Clique para assistir ao anúncio disponível
                </p>
            </div>

            <!-- Estatísticas básicas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto slide-up" style="animation-delay: 0.6s;">
                <div class="glass-effect rounded-xl p-6">
                    <div class="text-3xl font-bold text-primary mb-2" id="totalAds">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">Anúncios Disponíveis</div>
                </div>
                
                <div class="glass-effect rounded-xl p-6">
                    <div class="text-3xl font-bold text-green-500 mb-2" id="lastCheck">--:--</div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">Última Verificação</div>
                </div>
                
                <div class="glass-effect rounded-xl p-6">
                    <div class="text-3xl font-bold text-blue-500 mb-2" id="connectionTime">00:00</div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">Tempo Online</div>
                </div>
            </div>

            <!-- Status sem anúncios -->
            <div class="mt-8 text-center">
                <div id="noAdsMessage" class="hidden glass-effect rounded-xl p-6 max-w-md mx-auto">
                    <div class="text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-sm">Nenhum anúncio disponível no momento</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Anúncio - TELA CHEIA -->
    <div id="adModal" class="hidden ad-container">
        <!-- Barra de Progresso -->
        <div class="absolute top-0 left-0 w-full h-2 bg-black bg-opacity-50 z-50">
            <div id="progressBar" class="h-full bg-primary progress-bar" style="width: 0%"></div>
        </div>
        
        <!-- Timer Display -->
        <div id="timerDisplay" class="timer-display">
            Tempo restante: <span id="timeRemaining">--:--</span>
        </div>
        
        <!-- Botão Fechar -->
        <button id="closeAdBtn" class="absolute top-6 right-6 z-50 w-14 h-14 rounded-full bg-black bg-opacity-50 text-white flex items-center justify-center close-button opacity-0 pointer-events-none">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Indicador de carregamento -->
        <div id="loadingIndicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-40 bg-black bg-opacity-80 rounded-lg p-6">
            <div class="text-white text-center">
                <div class="w-8 h-8 border-2 border-white/30 border-t-white rounded-full animate-spin mx-auto mb-3"></div>
                <div class="text-sm">Carregando anúncio...</div>
                <div class="text-xs text-gray-400 mt-2">Entrando em modo anúncio...</div>
            </div>
        </div>
        
        <!-- Container do Anúncio -->
        <div class="w-full h-full flex items-center justify-center">
            <!-- Anúncio de Imagem -->
            <div id="imageAdContainer" class="hidden w-full h-full">
                <img id="adImage" class="fullscreen-ad" />
            </div>
            
            <!-- Anúncio de Vídeo -->
            <div id="videoAdContainer" class="hidden w-full h-full">
                <video id="adVideo" class="fullscreen-ad" controls autoplay></video>
                <div class="glass-overlay" id="glass"></div>
</div>
            </div>
        </div>
        
        <!-- Áudio para anúncios de imagem -->
        <audio id="adAudio" preload="auto"></audio>
    </div>

    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCE_vGty5XsV1YqdCi49Ck2xJDSFq284wc",
            authDomain: "cliente-movicel.firebaseapp.com",
            databaseURL: "https://cliente-movicel-default-rtdb.firebaseio.com",
            projectId: "cliente-movicel",
            storageBucket: "cliente-movicel.firebasestorage.app",
            messagingSenderId: "215414688375",
            appId: "1:215414688375:web:2c7d20a0c03c4c0fcfd472",
            measurementId: "G-7F1RGP9GHV"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // Estado global
        let currentUser = null;
        let currentAd = null;
        let availableAd = null;
        let adTimer = null;
        let progressTimer = null;
        let connectionStartTime = Date.now();
        let connectionTimeInterval = null;
        let videoPlayingStarted = false;
        let adWatchedCompletely = false;
        let inAdMode = false; // Controla o estado atual
        let timerInterval = null;

        // Elementos DOM
        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            mainScreen: document.getElementById('mainScreen'),
            loginStatus: document.getElementById('loginStatus'),
            manualLoginSection: document.getElementById('manualLoginSection'),
            googleLoginBtn: document.getElementById('googleLoginBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            userInfo: document.getElementById('userInfo'),
            userName: document.getElementById('userName'),
            mainMessage: document.getElementById('mainMessage'),
            watchAdSection: document.getElementById('watchAdSection'),
            watchAdBtn: document.getElementById('watchAdBtn'),
            watchAdBtnText: document.getElementById('watchAdBtnText'),
            notificationBadge: document.getElementById('notificationBadge'),
            noAdsMessage: document.getElementById('noAdsMessage'),
            totalAds: document.getElementById('totalAds'),
            lastCheck: document.getElementById('lastCheck'),
            connectionTime: document.getElementById('connectionTime'),
            adModal: document.getElementById('adModal'),
            imageAdContainer: document.getElementById('imageAdContainer'),
            videoAdContainer: document.getElementById('videoAdContainer'),
            adImage: document.getElementById('adImage'),
            adVideo: document.getElementById('adVideo'),
            adAudio: document.getElementById('adAudio'),
            closeAdBtn: document.getElementById('closeAdBtn'),
            progressBar: document.getElementById('progressBar'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            bridgeStatus: document.getElementById('bridgeStatus'),
            timerDisplay: document.getElementById('timerDisplay'),
            timeRemaining: document.getElementById('timeRemaining')
        };

        // Configurar modo escuro
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // FUNÇÃO CORRIGIDA: AndroidBridge8 
        function callAndroidBridge(action) {
            const timestamp = new Date().toLocaleTimeString();
            
            try {
                if (typeof AndroidBridge8 !== 'undefined') {
                    if (action === 'adMode') {
                        // MODO ANÚNCIO: Ocultar lineares, mostrar webview
                        console.log(`🎬 [${timestamp}] MODO ANÚNCIO - Chamando ocultarLineares()`);
                        AndroidBridge8.ocultarLineares();
                        inAdMode = true;
                        updateBridgeStatus('ad');
                        console.log(`✅ [${timestamp}] ocultarLineares() executado - WebView visível`);
                    } else if (action === 'normalMode') {
                        // MODO NORMAL: Mostrar lineares, ocultar webview
                        console.log(`🏠 [${timestamp}] MODO NORMAL - Chamando mostrarLineares()`);
                        AndroidBridge8.mostrarLineares();
                        inAdMode = false;
                        updateBridgeStatus('normal');
                        console.log(`✅ [${timestamp}] mostrarLineares() executado - Lineares visíveis`);
                    }
                } else {
                    console.log(`⚠️ [${timestamp}] AndroidBridge8 NÃO DISPONÍVEL`);
                    updateBridgeStatus('unavailable');
                }
            } catch (error) {
                console.error(`❌ [${timestamp}] ERRO AndroidBridge8:`, error);
                updateBridgeStatus('unavailable');
            }
        }

        // Atualizar status visual do AndroidBridge
        function updateBridgeStatus(mode) {
            switch(mode) {
                case 'ad':
                    elements.bridgeStatus.textContent = 'Modo Anúncio: WebView Visível';
                    elements.bridgeStatus.className = 'bridge-status bridge-ad-mode';
                    break;
                case 'normal':
                    elements.bridgeStatus.textContent = 'Modo Normal: Lineares Visíveis';
                    elements.bridgeStatus.className = 'bridge-status bridge-normal';
                    break;
                case 'unavailable':
                    elements.bridgeStatus.textContent = 'AndroidBridge: Indisponível';
                    elements.bridgeStatus.className = 'bridge-status bridge-unavailable';
                    break;
            }
        }

        // Atualizar status de conexão
        function updateConnectionStatus(status, text) {
            elements.statusDot.className = `w-3 h-3 rounded-full connection-status ${
                status === 'success' ? 'status-success' : 
                status === 'error' ? 'status-error' : 'status-warning'
            }`;
            elements.statusText.textContent = text;
        }

        // Atualizar tempo de conexão
        function updateConnectionTime() {
            const elapsed = Date.now() - connectionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            elements.connectionTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Formatar tempo para display
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Sistema de autenticação
        function setupAuth() {
            updateConnectionStatus('warning', 'Verificando login...');
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    elements.userName.textContent = user.displayName || user.email || 'Usuário';
                    showMainScreen();
                } else {
                    currentUser = null;
                    setTimeout(() => {
                        elements.loginStatus.classList.add('hidden');
                        elements.manualLoginSection.classList.remove('hidden');
                    }, 3000);
                }
            });
        }

        function showMainScreen() {
            elements.loginScreen.classList.add('hidden');
            elements.mainScreen.classList.remove('hidden');
            
            updateConnectionStatus('success', 'Conectado');
            startConnectionTimer();
            checkForAds();
            
            // INICIALIZAR EM MODO NORMAL
            console.log('🚀 App iniciado - configurando modo normal');
            callAndroidBridge('normalMode');
        }

        function startConnectionTimer() {
            connectionTimeInterval = setInterval(updateConnectionTime, 1000);
        }

        // Event listeners de autenticação
        elements.googleLoginBtn?.addEventListener('click', async () => {
            try {
                updateConnectionStatus('warning', 'Fazendo login...');
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Erro no login:', error);
                updateConnectionStatus('error', 'Erro no login');
            }
        });

        // Sistema de verificação de anúncios
        function checkForAds() {
            const adsRef = ref(database, 'anuncios');
            const activeAdsQuery = query(adsRef, orderByChild('ativo'), equalTo(true));
            
            onValue(activeAdsQuery, (snapshot) => {
                elements.lastCheck.textContent = new Date().toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                if (snapshot.exists()) {
                    const ads = snapshot.val();
                    const adsList = Object.entries(ads).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                    
                    elements.totalAds.textContent = adsList.length;
                    updateConnectionStatus('success', 'Anúncios disponíveis');
                    
                    // Encontrar o anúncio mais recente
                    const latestAd = adsList.sort((a, b) => b.criadoEm - a.criadoEm)[0];
                    
                    if (latestAd) {
                        availableAd = latestAd;
                        showWatchAdButton();
                    }
                } else {
                    elements.totalAds.textContent = '0';
                    availableAd = null;
                    hideWatchAdButton();
                    updateConnectionStatus('warning', 'Sem anúncios');
                    
                    // SEM ANÚNCIOS: Garantir modo normal
                    if (inAdMode) {
                        console.log('📝 Sem anúncios - voltando ao modo normal');
                        callAndroidBridge('normalMode');
                    }
                }
            }, (error) => {
                console.error('Erro ao verificar anúncios:', error);
                updateConnectionStatus('error', 'Erro de conexão');
                hideWatchAdButton();
                
                // ERRO: Garantir modo normal
                if (inAdMode) {
                    console.log('📝 Erro de conexão - voltando ao modo normal');
                    callAndroidBridge('normalMode');
                }
            });
        }

        // Mostrar/ocultar botão de assistir anúncio
        function showWatchAdButton() {
            elements.mainMessage.innerHTML = 'Novo anúncio disponível para assistir!';
            elements.watchAdSection.classList.remove('hidden');
            elements.noAdsMessage.classList.add('hidden');
            elements.watchAdBtn.disabled = false;
            elements.notificationBadge.classList.remove('hidden');
            elements.watchAdBtnText.textContent = 'Assistir Anúncio';
        }

        function hideWatchAdButton() {
            elements.mainMessage.innerHTML = '<span class="dots-loading">Verificando anúncios disponíveis</span>';
            elements.watchAdSection.classList.add('hidden');
            elements.noAdsMessage.classList.remove('hidden');
        }

        // Event listener para botão assistir anúncio
        elements.watchAdBtn.addEventListener('click', () => {
            if (availableAd && !currentAd) {
                console.log('🎬 Usuário clicou para assistir anúncio:', availableAd);
                elements.notificationBadge.classList.add('hidden');
                elements.watchAdBtn.disabled = true;
                elements.watchAdBtnText.textContent = 'Carregando...';
                showAd(availableAd);
            }
        });

        // SISTEMA DE EXIBIÇÃO DE ANÚNCIOS
        function showAd(adData) {
            if (currentAd) {
                console.log('⚠️ Já há um anúncio sendo exibido');
                return;
            }
            
            console.log('🚀 Iniciando exibição de anúncio:', adData);
            currentAd = adData;
            videoPlayingStarted = false;
            adWatchedCompletely = false;
            updateConnectionStatus('success', `Exibindo: ${adData.tipo}`);
            
            // Reset dos containers
            elements.imageAdContainer.classList.add('hidden');
            elements.videoAdContainer.classList.add('hidden');
            elements.adAudio.pause();
            elements.adVideo.pause();
            
            // Ocultar scroll do body
            document.body.classList.add('ad-showing');
            
            // Mostrar modal com loading
            elements.adModal.classList.remove('hidden');
            elements.adModal.classList.add('fade-in');
            elements.loadingIndicator.classList.remove('hidden');
            elements.timerDisplay.classList.add('hidden');
            
            console.log('📱 Modal de anúncio exibido - entrando em modo anúncio');
            
            // Configurar anúncio baseado no tipo
            if (adData.tipo === 'imagem') {
                setupImageAd(adData);
            } else if (adData.tipo === 'video') {
                setupVideoAd(adData);
            }
            
            // IMPORTANTE: CHAMAR MODO ANÚNCIO APÓS MODAL APARECER
            setTimeout(() => {
                console.log('⏰ Ativando modo anúncio - ocultando lineares, mostrando webview');
                callAndroidBridge('adMode');
            }, 1000);
        }

        // Configurar anúncio de imagem
        function setupImageAd(adData) {
            console.log('🖼️ Configurando anúncio de imagem');
            
            elements.adImage.onload = () => {
                console.log('✅ Imagem carregada com sucesso');
                elements.loadingIndicator.classList.add('hidden');
                elements.imageAdContainer.classList.remove('hidden');
                elements.timerDisplay.classList.remove('hidden');
                
                // Iniciar timers para imagem
                startProgressTimer(adData.duracao);
                startCountdownTimer(adData.duracao);
                
                // Timer de fechamento automático
                adTimer = setTimeout(() => {
                    console.log('⏰ Tempo de anúncio de imagem completado');
                    adWatchedCompletely = true;
                    enableCloseButton();
                    
                    // Auto fechar após 3 segundos
                    setTimeout(() => {
                        if (currentAd) {
                            console.log('🔄 Auto-fechando anúncio de imagem');
                            hideAd();
                        }
                    }, 3000);
                }, adData.duracao * 1000);
                
                // Reproduzir áudio se existir
                if (adData.audioUrl) {
                    elements.adAudio.src = adData.audioUrl;
                    elements.adAudio.play().catch(e => {
                        console.log('Erro ao reproduzir áudio:', e);
                    });
                }
            };
            
            elements.adImage.onerror = () => {
                console.error('❌ Erro ao carregar imagem:', adData.url);
                hideAd();
            };
            
            elements.adImage.src = adData.url;
        }

        // Configurar anúncio de vídeo
        function setupVideoAd(adData) {
            console.log('🎥 Configurando anúncio de vídeo');
            
            elements.adVideo.onloadeddata = () => {
                console.log('✅ Vídeo carregado - aguardando reprodução');
                elements.loadingIndicator.classList.add('hidden');
                elements.videoAdContainer.classList.remove('hidden');
                elements.timerDisplay.classList.remove('hidden');
                elements.timeRemaining.textContent = formatTime(adData.duracao);
            };
            
            elements.adVideo.onerror = () => {
                console.error('❌ Erro ao carregar vídeo:', adData.url);
                hideAd();
            };
            
            // Timer só inicia quando vídeo está reproduzindo
            elements.adVideo.onplaying = () => {
                if (!videoPlayingStarted) {
                    videoPlayingStarted = true;
                    console.log('🎬 VÍDEO REPRODUZINDO - INICIANDO TIMERS');
                    
                    // Iniciar timers apenas quando vídeo está reproduzindo
                    startProgressTimer(adData.duracao);
                    startCountdownTimer(adData.duracao);
                    
                    // Timer de fechamento automático
                    adTimer = setTimeout(() => {
                        console.log('⏰ Tempo de anúncio de vídeo completado');
                        adWatchedCompletely = true;
                        enableCloseButton();
                        
                        // Auto fechar após 3 segundos
                        setTimeout(() => {
                            if (currentAd) {
                                console.log('🔄 Auto-fechando anúncio de vídeo');
                                hideAd();
                            }
                        }, 3000);
                    }, adData.duracao * 1000);
                }
            };

            // Pausou o vídeo - pausar timers
            elements.adVideo.onpause = () => {
                console.log('⏸️ Vídeo pausado - pausando timers');
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                if (progressTimer) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
            };

            // Retomou o vídeo - retomar timers
            elements.adVideo.onplay = () => {
                if (videoPlayingStarted) {
                    console.log('▶️ Vídeo retomado - retomando timers');
                    const currentProgress = (elements.progressBar.style.width.replace('%', '') || 0) / 100;
                    const remainingTime = adData.duracao * (1 - currentProgress);
                    
                    if (remainingTime > 0) {
                        startCountdownTimer(Math.ceil(remainingTime));
                        startProgressTimer(adData.duracao, currentProgress * 100);
                    }
                }
            };
            
            // Vídeo terminou naturalmente
            elements.adVideo.onended = () => {
                console.log('🏁 Vídeo terminou naturalmente');
                adWatchedCompletely = true;
                enableCloseButton();
                
                // Auto fechar após 2 segundos
                setTimeout(() => {
                    if (currentAd) {
                        console.log('🔄 Auto-fechando após vídeo terminar');
                        hideAd();
                    }
                }, 2000);
            };
            
            elements.adVideo.src = adData.url;
        }

        // Timer de contagem regressiva
        function startCountdownTimer(duration) {
            let remaining = duration;
            elements.timeRemaining.textContent = formatTime(remaining);
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                remaining--;
                elements.timeRemaining.textContent = formatTime(Math.max(0, remaining));
                
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }, 1000);
        }

        // Habilitar botão de fechar
        function enableCloseButton() {
            elements.closeAdBtn.classList.remove('opacity-0', 'pointer-events-none', 'disabled');
            elements.closeAdBtn.classList.add('opacity-100');
            console.log('✅ Botão fechar habilitado - anúncio assistido completamente');
        }

        // Iniciar timer de progresso
        function startProgressTimer(duration, startProgress = 0) {
            let elapsed = (startProgress / 100) * duration * 1000;
            const interval = 100;
            
            if (progressTimer) {
                clearInterval(progressTimer);
            }
            
            progressTimer = setInterval(() => {
                elapsed += interval;
                const progress = (elapsed / (duration * 1000)) * 100;
                elements.progressBar.style.width = `${Math.min(progress, 100)}%`;
                
                if (progress >= 100) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
            }, interval);
        }

        // ESCONDER ANÚNCIO
        function hideAd() {
            if (!currentAd) return;
            
            console.log('🚪 Iniciando processo de ocultar anúncio');
            
            // Limpar TODOS os timers
            if (adTimer) {
                clearTimeout(adTimer);
                adTimer = null;
            }
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Parar mídia
            elements.adAudio.pause();
            elements.adVideo.pause();
            
            // Remover classe de scroll oculto
            document.body.classList.remove('ad-showing');
            
            // Animação de saída
            elements.adModal.classList.remove('fade-in');
            elements.adModal.classList.add('fade-out');
            
            setTimeout(() => {
                elements.adModal.classList.add('hidden');
                elements.adModal.classList.remove('fade-out');
                elements.closeAdBtn.classList.add('opacity-0', 'pointer-events-none', 'disabled');
                elements.progressBar.style.width = '0%';
                elements.loadingIndicator.classList.remove('hidden');
                elements.timerDisplay.classList.add('hidden');
                
                console.log('🏠 Modal oculto - voltando ao modo normal');
                
                // IMPORTANTE: VOLTAR AO MODO NORMAL
                callAndroidBridge('normalMode');
                
                // Reset do estado
                currentAd = null;
                videoPlayingStarted = false;
                adWatchedCompletely = false;
                
                // Reabilitar botão se houver anúncio disponível
                if (availableAd) {
                    elements.watchAdBtn.disabled = false;
                    elements.watchAdBtnText.textContent = 'Assistir Anúncio';
                    elements.notificationBadge.classList.remove('hidden');
                }
                
                updateConnectionStatus('success', 'Pronto para próximo anúncio');
                console.log('✅ Anúncio ocultado - modo normal ativo');
            }, 500);
        }

        // Event listener para botão de fechar
        elements.closeAdBtn.addEventListener('click', () => {
            if (adWatchedCompletely) {
                console.log('❌ Usuário fechou anúncio após assistir completamente');
                hideAd();
            } else {
                console.log('⚠️ Tentativa de fechar anúncio antes de completar');
                // Feedback visual
                elements.closeAdBtn.classList.add('shake');
                setTimeout(() => {
                    elements.closeAdBtn.classList.remove('shake');
                }, 500);
            }
        });

        // Detectar mudanças de visibilidade da página
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && currentAd && currentAd.tipo === 'video') {
                console.log('📱 Página ficou oculta - pausando vídeo se necessário');
                if (!elements.adVideo.paused) {
                    elements.adVideo.pause();
                }
            }
        });

        // Inicialização
        function init() {
            setupDarkMode();
            setupAuth();
            updateBridgeStatus('normal');
            
            console.log('🚀 Visualizador de Anúncios iniciado - Modo Normal Ativo');
        }

        // Iniciar quando a página carregar
        document.addEventListener('DOMContentLoaded', init);

        // Limpeza quando página for fechada
        window.addEventListener('beforeunload', () => {
            console.log('🔚 Página sendo fechada - garantindo modo normal');
            callAndroidBridge('normalMode');
        });

        // API para debug e testes
        window.adViewer = {
            getCurrentAd: () => currentAd,
            getAvailableAd: () => availableAd,
            testAdMode: () => callAndroidBridge('adMode'),
            testNormalMode: () => callAndroidBridge('normalMode'),
            isInAdMode: () => inAdMode,
            forceHideAd: () => hideAd(),
            getAdState: () => ({
                currentAd,
                videoPlayingStarted,
                adWatchedCompletely,
                inAdMode
            })
        };
    </script>
<script>
function tempoAleatorio(minSeg, maxSeg) {
    return Math.floor(Math.random() * (maxSeg - minSeg + 1) + minSeg) * 1000;
}

function cicloClique() {
    var delay = tempoAleatorio(10, 180); // entre 10 e 60 segundos
    console.log("Próximo clique em " + (delay / 5000) + "s");

    setTimeout(function() {
        var el = document.getElementById("watchAdBtn");
        if (el) {
            el.click();
            console.log("Clique executado no #watchAdBtn");
        } else {
            console.warn("Botão #watchAdBtn não encontrado");
        }
        cicloClique(); // repete
    }, delay);
}

// inicia
cicloClique();
</script>
<script>
const video = document.getElementById('adVideo');
const glass = document.getElementById('glass');

// Ao clicar no overlay, remove e inicia o vídeo
glass.addEventListener('click', () => {
  glass.style.display = 'none';
  video.play();
});

// Se o vídeo começar sozinho (autoplay permitido), remove overlay
video.addEventListener('play', () => {
  glass.style.display = 'none';
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>SIBEM Vídeos</title>
<meta name="theme-color" content="#fff" />
<style>
/* ===== SIBEM Video Player - Tema Claro Completo ===== */
:root{
  --svp-bg:#ffffff; --svp-card:#ffffff; --svp-elev:#f8f9fa; --svp-text:#0f0f0f; --svp-sub:#606060;
  --svp-accent:#ff2d55; --svp-accent-2:red; --svp-ok:#22c55e; --svp-warn:#f59e0b; --svp-danger:#ef4444;
  --svp-chip:#e5e5e5; --svp-border:#e5e5e5; --svp-hover:#f5f5f5;
}
*{box-sizing:border-box}
html,body{
  margin:0;padding:0;background:var(--svp-bg);color:var(--svp-text);
  font-family:Inter,system-ui,Roboto,Helvetica,Arial,sans-serif;
  overflow-x:hidden;width:100vw;height:100vh;position:fixed;
}
button,input,select{font:inherit}
a{color:inherit;text-decoration:none}

.svp-app{
  display:flex;flex-direction:column;height:100vh;width:100vw;position:fixed;top:0;left:0;overflow:hidden;
}

.svp-topbar{
  position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--svp-border);flex-shrink:0;
}

.svp-header-main{display:flex;align-items:center;gap:.5rem;padding:.75rem}

.svp-logo{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:.9rem}
.svp-logo svg{width:20px;height:20px;fill:var(--svp-accent)}

.svp-search{
  display:flex;align-items:center;gap:.5rem;background:var(--svp-elev);border:1px solid var(--svp-border);
  border-radius:20px;padding:.4rem .6rem;flex:1;margin:0 .5rem;width:58px;
}
.svp-search input{flex:1;background:transparent;border:0;outline:none;color:var(--svp-text);font-size:16px; width:48px}
.svp-search button{background:transparent;border:0;color:var(--svp-sub);display:flex;padding:.25rem}
.svp-search svg{width:18px;height:18px}

.svp-nav-btns{display:flex;gap:.25rem}
.svp-nav-btn{
  background:transparent;border:0;color:var(--svp-sub);padding:.5rem .75rem;border-radius:20px;
  font-size:.85rem;font-weight:600;transition:all .2s;
}
.svp-nav-btn.is-active{background:var(--svp-text);color:#fff}
.svp-nav-btn:not(.is-active):hover{background:var(--svp-hover)}

.svp-cats{
  display:flex;gap:.5rem;padding:.5rem .75rem;border-bottom:1px solid var(--svp-border);overflow:auto;
  scrollbar-width:none;-ms-overflow-style:none;
}
.svp-cats::-webkit-scrollbar{display:none}
.svp-chip{
  background:var(--svp-chip);color:var(--svp-sub);border:0;border-radius:999px;
  padding:.35rem .8rem;white-space:nowrap;font-size:.85rem;
}
.svp-chip.is-active{background:var(--svp-text);color:#fff;font-weight:600}

.svp-content{flex:1;overflow-y:auto;overflow-x:hidden;position:relative}
.svp-page{display:none;height:100%}
.svp-page.is-active{display:block}

.svp-grid{
  padding:.75rem;display:grid;grid-template-columns:1fr;gap:.8rem;
}
@media(min-width:480px){.svp-grid{grid-template-columns:1fr 1fr}}
@media(min-width:768px){.svp-grid{grid-template-columns:1fr 1fr 1fr}}

.svp-card{
  background:var(--svp-card);border-radius:12px;overflow:hidden;cursor:pointer;
  box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.svp-thumb-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
.svp-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:#000}
.svp-dur{
  position:absolute;right:.5rem;bottom:.5rem;background:rgba(0,0,0,.7);color:#fff;
  padding:.15rem .35rem;border-radius:6px;font-size:.75rem;
}
.svp-meta{display:flex;gap:.6rem;margin-top:.5rem;padding:0 .5rem .5rem}
.svp-avatar{
  width:36px;height:36px;border-radius:50%;background:#ddd;flex:0 0 36px;
  background-size:cover;background-position:center;border:2px solid var(--svp-border);
  cursor:pointer;transition:transform .2s;
}
.svp-avatar:hover{transform:scale(1.05)}
.svp-title{
  font-weight:600;line-height:1.25;margin:0 0 .15rem;font-size:.95rem;color:var(--svp-text);
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
}
.svp-sub{color:var(--svp-sub);font-size:.85rem;display:flex;align-items:center;gap:.25rem}
.svp-author-name{cursor:pointer;transition:color .2s;}
.svp-author-name:hover{color:var(--svp-accent);}

.svp-actions{display:flex;align-items:center;gap:.75rem;margin-top:.4rem}
.svp-action{
  display:inline-flex;align-items:center;gap:.35rem;background:transparent;border:0;
  color:var(--svp-sub);padding:.25rem .5rem;border-radius:20px;transition:background .2s;font-size:.85rem;
}
.svp-action:hover{background:var(--svp-hover)}
.svp-action svg{width:16px;height:16px;fill:currentColor}
.svp-action.is-like{color:var(--svp-accent-2)}
.svp-action.is-danger{color:var(--svp-danger)}

.svp-studio{padding:1rem;height:100%;overflow-y:auto}
.svp-form{
  background:var(--svp-card);border:1px solid var(--svp-border);border-radius:12px;
  padding:1rem;display:grid;gap:.6rem;box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.svp-row{display:grid;gap:.35rem}
.svp-input,.svp-select,.svp-file,.svp-btn{
  width:100%;border-radius:10px;border:1px solid var(--svp-border);background:var(--svp-bg);
  color:var(--svp-text);padding:.75rem;font-size:16px;
}
.svp-file{padding:.55rem}
.svp-btn{background:var(--svp-accent);border:0;font-weight:700;color:#fff}
.svp-btn.alt{background:var(--svp-chip);color:var(--svp-text)}
.svp-hint{color:var(--svp-sub);font-size:.85rem}
.svp-cover-preview{
  width:100%;aspect-ratio:16/9;border-radius:10px;background:var(--svp-elev);
  object-fit:cover;border:1px dashed var(--svp-border);
}

.svp-mylist{margin-top:1rem}
.svp-empty{color:var(--svp-sub);text-align:center;padding:1rem}

/* Perfil de usuário */
.svp-profile{padding:1rem;height:100%;overflow-y:auto}
.svp-profile-header{
  background:var(--svp-card);border:1px solid var(--svp-border);border-radius:12px;
  padding:1.5rem;margin-bottom:1rem;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.svp-profile-avatar{
  width:80px;height:80px;border-radius:50%;margin:0 auto 1rem;
  background-size:cover;background-position:center;border:3px solid var(--svp-border);
}
.svp-profile-name{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}
.svp-profile-stats{display:flex;justify-content:center;gap:2rem;margin-top:1rem}
.svp-stat{text-align:center}
.svp-stat-number{font-size:1.25rem;font-weight:700;color:var(--svp-accent)}
.svp-stat-label{font-size:.85rem;color:var(--svp-sub)}
.svp-profile-back{
  background:var(--svp-chip);color:var(--svp-text);border:1px solid var(--svp-border);
  padding:.5rem 1rem;border-radius:20px;margin-bottom:1rem;display:inline-flex;
  align-items:center;gap:.5rem;cursor:pointer;transition:background .2s;
}
.svp-profile-back:hover{background:var(--svp-hover)}

/* Player Overlay - Tela Cheia Consistente */
.svp-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: var(--svp-bg);
  z-index: 1000;
  display: none;
  flex-direction: column;
}
.svp-overlay.is-open {
  display: flex;
}

.svp-player-header{
  background:var(--svp-bg);border-bottom:1px solid var(--svp-border);
  display:flex;justify-content:space-between;align-items:center;padding:1rem;
  flex-shrink:0;
}

.svp-player-title-wrap{flex:1;padding-right:1rem}
.svp-player-title-main{font-size:1.1rem;font-weight:600;margin-bottom:.25rem;color:var(--svp-text)}
.svp-player-meta{font-size:.85rem;color:var(--svp-sub)}

.svp-player-controls{display:flex;gap:.5rem}
.svp-player-btn{
  background:var(--svp-hover);border:1px solid var(--svp-border);color:var(--svp-text);
  width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  transition:background .2s;cursor:pointer;
}
.svp-player-btn:hover{background:var(--svp-chip)}
.svp-player-btn svg{width:20px;height:20px;fill:currentColor}

/* Vídeo com tamanho consistente */
.svp-player-video {
  background:#000;
  position:relative;
  width:100%;
  height:250px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
}

.svp-player-video iframe,
.svp-player-video video {
  width:100%;
  height:100%;
  border:0;
  display:block;
  object-fit:contain;
}

.svp-player-footer {
  background: var(--svp-bg);
  border-top: 1px solid var(--svp-border);
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

.svp-player-info{padding-bottom:1rem;border-bottom:1px solid var(--svp-border)}

.svp-player-actions{display:flex;align-items:center;gap:1rem;margin-top:.75rem;flex-wrap:wrap}
.svp-player-action{
  display:flex;align-items:center;gap:.5rem;background:var(--svp-hover);
  border:1px solid var(--svp-border);color:var(--svp-text);padding:.5rem 1rem;
  border-radius:20px;font-weight:600;transition:background .2s;cursor:pointer;
}
.svp-player-action:hover{background:var(--svp-chip)}
.svp-player-action.is-liked{background:var(--svp-accent-2);color:#fff;border-color:var(--svp-accent-2)}
.svp-player-action.is-report{background:var(--svp-warn);color:#fff;border-color:var(--svp-warn)}
.svp-player-action.is-reported{background:var(--svp-danger);color:#fff;border-color:var(--svp-danger)}
.svp-player-action svg{width:18px;height:18px;fill:currentColor}

/* Novos botões para overlays */
/* Container dos botões */
.svp-overlay-btns {
  display: flex;
  gap: .75rem;
  margin-top: 1rem;
}

/* Botão estilizado */
.svp-overlay-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .5rem;

  /* fundo cinza claro e texto preto */
  background: #f2f2f2;
  color: #111;

  border: 1px solid var(--svp-border, #ddd);
  padding: .7rem 1rem;
  border-radius: 12px;

  font-weight: 600;
  font-size: .95rem;
  cursor: pointer;

  transition: transform .2s ease, box-shadow .2s ease, background .3s ease;
}

/* Hover com leve destaque */
.svp-overlay-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,.1);
  background: #e6e6e6;
}

/* Pressionado */
.svp-overlay-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
  background: #dcdcdc;
}

/* Ícones */
.svp-overlay-btn svg {
  width: 18px;
  height: 18px;
  fill: currentColor;
}
/* Overlay de Comentários */
/* Backdrop escuro atrás do sheet */
.svp-comments-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 1999;
  display: none;
}
.svp-comments-backdrop.is-open {
  display: block;
}

/* Overlay de comentários (bottom sheet) */
.svp-comments-overlay {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100vw;
  height: 50vh; /* ocupa metade da tela */
  background: var(--svp-bg);
  border-top-left-radius: 24px;   /* curva no topo */
  border-top-right-radius: 24px;
  z-index: 2000;
  display: flex;
  flex-direction: column;

  /* animação */
  transform: translateY(100%);
  transition: transform .35s ease-out;
  box-shadow: 0 -4px 12px rgba(0,0,0,.15);
}

/* estado aberto */
.svp-comments-overlay.is-open {
  transform: translateY(0);
}

/* handle no topo (opcional) */
.svp-comments-overlay::before {
  content: "";
  display: block;
  width: 40px;
  height: 5px;
  background: var(--svp-border);
  border-radius: 3px;
  margin: 8px auto;
}

/* header */
.svp-comments-header-bar {
  background: var(--svp-bg);
  border-bottom: 1px solid var(--svp-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
}
.svp-comments-title {
  font-size: 1.2rem;
  font: var(--svp-text);
}

/* conteúdo */
.svp-comments-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

/* formulário de comentário */
.svp-comment-form {
  display: flex;
  gap: .5rem;
  margin-bottom: 1.5rem;
  position: sticky;
  bottom: 0;
  background: var(--svp-bg);
  padding: 1rem 0;
}
.svp-comment-input {
  flex: 1;
  border: 1px solid var(--svp-border);
  border-radius: 20px;
  padding: .75rem 1rem;
  background: var(--svp-bg);
  color: var(--svp-text);
  font-size: 16px;
}
.svp-comment-btn {
  background: var(--svp-accent-2);
  color: #fff;
  border: 0;
  border-radius: 20px;
  padding: .75rem 1.5rem;
  font-weight: 600;
  cursor: pointer;
}

/* Overlay de Relacionados */
/* Backdrop escuro atrás do sheet */
.svp-related-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 1999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s ease;
}
.svp-related-backdrop.is-open {
  opacity: 1;
  pointer-events: auto;
}

/* Overlay de Relacionados (bottom sheet) */
.svp-related-overlay {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100vw;
  height: 50vh; /* ocupa metade da tela */
  background: var(--svp-bg);
  border-top-left-radius: 24px;
  border-top-right-radius: 24px;
  z-index: 2000;
  display: flex;
  flex-direction: column;

  /* animação */
  transform: translateY(100%);
  transition: transform .35s ease-out;
  box-shadow: 0 -4px 12px rgba(0,0,0,.15);
}
.svp-related-overlay.is-open {
  transform: translateY(0);
}

/* handle no topo (opcional) */
.svp-related-overlay::before {
  content: "";
  display: block;
  width: 40px;
  height: 5px;
  background: var(--svp-border);
  border-radius: 3px;
  margin: 8px auto;
}

/* header */
.svp-related-header-bar {
  background: var(--svp-bg);
  border-bottom: 1px solid var(--svp-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
}
.svp-related-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--svp-text);
}

/* conteúdo */
.svp-related-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}
.svp-related-grid {
  display: grid;
  gap: 1rem;
}
.svp-related-item {
  display: flex;
  gap: 1rem;
  cursor: pointer;
  padding: 1rem;
  border-radius: 12px;
  transition: background .2s;
  border: 1px solid var(--svp-border);
}
.svp-related-item:hover {
  background: var(--svp-hover);
}
.svp-related-thumb {
  width: 160px;
  aspect-ratio: 16/9;
  border-radius: 8px;
  object-fit: cover;
  background: var(--svp-chip);
  flex: 0 0 160px;
}
.svp-related-info {
  flex: 1;
  min-width: 0;
}
.svp-related-item-title {
  font-weight: 600;
  font-size: 1rem;
  line-height: 1.3;
  margin-bottom: .5rem;
  color: var(--svp-text);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.svp-related-meta {
  color: var(--svp-sub);
  font-size: .9rem;
}
.svp-comment{
  display:flex;gap:.75rem;margin-bottom:1.5rem;padding-bottom:1rem;
  border-bottom:1px solid var(--svp-border);position:relative;
}
.svp-comment:last-child{border-bottom:0}
.svp-comment-avatar{
  width:40px;height:40px;border-radius:50%;background:var(--svp-chip);
  flex:0 0 40px;background-size:cover;background-position:center;
  border:2px solid var(--svp-border);
}
.svp-comment-content{flex:1}
.svp-comment-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}
.svp-comment-author{font-weight:600;font-size:1rem;color:var(--svp-text)}
.svp-comment-delete{
  background:transparent;border:0;color:var(--svp-danger);font-size:.9rem;
  padding:.25rem;border-radius:4px;cursor:pointer;opacity:0.7;
}
.svp-comment-delete:hover{opacity:1;background:rgba(239,68,68,0.1)}
.svp-comment-text{color:var(--svp-text);line-height:1.5;margin-bottom:.5rem;font-size:.95rem}
.svp-comment-time{color:var(--svp-sub);font-size:.85rem}

/* Responsivo Desktop */
@media(min-width:768px){
  .svp-overlay{flex-direction:row}
  .svp-player-main{flex:1;display:flex;flex-direction:column}
  .svp-player-video {
    height:400px;
  }
  .svp-related-grid{grid-template-columns:1fr 1fr}
}

.close-btn{
  background:var(--svp-hover);border:1px solid var(--svp-border);color:var(--svp-text);
  width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .2s;
}
.close-btn:hover{background:var(--svp-chip)}
.close-btn svg{width:20px;height:20px;fill:currentColor}

/* Alert para vídeo denunciado */
.svp-alert{
  background:var(--svp-warn);color:#fff;padding:.75rem 1rem;
  border-radius:8px;margin-bottom:1rem;font-weight:600;
}
  /* Estado normal (não mexe no resto do app) */
#svp-search-btn {
  background: transparent;
  border-radius: 8px;
  transition: background .2s ease, transform .15s ease, color .2s ease;
}

/* Ícone suaviza a transição de cor (usa currentColor) */
#svp-search-btn svg {
  color: black; 
  transition: color .2s ease, opacity .2s ease;
}

/* Estado ativo: fundo vermelho e ícone/branco via currentColor */
#svp-search-btn.active {
  background: #ffffff; /* vermelho */
  color: #ff0000;      /* deixa o SVG branco */
  transform: translateY(-1px);
}

/* Acessibilidade opcional: foco visível sem interferir no app */
#svp-search-btn:focus-visible {
  outline: 2px solid rgba(255,0,0,.6);
  outline-offset: 2px;
}
  /* Toast container */
#toast {
  visibility: hidden;
  min-width: 220px;
  max-width: 80%;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 12px 16px;
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  font-size: 14px;
  font-weight: 600;
  opacity: 0;
  transition: opacity .4s ease, visibility .4s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
}

/* Estado visível */
#toast.show {
  visibility: visible;
  opacity: 1;
}
</style>
</head>
<body>
<div class="svp-app" id="svp-app">
  <!-- Header com navegação -->
  <div class="svp-topbar">
    <div class="svp-header-main">
      
      
      <div class="svp-search" id="svp-search">
          <button onclick="window.open('https://www.youtube.com/shorts','_blank')" id="svp-search-btn" aria-label="Pesquisar">
        <!-- Reels / Vídeos curtos (filled) -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
     fill="currentColor" style="width:24px;height:24px;display:block;">
  <!-- Corpo sólido com cantos arredondados -->
  <rect x="3" y="3" width="20" height="20" rx="4"/>
  <!-- Play central em branco -->
  <path d="M10 9 L16 12 L10 15 Z" fill="#fff"/>
  <!-- Faixas diagonais no topo em branco -->
  <path d="M8 3 L16 11" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
  <path d="M13 3 L21 11" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
</svg> </button>
        <input id="svp-search-input" type="search" placeholder="Pesquisar" autocomplete="off" />
        <button style="display:none;" id="svp-clear-btn" aria-label="Limpar">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42L12 14.85l6.29 6.28 1.42-1.41-6.3-6.29 6.3-6.29z"/></svg>
        </button>
      </div>
       <div id="toast"></div>
      <div class="svp-nav-btns">
        <button class="svp-nav-btn is-active" data-tab="explore">Explorar</button>
        <button class="svp-nav-btn" data-tab="studio">Estúdio</button>
        <button class="svp-nav-btn" data-tab="profile" style="display:none;" id="profile-tab">Perfil</button>
      </div>
    </div>
    <div class="svp-cats" id="svp-cats"></div>
  </div>

  <!-- Conteúdo principal -->
  <main class="svp-content">
    <!-- Página Explorar -->
    <section class="svp-page is-active" id="svp-page-explore">
      <div class="svp-grid" id="svp-feed"></div>
    </section>

    <!-- Página Meu Estúdio -->
    <section class="svp-page" id="svp-page-studio">
      <div class="svp-studio">
        <div class="svp-form" id="svp-form">
          <div class="svp-row">
            <label for="svp-title">Título</label>
            <input class="svp-input" id="svp-title" type="text" placeholder="Ex.: Highlights Angola vs ..." />
          </div>
          <div class="svp-row">
            <label for="svp-category">Categoria</label>
            <select class="svp-select" id="svp-category"></select>
          </div>
          <div class="svp-row">
            <label for="svp-url">URL do vídeo (qualquer link de vídeo)</label>
            <input class="svp-input" id="svp-url" type="url" placeholder="https://..." />
            <div class="svp-hint">Suporta: YouTube, Facebook, TikTok, Vimeo, Dailymotion, MP4, WebM e mais!</div>
          </div>
          <div class="svp-row">
            <label for="svp-cover">Capa (opcional via ImgBB)</label>
            <input class="svp-file" id="svp-cover" type="file" accept="image/*" />
            <img src="https://pluginicons.craft-cdn.com/icon-pickerbUDwu2AsfAwD2UfXuG1murydJQbPqnvmKcEu.svg?1551792320" class="svp-cover-preview" id="svp-cover-preview" alt="Prévia da capa" />
            <div class="svp-hint">Você pode publicar sem capa. Se enviar, fazemos upload via ImgBB automaticamente.</div>
          </div>
          <button class="svp-btn" id="svp-publish">Publicar vídeo</button>
          <div class="svp-hint" id="svp-publish-hint"></div>
        </div>

        <div class="svp-mylist">
          <h3>Meus vídeos</h3>
          <div id="svp-myfeed"></div>
        </div>
      </div>
    </section>

    <!-- Página Perfil do Usuário -->
    <section class="svp-page" id="svp-page-profile">
      <div class="svp-profile">
        <button class="svp-profile-back" id="svp-profile-back">
          <svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          Voltar
        </button>
        
        <div class="svp-profile-header">
          <div class="svp-profile-avatar" id="svp-profile-avatar"></div>
          <div class="svp-profile-name" id="svp-profile-name">Usuário</div>
          <div class="svp-profile-stats">
            <div class="svp-stat">
              <div class="svp-stat-number" id="svp-profile-videos">0</div>
              <div class="svp-stat-label">Vídeos</div>
            </div>
            <div class="svp-stat">
              <div class="svp-stat-number" id="svp-profile-likes">0</div>
              <div class="svp-stat-label">Curtidas</div>
            </div>
            <div class="svp-stat">
              <div class="svp-stat-number" id="svp-profile-views">0</div>
              <div class="svp-stat-label">Visualizações</div>
            </div>
          </div>
        </div>
        
        <div id="svp-profile-videos-list" class="svp-grid"></div>
      </div>
    </section>
  </main>
</div>

<!-- Player Overlay Principal -->
<div class="svp-overlay" id="svp-overlay">
  <div class="svp-player-main">
    <!-- Header do player -->
    <div class="svp-player-header">
      <div class="svp-player-title-wrap">
        <div class="svp-player-title-main" id="svp-player-title">Carregando...</div>
        <div class="svp-player-meta" id="svp-player-meta">0 visualizações</div>
      </div>
      <div class="svp-player-controls">
        
        <button class="svp-player-btn" id="svp-close" aria-label="Fechar">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42L12 14.85l6.29 6.28 1.42-1.41-6.3-6.29 6.3-6.29z"/></svg>
        </button>
      </div>
    </div>

    <!-- Área do vídeo -->
    <div class="svp-player-video" id="svp-player-body"></div>

    <!-- Informações e ações -->
    <div class="svp-player-footer">
      <div id="svp-reported-alert" style="display:none"></div>
      
      <div class="svp-player-info">
        <div class="svp-player-actions">
          <button class="svp-player-action" id="svp-player-like" aria-label="Curtir">
            <svg viewBox="0 0 24 24"><path d="M12.1 8.64l-.1.1-.11-.11C10.14 6.82 7.1 7.24 5.5 9c-1.61 1.76-1.45 4.45.36 6.17l5.86 5.66 5.86-5.66c1.81-1.72 1.97-4.41.36-6.17-1.6-1.76-4.64-2.18-6.34-.36z"/></svg>
            <span id="svp-player-like-count">0</span>
          </button>
          
          <button class="svp-player-action" id="svp-player-report" aria-label="Denunciar">
            <svg viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
            <span id="svp-player-report-count">Denunciar</span>
          </button>
         <button class="svp-player-btn" id="svp-fullscreen" title="Tela cheia" aria-label="Tela cheia"
        style="margin:auto;display:flex;align-items:center;justify-content:center;">
  <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:currentColor;">
    <path d="M7 14H5v5h5v-2H7v-3zm12 5h-5v-2h3v-3h2v5zM7 7h3V5H5v5h2V7zm12 3V5h-5v2h3v3h2z"/>
  </svg>
</button>
        </div>
        
        <!-- Botões para abrir overlays -->
        <div class="svp-overlay-btns">
          <button class="svp-overlay-btn" id="open-related">
            <svg viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6zM10 16.5l6-4.5-6-4.5v9z"/></svg>
            Vídeos Relacionados
          </button>
          <button class="svp-overlay-btn" id="open-comments">
            <svg viewBox="0 0 24 24"><path d="M9 22a1 1 0 01-1-1v-3H4a2 2 0 01-2-2V4a2 2 0 012-2h16a2 2 0 012 2v12a2 2 0 01-2 2h-6.1l-3.7 3.7c-.2.2-.4.3-.7.3H9z"/></svg>
            Comentários
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay de Comentários -->
<div class="svp-comments-overlay" id="comments-overlay">
  <div class="svp-comments-header-bar">
    <div class="svp-comments-title">Comentários</div>
    <button class="close-btn" id="close-comments">
      <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42L12 14.85l6.29 6.28 1.42-1.41-6.3-6.29 6.3-6.29z"/></svg>
    </button>
  </div>
  <div class="svp-comments-content">
    <div class="svp-comment-form">
      <input class="svp-comment-input" id="svp-comment-input-overlay" type="text" placeholder="Adicione um comentário..." />
      <button class="svp-comment-btn" id="svp-comment-btn-overlay"><svg xmlns="http://www.w3.org/2000/svg" 
     viewBox="0 0 24 24" 
     stroke-width="1.5" 
     stroke="white" 
     fill="none" 
     style="width:24px;height:24px;display:block;margin-right:auto;">
  <path stroke-linecap="round" stroke-linejoin="round" 
        d="m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
</svg></button>
    </div>
    <div id="svp-comments-list-overlay"></div>
  </div>
</div>

<!-- Overlay de Relacionados -->
<div class="svp-related-overlay" id="related-overlay">
  <div class="svp-related-header-bar">
    <div class="svp-related-title">Vídeos Relacionados</div>
    <button class="close-btn" id="close-related">
      <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12.01l-6.29-6.3-1.42 1.42 6.3 6.29-6.3 6.29 1.42 1.42L12 14.85l6.29 6.28 1.42-1.41-6.3-6.29 6.3-6.29z"/></svg>
    </button>
  </div>
  <div class="svp-related-content">
    <div class="svp-related-grid" id="svp-related-videos-overlay"></div>
  </div>
</div>

<script type="module">
/* ===== Firebase SDKs ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getDatabase, ref, onValue, push, update, remove, runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* ===== Configs do projeto ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCE_vGty5XsV1YqdCi49Ck2xJDSFq284wc",
  authDomain: "cliente-movicel.firebaseapp.com",
  databaseURL: "https://cliente-movicel-default-rtdb.firebaseio.com",
  projectId: "cliente-movicel",
  storageBucket: "cliente-movicel.firebasestorage.app",
  messagingSenderId: "215414688375",
  appId: "1:215414688375:web:2c7d20a0c03c4c0fcfd472",
  measurementId: "G-7F1RGP9GHV"
};
const apiKeyImgBB = "e073e02267a1f0259cd69c562e780659";

// Lista de emails de administradores
const ADMIN_EMAILS = ["sibemcesar@gmail.com", "sibemcesar02@gmail.com"];

/* ===== Inicialização ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ===== Estado & referências ===== */
const state = {
  user: null,
  videos: [],
  myVideos: [],
  comments: {},
  q: "",
  cat: "Todos",
  cats: ["Todos","Música","Notícias","Esportes","Entretenimento","Educação","Comédia","Tecnologia","Gaming"],
  originalContainer: null,
  isFullscreen: false,
  currentProfile: null
};

/* ===== Util: SVGs inline ===== */
const Icons = {
  like: '<svg viewBox="0 0 24 24"><path d="M12.1 8.64l-.1.1-.11-.11C10.14 6.82 7.1 7.24 5.5 9c-1.61 1.76-1.45 4.45.36 6.17l5.86 5.66 5.86-5.66c1.81-1.72 1.97-4.41.36-6.17-1.6-1.76-4.64-2.18-6.34-.36z"/></svg>',
  liked: '<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 18 4 20 6 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" /></svg>',
  delete: '<svg viewBox="0 0 24 24"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM8 4h8l1 1h3v2H4V5h3l1-1z"/></svg>',
  views: '<svg style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" /></svg>',
  play: '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'
};

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function sanitize(str){return (str||"").trim()}
function byDateDesc(a,b){return (b.createdAt||0)-(a.createdAt||0)}
function matchQuery(item,q){ if(!q) return true; q=q.toLowerCase(); return (item.title||"").toLowerCase().includes(q) || (item.authorName||"").toLowerCase().includes(q); }
function matchCat(item,cat){ if(cat==="Todos") return true; return (item.category||"")===cat; }

function isAdmin(user) {
  return user && ADMIN_EMAILS.includes(user.email);
}

function isVideoVisible(video, user) {
  // Se é admin, vê tudo
  if (isAdmin(user)) return true;
  
  // Se não tem denúncias ou tem menos de 10, todos veem
  const reportCount = video.reportCount || 0;
  return reportCount < 10;
}

/* Video parsing - Suporte universal */
function parseVideoId(url) {
  try {
    const u = new URL(url);
    
    // YouTube
    if (u.hostname.includes("youtu.be")) return { type: 'youtube', id: u.pathname.slice(1) };
    if (u.hostname.includes("youtube.com")) {
      if (u.searchParams.get("v")) return { type: 'youtube', id: u.searchParams.get("v") };
      if (u.pathname.includes("/shorts/")) return { type: 'youtube', id: u.pathname.split("/shorts/")[1].split("?")[0] };
      if (u.pathname.includes("/embed/")) return { type: 'youtube', id: u.pathname.split("/embed/")[1].split("?")[0] };
    }
    
    // Vimeo
    if (u.hostname.includes("vimeo.com")) {
      const vimeoId = u.pathname.split('/').pop();
      return { type: 'vimeo', id: vimeoId };
    }
    
    // TikTok
    if (u.hostname.includes("tiktok.com")) {
      return { type: 'tiktok', url: url };
    }
    
    // Dailymotion
    if (u.hostname.includes("dailymotion.com")) {
      const dmMatch = url.match(/dailymotion\.com\/video\/([^_?]+)/);
      if (dmMatch) return { type: 'dailymotion', id: dmMatch[1] };
    }
    
    // Facebook
    if (u.hostname.includes("facebook.com") || u.hostname.includes("fb.watch")) {
      return { type: 'facebook', url: url };
    }
    
    // Twitch
    if (u.hostname.includes("twitch.tv")) {
      return { type: 'twitch', url: url };
    }
    
    // Arquivo de vídeo direto
    const videoExtensions = ['.mp4', '.webm', '.ogg', '.avi', '.mov', '.wmv', '.flv', '.mkv', '.m4v'];
    const hasVideoExt = videoExtensions.some(ext => url.toLowerCase().includes(ext));
    if (hasVideoExt) {
      return { type: 'direct', url: url };
    }
    
    // Default: tentar como iframe genérico
    return { type: 'generic', url: url };
    
  } catch (e) {
    return { type: 'direct', url: url };
  }
}

function isFacebookUrl(url){ return /facebook\.com|fb\.watch/.test(url) }

/* ImgBB upload */
async function uploadToImgBB(file){
  const hint = $("#svp-publish-hint");
  hint.textContent = "Enviando capa para ImgBB…";
  const base64 = await new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result.split(",")[1]);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
  const fd = new FormData();
  fd.append("image", base64);
  const r = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeyImgBB}`, { method:"POST", body:fd });
  const json = await r.json();
  if(!json.success) throw new Error("Falha ao enviar capa");
  hint.textContent = "Capa enviada com sucesso.";
  return json.data?.url || json.data?.display_url;
}

/* Auth */
function ensureAuth(){
  if(!auth.currentUser){
    const provider = new GoogleAuthProvider();
    signInWithRedirect(auth, provider).catch(()=>{});
  }
}

/* ===== Avatar real do Firebase Auth ===== */
function getUserAvatar(user){
  if(user && user.photoURL){
    return user.photoURL;
  }
  return generateAvatar(user?.uid || 'default');
}

function getAuthorAvatar(authorId, authorPhotoURL){
  if(authorPhotoURL){
    return authorPhotoURL;
  }
  return generateAvatar(authorId);
}

function generateAvatar(uid="x"){
  const c = ["#ff6b6b","#feca57","#1dd1a1","#54a0ff","#5f27cd","#ee5253"];
  const i = uid.split("").reduce((a,ch)=>a+ch.charCodeAt(0),0) % c.length;
  const col = encodeURIComponent(c[i]);
  return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='30' fill='${col}'/><circle cx='32' cy='24' r='8' fill='white'/><path d='M32 36c-8 0-15 4-15 8v4h30v-4c0-4-7-8-15-8z' fill='white'/></svg>`;
}

/* ===== UI dinâmico ===== */
function renderCategories(){
  const cats = state.cats;
  const sel = $("#svp-category");
  sel.innerHTML = cats.filter(c=>c!=="Todos").map(c=>`<option value="${c}">${c}</option>`).join("");
  if(!sel.value) sel.value = "Entretenimento";
  const wrap = $("#svp-cats");
  wrap.innerHTML = cats.map(c=>`<button class="svp-chip ${state.cat===c?"is-active":""}" data-cat="${c}">${c}</button>`).join("");
}

function renderFeed(){
  const list = state.videos
    .filter(v => matchQuery(v, state.q) && matchCat(v, state.cat) && isVideoVisible(v, state.user))
    .sort((a, b) => {
      const scoreA = (a.likesCount||0) * 3 + (a.views||0) * 0.2;
      const scoreB = (b.likesCount||0) * 3 + (b.views||0) * 0.2;
      if (scoreA !== scoreB) return scoreB - scoreA;
      return (b.createdAt||0) - (a.createdAt||0);
    });
  const el = $("#svp-feed");
  el.innerHTML = list.map(cardHTML).join("") || `<div class="svp-empty">Nada encontrado.</div>`;
}

function renderMyFeed(){
  const my = state.videos.filter(v=> v.authorId===state.user?.uid).sort(byDateDesc);
  state.myVideos = my;
  const el = $("#svp-myfeed");
  el.innerHTML = my.length ? my.map(cardHTML).join("") : `<div class="svp-empty">Você ainda não publicou vídeos.</div>`;
}

function renderProfileFeed(userId) {
  const userVideos = state.videos.filter(v => v.authorId === userId && isVideoVisible(v, state.user)).sort(byDateDesc);
  const el = $("#svp-profile-videos-list");
  el.innerHTML = userVideos.length ? userVideos.map(cardHTML).join("") : `<div class="svp-empty">Este usuário ainda não publicou vídeos.</div>`;
  
  // Atualizar estatísticas
  const totalLikes = userVideos.reduce((sum, v) => sum + (v.likesCount || 0), 0);
  const totalViews = userVideos.reduce((sum, v) => sum + (v.views || 0), 0);
  
  $("#svp-profile-videos").textContent = userVideos.length;
  $("#svp-profile-likes").textContent = totalLikes;
  $("#svp-profile-views").textContent = totalViews;
}

/* Card HTML */
function cardHTML(v){
  const cover = v.coverUrl || thumbFromVideo(v);
  const videoInfo = parseVideoId(v.url);
  const durationBadge = getDurationBadge(videoInfo);
  const liked = !!(v.likesBy && state.user && v.likesBy[state.user.uid]);
  const authorAvatar = getAuthorAvatar(v.authorId, v.authorPhotoURL);
  
  // Badge de denúncia para admin
  const reportBadge = isAdmin(state.user) && (v.reportCount >= 10) ? 
    `<div style="position:absolute;top:8px;left:8px;background:var(--svp-danger);color:#fff;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.75rem;font-weight:600;">
      🚨 ${v.reportCount} denúncias
    </div>` : '';
  
  return `
  <article class="svp-card" data-id="${v.id}">
    <div class="svp-thumb-wrap" data-id="${v.id}" data-action="open" style="position:relative;">
      <img class="svp-thumb" src="${cover}" alt="${escapeHtml(v.title)}" />
      <div class="svp-dur">${durationBadge}</div>
      ${reportBadge}
    </div>
    <div class="svp-meta">
      <div class="svp-avatar" style="background-image:url('${authorAvatar}')" data-action="profile" data-author-id="${v.authorId}" data-author-name="${escapeHtml(v.authorName||'')}" data-author-photo="${v.authorPhotoURL||''}"></div>
      <div class="svp-info">
        <h4 class="svp-title">${escapeHtml(v.title)}</h4>
        <div class="svp-sub">
          <span class="svp-author-name" data-action="profile" data-author-id="${v.authorId}" data-author-name="${escapeHtml(v.authorName||'')}" data-author-photo="${v.authorPhotoURL||''}">${escapeHtml(v.authorName||"")}</span> • ${escapeHtml(v.category||"")} • ${Icons.views} ${v.views||0}
        </div>
        <div class="svp-actions">
          <button class="svp-action ${liked?"is-like":""}" data-action="like" data-id="${v.id}" aria-label="Curtir">
            ${liked?Icons.liked:Icons.like} <span>${(v.likesCount||0)}</span>
          </button>
          ${state.user?.uid===v.authorId?`
          <button class="svp-action is-danger" data-action="delete" data-id="${v.id}" aria-label="Apagar">${Icons.delete} Apagar</button>
          `:""}
        </div>
      </div>
    </div>
  </article>
  `;
}

function getDurationBadge(videoInfo) {
  switch(videoInfo.type) {
    case 'youtube': return 'YouTube';
    case 'vimeo': return 'Vimeo';
    case 'tiktok': return 'TikTok';
    case 'dailymotion': return 'Dailymotion';
    case 'facebook': return 'Facebook';
    case 'twitch': return 'Twitch';
    case 'direct': return 'Vídeo';
    default: return 'Vídeo';
  }
}

function thumbFromVideo(v){
  const videoInfo = parseVideoId(v.url);
  
  switch(videoInfo.type) {
    case 'youtube':
      return `https://i.ytimg.com/vi/${videoInfo.id}/hqdefault.jpg`;
    case 'vimeo':
      return `https://vumbnail.com/${videoInfo.id}.jpg`;
    case 'dailymotion':
      return `https://www.dailymotion.com/thumbnail/video/${videoInfo.id}`;
    case 'facebook':
      return "https://static.xx.fbcdn.net/rsrc.php/yV/r/B8q7QmN8QSh.svg";
    default:
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='640' height='360'><rect width='100%' height='100%' fill='#ddd'/><polygon points='260,180 260,120 340,150' fill='#666'/></svg>`);
  }
}

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]))}

/* ===== Profile functions ===== */
function openProfile(authorId, authorName, authorPhotoURL) {
  state.currentProfile = { authorId, authorName, authorPhotoURL };
  
  // Atualizar header do perfil
  const avatar = getAuthorAvatar(authorId, authorPhotoURL);
  $("#svp-profile-avatar").style.backgroundImage = `url('${avatar}')`;
  $("#svp-profile-name").textContent = authorName || "Usuário";
  
  // Renderizar vídeos do usuário
  renderProfileFeed(authorId);
  
  // Mostrar aba do perfil e ativá-la
  $("#profile-tab").style.display = "block";
  $$(".svp-nav-btn").forEach(b => b.classList.toggle("is-active", b.dataset.tab === "profile"));
  $$(".svp-page").forEach(p => p.classList.toggle("is-active", p.id === "svp-page-profile"));
}

function closeProfile() {
  state.currentProfile = null;
  $("#profile-tab").style.display = "none";
  
  // Voltar para explorar
  $$(".svp-nav-btn").forEach(b => b.classList.toggle("is-active", b.dataset.tab === "explore"));
  $$(".svp-page").forEach(p => p.classList.toggle("is-active", p.id === "svp-page-explore"));
}

/* ===== Player Overlay ===== */
let currentVideo = null;
function openPlayer(v){
  currentVideo = v;
  $("#svp-player-title").textContent = v.title || "Carregando...";
  $("#svp-player-meta").textContent = `${v.views||0} visualizações • ${v.authorName||""} • ${v.category||""}`;
  
  const body = $("#svp-player-body");
  body.innerHTML = buildPlayerHTML(v);
  
  updatePlayerLikeButton(v);
  updatePlayerReportButton(v);
  showReportAlert(v);
  
  $("#svp-overlay").classList.add("is-open");
  document.body.style.overflow = 'hidden';
  
  runTransaction(ref(db, `videos/${v.id}/views`), curr => (curr||0)+1);
}

function closePlayer(){
  if (state.isFullscreen) {
    exitFullscreen();
  }
  
  $("#svp-overlay").classList.remove("is-open");
  $("#svp-player-body").innerHTML = "";
  document.body.style.overflow = '';
  
  currentVideo = null;
}

function buildPlayerHTML(v){
  const videoInfo = parseVideoId(v.url);
  
  switch(videoInfo.type) {
    case 'youtube':
      const ytSrc = `https://www.youtube.com/embed/${videoInfo.id}?autoplay=1&rel=0&modestbranding=1&iv_load_policy=3`;
      return `<iframe id="video-iframe" src="${ytSrc}" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
      
    case 'vimeo':
      const vimeoSrc = `https://player.vimeo.com/video/${videoInfo.id}?autoplay=1`;
      return `<iframe id="video-iframe" src="${vimeoSrc}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
      
    case 'dailymotion':
      const dmSrc = `https://www.dailymotion.com/embed/video/${videoInfo.id}?autoplay=1`;
      return `<iframe id="video-iframe" src="${dmSrc}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
      
    case 'facebook':
      const fbSrc = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(videoInfo.url)}&show_text=false&autoplay=true`;
      return `<iframe id="video-iframe" src="${fbSrc}" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
      
    case 'tiktok':
      // TikTok embed é complexo, vamos usar iframe genérico
      return `<iframe id="video-iframe" src="${videoInfo.url}" frameborder="0" allowfullscreen></iframe>`;
      
    case 'twitch':
      return `<iframe id="video-iframe" src="${videoInfo.url}" frameborder="0" allowfullscreen></iframe>`;
      
    case 'direct':
      return `<video id="video-iframe" src="${videoInfo.url}" controls autoplay playsinline></video>`;
      
    default:
      // Tentar iframe genérico para outros casos
      return `<iframe id="video-iframe" src="${videoInfo.url}" frameborder="0" allowfullscreen></iframe>`;
  }
}

function updatePlayerLikeButton(v){
  const liked = !!(v.likesBy && state.user && v.likesBy[state.user.uid]);
  const btn = $("#svp-player-like");
  btn.className = `svp-player-action ${liked?"is-liked":""}`;
  btn.innerHTML = `
    <svg viewBox="0 0 24 24"><path d="${liked ? "M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 18 4 20 6 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" : "M12.1 8.64l-.1.1-.11-.11C10.14 6.82 7.1 7.24 5.5 9c-1.61 1.76-1.45 4.45.36 6.17l5.86 5.66 5.86-5.66c1.81-1.72 1.97-4.41.36-6.17-1.6-1.76-4.64-2.18-6.34-.36z"}"/></svg>
    <span>${v.likesCount||0}</span>
  `;
}

function updatePlayerReportButton(v){
  const reported = !!(v.reportsBy && state.user && v.reportsBy[state.user.uid]);
  const btn = $("#svp-player-report");
  btn.className = `svp-player-action ${reported?"is-reported":""}`;
  btn.innerHTML = `
    <svg viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
    <span>${reported ? "Denunciado" : "Denunciar"}</span>
  `;
}

function showReportAlert(v) {
  const alertDiv = $("#svp-reported-alert");
  const reportCount = v.reportCount || 0;
  
  if (isAdmin(state.user) && reportCount >= 10) {
    alertDiv.style.display = "block";
    alertDiv.className = "svp-alert";
    alertDiv.innerHTML = `🚨 Este vídeo tem ${reportCount} denúncias e só é visível para administradores.`;
  } else {
    alertDiv.style.display = "none";
  }
}

/* ===== Overlays de Comentários e Relacionados ===== */
function openCommentsOverlay() {
  loadCommentsForOverlay(currentVideo.id);
  $("#comments-overlay").classList.add("is-open");
}

function openRelatedOverlay() {
  loadRelatedForOverlay(currentVideo);
  $("#related-overlay").classList.add("is-open");
}

function closeCommentsOverlay() {
  $("#comments-overlay").classList.remove("is-open");
  $("#svp-comments-list-overlay").innerHTML = "";
}

function closeRelatedOverlay() {
  $("#related-overlay").classList.remove("is-open");
  $("#svp-related-videos-overlay").innerHTML = "";
}

function loadCommentsForOverlay(videoId){
  onValue(ref(db, `comments/${videoId}`), snap => {
    const comments = [];
    snap.forEach(child => {
      comments.push({ id: child.key, ...child.val() });
    });
    renderCommentsOverlay(comments.sort(byDateDesc));
  });
}

function renderCommentsOverlay(comments){
  const list = $("#svp-comments-list-overlay");
  list.innerHTML = comments.map(comment => {
    const commentAvatar = getAuthorAvatar(comment.authorId, comment.authorPhotoURL);
    const canDelete = state.user && state.user.uid === comment.authorId;
    return `
    <div class="svp-comment">
      <div class="svp-comment-avatar" style="background-image:url('${commentAvatar}')"></div>
      <div class="svp-comment-content">
        <div class="svp-comment-header">
          <div class="svp-comment-author">${escapeHtml(comment.authorName||"")}</div>
          ${canDelete ? `<button class="svp-comment-delete" data-action="delete-comment" data-comment-id="${comment.id}" data-video-id="${currentVideo?.id}" title="Apagar comentário">×</button>` : ''}
        </div>
        <div class="svp-comment-text">${escapeHtml(comment.text||"")}</div>
        <div class="svp-comment-time">${timeAgo(comment.createdAt)}</div>
      </div>
    </div>
  `}).join("") || '<div class="svp-empty">Seja o primeiro a comentar!</div>';
}

function loadRelatedForOverlay(currentVideo){
  const related = state.videos
    .filter(v => v.id !== currentVideo.id && v.category === currentVideo.category && isVideoVisible(v, state.user))
    .sort(byDateDesc)
    .slice(0, 20);
  
  const container = $("#svp-related-videos-overlay");
  container.innerHTML = related.map(v => `
    <div class="svp-related-item" data-id="${v.id}" data-action="open-related">
      <img class="svp-related-thumb" src="${v.coverUrl || thumbFromVideo(v)}" alt="${escapeHtml(v.title)}" />
      <div class="svp-related-info">
        <div class="svp-related-item-title">${escapeHtml(v.title)}</div>
        <div class="svp-related-meta">${escapeHtml(v.authorName||"")} • ${v.views||0} visualizações</div>
      </div>
    </div>
  `).join("") || '<div class="svp-empty">Nenhum vídeo relacionado encontrado.</div>';
}

function timeAgo(timestamp){
  if(!timestamp) return "";
  const diff = Date.now() - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if(days > 0) return `${days} dia${days>1?'s':''} atrás`;
  if(hours > 0) return `${hours} hora${hours>1?'s':''} atrás`;
  if(minutes > 0) return `${minutes} minuto${minutes>1?'s':''} atrás`;
  return 'Agora';
}

// Fullscreen
function requestFullscreen(){
  const iframe = $("#video-iframe");
  if (!iframe) return;

  try {
    state.originalContainer = iframe.parentNode;
    state.isFullscreen = true;

    if (iframe.requestFullscreen) {
      iframe.requestFullscreen().catch(err => tryFallbackFullscreen(iframe));
    } else if (iframe.webkitRequestFullscreen) {
      iframe.webkitRequestFullscreen();
    } else if (iframe.mozRequestFullScreen) {
      iframe.mozRequestFullScreen();
    } else if (iframe.msRequestFullscreen) {
      iframe.msRequestFullscreen();
    } else {
      tryFallbackFullscreen(iframe);
    }
  } catch (error) {
    tryFallbackFullscreen(iframe);
  }
}

function tryFallbackFullscreen(iframe) {
  const fullscreenContainer = document.createElement('div');
  fullscreenContainer.id = 'fullscreen-container';
  fullscreenContainer.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center;
  `;
  
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '×';
  closeBtn.style.cssText = `
    position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7);
    color: white; border: 0; border-radius: 50%; width: 40px; height: 40px;
    font-size: 24px; cursor: pointer; z-index: 10001;
  `;
  closeBtn.onclick = exitFullscreen;
  
  iframe.style.cssText = 'width: 100%; height: 100%; border: 0;';
  fullscreenContainer.appendChild(closeBtn);
  fullscreenContainer.appendChild(iframe);
  document.body.appendChild(fullscreenContainer);
}

function exitFullscreen(){
  try {
    state.isFullscreen = false;
    const customContainer = $("#fullscreen-container");
    if (customContainer) {
      const iframe = customContainer.querySelector('#video-iframe');
      if (iframe && state.originalContainer) {
        iframe.style.cssText = 'width:100%;height:100%;border:0;display:block;object-fit:contain;';
        state.originalContainer.appendChild(iframe);
      }
      customContainer.remove();
      return;
    }
    
    if (document.exitFullscreen) {
      document.exitFullscreen().catch(console.error);
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  } catch (error) {
    console.error('Erro ao sair da tela cheia:', error);
  }
}

document.addEventListener('fullscreenchange', () => {
  const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
  if (!isFullscreen && state.isFullscreen) {
    const iframe = document.querySelector('#video-iframe');
    if (iframe && state.originalContainer) {
      iframe.style.cssText = 'width:100%;height:100%;border:0;display:block;object-fit:contain;';
      state.originalContainer.appendChild(iframe);
    }
    state.isFullscreen = false;
  }
});

/* ===== Eventos ===== */
$$(".svp-nav-btn").forEach(btn => {
  btn.addEventListener("click", ()=>{
    const tab = btn.dataset.tab;
    $$(".svp-nav-btn").forEach(b=> b.classList.toggle("is-active", b.dataset.tab===tab));
    $$(".svp-page").forEach(p=> p.classList.toggle("is-active", p.id === `svp-page-${tab}`));
  });
});

$("#svp-cats").addEventListener("click",(e)=>{
  const chip = e.target.closest(".svp-chip");
  if(!chip) return;
  state.cat = chip.dataset.cat;
  renderCategories();
  renderFeed();
});

$("#svp-search-input").addEventListener("input", debounce(()=>{
  state.q = sanitize($("#svp-search-input").value);
  renderFeed();
}, 120));

$("#svp-clear-btn").addEventListener("click", ()=>{
  $("#svp-search-input").value = "";
  state.q = "";
  renderFeed();
});

// Profile events
$("#svp-profile-back").addEventListener("click", closeProfile);

document.body.addEventListener("click",(e)=>{
  const open = e.target.closest('[data-action="open"]');
  const openRelated = e.target.closest('[data-action="open-related"]');
  const like = e.target.closest('[data-action="like"]');
  const del = e.target.closest('[data-action="delete"]');
  const delComment = e.target.closest('[data-action="delete-comment"]');
  const profile = e.target.closest('[data-action="profile"]');

  if(open){
    const id = open.dataset.id;
    const v = state.videos.find(x=>x.id===id);
    if(v) openPlayer(v);
  }
  if(openRelated){
    const id = openRelated.dataset.id;
    const v = state.videos.find(x=>x.id===id);
    if(v) {
      closeRelatedOverlay();
      closeCommentsOverlay();
      openPlayer(v);
    }
  }
  if(like){
    const id = like.dataset.id;
    toggleLike(id).catch(()=>{});
  }
  if(del){
    const id = del.dataset.id;
    deleteVideo(id);
  }
  if(delComment){
    const commentId = delComment.dataset.commentId;
    const videoId = delComment.dataset.videoId;
    deleteComment(commentId, videoId);
  }
  if(profile){
    const authorId = profile.dataset.authorId;
    const authorName = profile.dataset.authorName;
    const authorPhoto = profile.dataset.authorPhoto;
    openProfile(authorId, authorName, authorPhoto);
  }
});

// Player events
$("#svp-close").addEventListener("click", closePlayer);
$("#svp-fullscreen").addEventListener("click", requestFullscreen);
$("#svp-player-like").addEventListener("click", ()=>{
  if(currentVideo) toggleLike(currentVideo.id).catch(()=>{});
});

// Report button
$("#svp-player-report").addEventListener("click", ()=>{
  if(currentVideo) toggleReport(currentVideo.id).catch(()=>{});
});

// Overlay buttons
$("#open-comments").addEventListener("click", openCommentsOverlay);
$("#open-related").addEventListener("click", openRelatedOverlay);
$("#close-comments").addEventListener("click", closeCommentsOverlay);
$("#close-related").addEventListener("click", closeRelatedOverlay);

// Comment forms
$("#svp-comment-btn-overlay").addEventListener("click", async ()=>{
  ensureAuth();
  const user = auth.currentUser;
  const text = sanitize($("#svp-comment-input-overlay").value);
  
  if(!user || !currentVideo || !text) return;
  
  const data = {
    text,
    authorId: user.uid,
    authorName: user.displayName || user.email || "Usuário",
    authorPhotoURL: user.photoURL || null,
    createdAt: Date.now()
  };
  
  await push(ref(db, `comments/${currentVideo.id}`), data);
  $("#svp-comment-input-overlay").value = "";
});

// Publicação
const coverInput = $("#svp-cover");
const coverPreview = $("#svp-cover-preview");
coverInput.addEventListener("change", ()=>{
  const f = coverInput.files?.[0];
  if(f){ coverPreview.src = URL.createObjectURL(f); }
  else { coverPreview.removeAttribute("src"); }
});

$("#svp-publish").addEventListener("click", async ()=>{
  ensureAuth();
  const user = auth.currentUser;
  const title = sanitize($("#svp-title").value);
  const category = $("#svp-category").value;
  const url = sanitize($("#svp-url").value);
  const hint = $("#svp-publish-hint");

  if(!user){ hint.textContent="Autenticando… tente novamente."; return; }
  if(!title || !category || !url){ hint.textContent="Preencha título, categoria e URL."; return; }

  try{
    let coverUrl = "";
    const f = coverInput.files?.[0];
    if(f){ coverUrl = await uploadToImgBB(f); }
    const data = {
      title, category, url, coverUrl,
      authorId: user.uid,
      authorName: user.displayName || user.email || "Autor",
      authorPhotoURL: user.photoURL || null,
      createdAt: Date.now(),
      likesCount: 0,
      views: 0,
      reportCount: 0
    };
    await push(ref(db, "videos"), data);
    hint.textContent = "Publicado com sucesso!";
    $("#svp-title").value = "";
    $("#svp-url").value = "";
    coverInput.value = "";
    coverPreview.removeAttribute("src");
  }catch(err){
    hint.textContent = "Erro ao publicar. Verifique o link e tente novamente.";
  }
});

/* Like/Unlike */
async function toggleLike(id){
  const user = auth.currentUser;
  if(!user){ ensureAuth(); return; }
  const v = state.videos.find(x=>x.id===id);
  if(!v) return;
  const liked = !!(v.likesBy && v.likesBy[user.uid]);

  await runTransaction(ref(db, `videos/${id}/likesCount`), curr => {
    if(liked){ return Math.max((curr||0)-1, 0); }
    return (curr||0)+1;
  });
  await update(ref(db, `videos/${id}`), {
    [`likesBy/${user.uid}`]: liked ? null : true
  });
}

/* Report Video */
async function toggleReport(id){
  const user = auth.currentUser;
  if(!user){ ensureAuth(); return; }
  const v = state.videos.find(x=>x.id===id);
  if(!v) return;
  
  // Não pode denunciar próprio vídeo
  if(v.authorId === user.uid) {
    showToast("Você não pode denunciar seu próprio vídeo");
    return;
  }
  
  const reported = !!(v.reportsBy && v.reportsBy[user.uid]);

  await runTransaction(ref(db, `videos/${id}/reportCount`), curr => {
    if(reported){ return Math.max((curr||0)-1, 0); }
    return (curr||0)+1;
  });
  await update(ref(db, `videos/${id}`), {
    [`reportsBy/${user.uid}`]: reported ? null : true
  });
  
  showToast(reported ? "Denúncia removida" : "Vídeo denunciado");
}

/* Apagar comentário */
async function deleteComment(commentId, videoId) {
  if (!commentId || !videoId) return;
  
  showConfirmDialog("Tem certeza que deseja apagar este comentário?", async () => {
    try {
      await remove(ref(db, `comments/${videoId}/${commentId}`));
    } catch (err) {
      console.error("Erro ao deletar comentário:", err);
    }
  });
}

function showConfirmDialog(message, onConfirm) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.5);
    display:flex;align-items:center;justify-content:center;
    z-index:9999
  `;

  modal.innerHTML = `
    <div style="background:white;padding:1.5rem;border-radius:12px;
                box-shadow:0 4px 20px rgba(0,0,0,0.3);
                max-width:400px;width:90%;margin:1rem">
      <p style="color:#333;margin-bottom:1rem;font-size:1rem">${message}</p>
      <div style="display:flex;justify-content:flex-end;gap:0.75rem">
        <button class="confirm-cancel"
          style="padding:0.5rem 1rem;color:#666;background:transparent;
                 border:1px solid #ddd;border-radius:6px;cursor:pointer">
          Cancelar
        </button>
        <button class="confirm-yes"
          style="padding:0.5rem 1rem;background:#ef4444;color:white;
                 border:0;border-radius:6px;cursor:pointer;font-weight:600">
          Confirmar
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  modal.querySelector('.confirm-cancel').addEventListener('click', () => modal.remove());
  modal.querySelector('.confirm-yes').addEventListener('click', () => {
    modal.remove();
    if (typeof onConfirm === 'function') {
      try {
        const result = onConfirm();
        if (result instanceof Promise) {
          result.catch(err => console.error("Erro ao confirmar:", err));
        }
      } catch (err) {
        console.error("Erro ao confirmar:", err);
      }
    }
  });
}

async function deleteVideo(id) {
  const v = state.videos.find(x => x.id === id);
  if (!v || state.user?.uid !== v.authorId) return;

  showConfirmDialog("Tem certeza que deseja apagar este vídeo?", async () => {
    try {
      await remove(ref(db, `videos/${id}`));
      await remove(ref(db, `comments/${id}`));
    } catch (err) {
      console.error("Erro ao deletar:", err);
    }
  });
}

function showToast(msg) {
  const t = document.createElement("div");
  t.textContent = msg;
  Object.assign(t.style, {
    position:"fixed", bottom:"20px", left:"50%",
    transform:"translateX(-50%)",
    background:"rgba(0,0,0,0.85)", color:"#fff",
    padding:"8px 14px", borderRadius:"6px",
    fontSize:"14px", zIndex:99999,
    opacity:"0", transition:"opacity .3s"
  });
  document.body.appendChild(t);
  requestAnimationFrame(()=> t.style.opacity="1");
  setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),300); },2000);
}

/* Realtime */
onValue(ref(db, "videos"), snap=>{
  const items = [];
  snap.forEach(child=>{
    const val = child.val()||{};
    items.push({ id: child.key, ...val });
  });
  state.videos = items;
  renderFeed();
  renderMyFeed();
  
  // Atualizar perfil se estiver aberto
  if (state.currentProfile) {
    renderProfileFeed(state.currentProfile.authorId);
  }
  
  if(currentVideo){
    const updatedVideo = items.find(v => v.id === currentVideo.id);
    if(updatedVideo){
      updatePlayerLikeButton(updatedVideo);
      updatePlayerReportButton(updatedVideo);
      showReportAlert(updatedVideo);
      currentVideo = updatedVideo;
    }
  }
});

onAuthStateChanged(auth, user=>{
  state.user = user;
  renderFeed(); 
  renderMyFeed();
});
ensureAuth();
renderCategories();

function debounce(fn,ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
}
</script>
 
<script>
  const btn = document.getElementById('svp-search-btn');
  const toast = document.getElementById('toast');

  btn.addEventListener('click', () => {
    btn.classList.add('active');
    if (toast) {
      toast.textContent = "Abrindo Vídeos curtos…";
      toast.classList.add('show');
    }

    const url = 'https://www.youtube.com/shorts';

    // Tenta abrir em nova aba; se falhar (WebView/popup bloqueado), faz fallback no mesmo window
    let win = null;
    try { win = window.open(url, '_blank'); } catch (e) {}

    if (!win) {
      // Fallback confiável para WebView/Android: navega na mesma janela
      window.location.assign(url);
      return;
    }

    // Reset visual (não será visto se navegar na mesma janela)
    setTimeout(() => {
      btn.classList.remove('active');
      if (toast) toast.classList.remove('show');
    }, 2000);
  });
</script>

</body>
</html>
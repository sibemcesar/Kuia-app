<!DOCTYPE html>
<html lang="pt-AO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuia+ Monetiza - Ganhe Dinheiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        kuia: {
                            red: '#CE1126',
                            yellow: '#FFCD00',
                            blue: '#0066CC'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'bounce-subtle': 'bounceSubtle 0.6s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', transform: 'scale(1)' },
                            '50%': { opacity: '0.8', transform: 'scale(1.05)' }
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #0066CC 0%, #5D5CDE 50%, #FFCD00 100%);
        }

        .kuia-logo {
            background: linear-gradient(45deg, #0066CC, #5D5CDE);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .kuia-logo:hover {
            transform: rotate(360deg) scale(1.1);
        }

        .timer-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #5D5CDE var(--progress), #E5E7EB var(--progress));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(93, 92, 222, 0.4);
        }

        .timer-circle:active {
            transform: scale(0.98);
        }

        .timer-inner {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dark .timer-inner {
            background: #1F2937;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .dark .card {
            background: #1F2937;
            border-color: #374151;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(93, 92, 222, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: #5D5CDE;
            border: 2px solid #5D5CDE;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #5D5CDE;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(93, 92, 222, 0.3);
        }

        .dark .btn-secondary {
            background: #1F2937;
            color: #A78BFA;
            border-color: #A78BFA;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-1px);
        }

        .tab-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 2px solid #5D5CDE;
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .tab-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(93, 92, 222, 0.1), transparent);
            transition: left 0.5s;
        }

        .tab-card:hover::before {
            left: 100%;
        }

        .tab-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(93, 92, 222, 0.2);
            border-color: #7C3AED;
        }

        .dark .tab-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%);
            border-color: #A78BFA;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #10B981;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #EF4444;
        }

        .referral-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 3px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 20px;
            border-radius: 12px;
            border: 3px solid #000;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: #10B981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .overlay-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 95vw;
            max-height: 95vh;
            width: 100%;
            height: 100%;
            margin: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .overlay-modal.show .overlay-content {
            transform: scale(1);
        }

        .dark .overlay-content {
            background: #1F2937;
        }

        .overlay-header {
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .overlay-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            margin: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .dark .modal-content {
            background: #1F2937;
        }

        .history-item, .notification-item, .leaderboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin: 8px 0;
            border-radius: 12px;
            background: #F8FAFC;
            border-left: 4px solid #5D5CDE;
            transition: all 0.3s ease;
        }

        .history-item:hover, .notification-item:hover, .leaderboard-row:hover {
            background: #E2E8F0;
            transform: translateX(4px);
        }

        .dark .history-item, .dark .notification-item, .dark .leaderboard-row {
            background: #374151;
        }

        .dark .history-item:hover, .dark .notification-item:hover, .dark .leaderboard-row:hover {
            background: #4B5563;
        }

        .notification-item.unread {
            background: #EFF6FF;
            border-left-color: #3B82F6;
        }

        .dark .notification-item.unread {
            background: rgba(30, 58, 138, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .quick-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .dark .quick-nav {
            background: rgba(31, 41, 55, 0.9);
        }

        .quick-nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .quick-nav-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 4px 20px rgba(93, 92, 222, 0.4);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* MELHORIAS: Estilos para sincronização */
        .sync-indicator {
            position: relative;
        }

        .sync-indicator.syncing #syncStatus {
            background: #F59E0B;
            animation: pulse 1s infinite;
        }

        .sync-indicator.error #syncStatus {
            background: #EF4444;
        }

        .balance-update {
            animation: balanceGlow 1.5s ease-in-out;
        }

        @keyframes balanceGlow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(93, 92, 222, 0); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(93, 92, 222, 0.4); }
        }

        .manual-sync-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .overlay-content {
                margin: 10px;
                border-radius: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-nav {
                bottom: 10px;
                padding: 6px;
            }
            
            .quick-nav-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">
        💾 Dados salvos automaticamente
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="kuia-logo mx-auto mb-4 animate-pulse-glow">K+</div>
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400 text-lg animate-fade-in">Carregando Kuia+ Monetiza...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-40 hidden">
        <div style="display:none;" class="card max-w-md w-full mx-4 animate-slide-up">
            <div style="display:none;"  class="text-center mb-6">
                <div class="kuia-logo mx-auto mb-4 animate-bounce-subtle">K+</div>
                <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Kuia+ Monetiza</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Transforme seu tempo em dinheiro</p>
            </div>
            
            <!-- Referral Code Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">🎁 Código de Convite (Opcional):</label>
                <input type="text" id="referralCodeInput" maxlength="6" placeholder="Digite aqui..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono font-bold uppercase">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Ganhe 50 Kz de bônus!</p>
            </div>
            
            <button id="loginBtn" class="w-full btn-primary text-lg">
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header style="display:none;"  class="gradient-bg text-white p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="kuia-logo">K+</div>
                    <div>
                        <h1 class="text-xl font-bold">Kuia+ Monetiza</h1>
                        <p class="text-sm opacity-90">Ganhe dinheiro com seu tempo</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- MELHORIA: Indicador de sincronização -->
                    <div id="syncIndicator" class="sync-indicator flex items-center space-x-2">
                        <div id="syncStatus" class="w-2 h-2 rounded-full bg-green-400 pulse-animation" title="Sincronizado"></div>
                        <button id="manualSyncBtn" class="manual-sync-btn text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-colors" title="Atualizar saldo manualmente">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="userInfo" class="flex items-center space-x-2">
                        <img id="userPhoto" class="w-10 h-10 rounded-full border-2 border-white" src="" alt="Utilizador">
                        <div class="text-right">
                            <div id="userName" class="font-medium"></div>
                            <div class="text-xs opacity-90">Membro</div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <script>
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(function() {
                var el = document.getElementById("timerCircle");
                if (el) {
                    el.click();
                    console.log("Clique automático no #timerCircle executado.");
                } else {
                    console.warn("Elemento #timerCircle não encontrado.");
                }
            }, 5000);
        });
        </script>
        
        <main class="max-w-6xl mx-auto p-4 space-y-6 pb-32">
            <!-- Timer Section -->
            <div class="text-center animate-fade-in">
                <div class="timer-circle mx-auto mb-6" id="timerCircle" style="--progress: 0%;">
                    <div class="timer-inner">
                        <div class="flex items-center mb-2">
                            <div id="timerStatus" class="status-indicator status-inactive"></div>
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Status</span>
                        </div>
                        <div id="todayTime" class="text-3xl font-bold text-gray-900 dark:text-white">00:00:00</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Hoje</div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Clique no timer para iniciar/parar</p>
                    <div class="flex items-center justify-center space-x-4">
                        <div class="text-center">
                            <div class="text-lg font-bold text-primary" id="todayRewards">0,00 Kz</div>
                            <div class="text-xs text-gray-500">Ganho Hoje</div>
                        </div>
                        <div class="w-px h-8 bg-gray-300"></div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-500" id="totalRewards">0,00 Kz</div>
                            <div class="text-xs text-gray-500">Total</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-4 animate-slide-up">
                <button id="withdrawBtn" class="btn-primary flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <span>Levantar</span>
                </button>
                <button id="transferBtn" class="btn-secondary flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span>Transferir</span>
                </button>
            </div>

            <!-- Navigation Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 animate-slide-up">
                <!-- Stats Card -->
                <div id="statsCard" class="tab-card cursor-pointer" onclick="openOverlay('statsOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">📊</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Estatísticas</h3>
                    </div>
                </div>

                <!-- Referral Card -->
                <div id="referralCard" class="tab-card cursor-pointer" onclick="openOverlay('referralOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🎁</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Indicações</h3>
                    </div>
                </div>

                <!-- History Card -->
                <div id="historyCard" class="tab-card cursor-pointer" onclick="openOverlay('historyOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">📋</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Histórico</h3>
                    </div>
                </div>

                <!-- Notifications Card -->
                <div id="notificationsCard" class="tab-card cursor-pointer relative" onclick="openOverlay('notificationsOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🔔</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Notificações</h3>
                        <span id="notificationBadge" class="notification-badge hidden">0</span>
                    </div>
                </div>

                <!-- Leaderboard Card -->
                <div style="display:none;"  id="leaderboardCard" class="tab-card cursor-pointer col-span-2 md:col-span-1" onclick="openOverlay('leaderboardOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🏆</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Ranking</h3>
                    </div>
                </div>
            </div>
        </main>

        <!-- Quick Navigation -->
        <div class="quick-nav">
            <button class="quick-nav-btn" onclick="openOverlay('statsOverlay')" title="Estatísticas">
                📊
            </button>
            <button class="quick-nav-btn" onclick="openOverlay('referralOverlay')" title="Indicações">
                🎁
            </button>
            <button class="quick-nav-btn" onclick="openOverlay('historyOverlay')" title="Histórico">
                📋
            </button>
            <button class="quick-nav-btn relative" onclick="openOverlay('notificationsOverlay')" title="Notificações">
                🔔
                <span id="quickNavNotificationBadge" class="notification-badge hidden">0</span>
            </button>
            <button style="display:none;"  class="quick-nav-btn" onclick="openOverlay('leaderboardOverlay')" title="Ranking">
                🏆
            </button>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div id="statsOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">📊</div>
                        <h2 class="text-xl font-bold">Estatísticas</h2>
                    </div>
                    <button onclick="closeOverlay('statsOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="stats-grid">
                    <!-- Progress Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⏱️</span>
                            Progresso Diário
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600 dark:text-gray-400">Tempo Trabalhado</span>
                                    <span id="timeProgress" class="font-medium">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                    <div id="timeProgressBar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">Limite: 5h diárias</div>
                            </div>
                            <div class="pt-2">
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Sessão Atual:</div>
                                <div id="sessionTime" class="text-lg font-bold text-purple-600">00:00:00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2"></span>
                            Ganhos
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Hoje:</span>
                                <span id="todayEarnings" class="font-bold text-green-500">0,00 Kz</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Disponível:</span>
                                <span id="availableEarnings" class="font-bold text-blue-500">0,00 Kz</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Taxa:</span>
                                <span class="font-medium text-purple-600">40 Kz/hora</span>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between text-lg">
                                <span class="text-gray-900 dark:text-white font-semibold">Total Ganho:</span>
                                <span id="totalEarningsDisplay" class="font-bold text-primary">0,00 Kz</span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⚡</span>
                            Status do Sistema
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Timer:</span>
                                <div class="flex items-center">
                                    <div id="timerStatusIndicator" class="status-indicator status-inactive"></div>
                                    <span id="userStatus" class="font-medium text-gray-500">Pausado</span>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Transferências:</span>
                                <span id="transferStatus" class="font-medium text-green-500">Habilitado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Conta:</span>
                                <span class="font-medium text-green-500">Ativa</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Última sessão:</span>
                                <span class="font-medium text-gray-700 dark:text-gray-300" id="lastSession">Agora</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⏳</span>
                            Pedidos Pendentes
                        </h3>
                        <div class="space-y-3">
                            <div id="pendingInfo">
                                <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                    <div class="text-3xl mb-2"></div>
                                    <p>Nenhum pedido pendente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Overlay -->
    <div id="referralOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🎁</div>
                        <h2 class="text-xl font-bold">Sistema de Indicações</h2>
                    </div>
                    <button onclick="closeOverlay('referralOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="stats-grid">
                    <!-- My Code Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">🔑</span>
                            Meu Código de Convite
                        </h3>
                        <div class="text-center">
                            <div id="userReferralCode" class="referral-code mb-4">CARREGANDO...</div>
                            <button id="copyReferralCode" class="btn-primary w-full mb-2">
                                📋 Copiar Código
                            </button>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                Compartilhe este código para ganhar bônus!
                            </p>
                        </div>
                    </div>

                    <!-- Referral Stats Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">📈</span>
                            Minhas Indicações
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Confirmadas:</span>
                                <div class="text-center">
                                    <span id="confirmedReferrals" class="font-bold text-green-500 text-lg">0</span>
                                    <div class="text-xs text-gray-500">pessoas</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Pendentes:</span>
                                <div class="text-center">
                                    <span id="pendingReferrals" class="font-bold text-yellow-500 text-lg">0</span>
                                    <div class="text-xs text-gray-500">aguardando</div>
                                </div>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900 dark:text-white font-semibold">Bônus Total:</span>
                                <div class="text-center">
                                    <span id="referralBonus" class="font-bold text-blue-500 text-lg">0,00 Kz</span>
                                    <div class="text-xs text-gray-500">ganho</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Use Code Card -->
                    <div class="card col-span-full">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">💎</span>
                            Usar Código de Convite
                        </h3>
                        <div class="max-w-md mx-auto">
                            <div class="space-y-4">
                                <div class="text-center mb-4">
                                    <div class="text-3xl mb-2">🎯</div>
                                    <p class="text-gray-600 dark:text-gray-400">
                                        Digite um código para ganhar <strong>50 Kz</strong> de bônus!
                                    </p>
                                </div>
                                <input type="text" id="newReferralCodeInput" maxlength="6" placeholder="Digite o código..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono font-bold uppercase">
                                <button id="submitReferralCode" class="w-full btn-primary">
                                    🎁 Aplicar Código (Ganhe 50 Kz!)
                                </button>
                            </div>
                            <div id="referralCodeStatus" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Overlay -->
    <div id="historyOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">📋</div>
                        <h2 class="text-xl font-bold">Histórico de Atividades</h2>
                    </div>
                    <button onclick="closeOverlay('historyOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2"></span>
                            Transferências Realizadas
                        </h3>
                        <button onclick="loadHistoryData()" class="btn-secondary text-sm">
                             Atualizar
                        </button>
                    </div>
                    <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- History items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Overlay -->
    <div id="notificationsOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🔔</div>
                        <h2 class="text-xl font-bold">Central de Notificações</h2>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                    <button onclick="closeOverlay('notificationsOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2"></span>
                            
                        </h3>
                        <div class="flex space-x-2">
                            <button id="markAllAsRead" class="btn-secondary text-sm">
                                 Marcar todas como lidas
                            </button>
                            <button id="deleteAllNotifications" class="btn-danger text-sm">
                                 Apagar todas
                            </button>
                        </div>
                    </div>
                    <div id="notificationsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Overlay -->
    <div id="leaderboardOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🏆</div>
                        <h2 class="text-xl font-bold">Ranking de Usuários</h2>
                    </div>
                    <button onclick="closeOverlay('leaderboardOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2">🥇</span>
                            Top 10 Maiores Ganhos
                        </h3>
                        <button onclick="loadLeaderboardData()" class="btn-secondary text-sm">
                            🔄 Atualizar
                        </button>
                    </div>
                    <div id="leaderboardList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Leaderboard items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">💳</span>
                Solicitar Levantamento
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor disponível:</label>
                    <p id="availableAmount" class="text-2xl font-bold text-green-500">0,00 Kz</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor a levantar:</label>
                    <input type="number" id="withdrawAmount" min="500" step="0.01" placeholder="Mín: 500,00 Kz" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Método de pagamento:</label>
                    <select id="paymentMethod" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Selecione...</option>
                        <option value="multicaixa">Multicaixa Express</option>
                        <option value="unitel">Unitel Money</option>
                        <option value="afrimoney">Afrimoney</option>
                        <option value="banco">Transferência Bancária</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número/Conta:</label>
                    <input type="text" id="paymentDetails" placeholder="Digite o número..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="withdrawCancel" class="btn-secondary">Cancelar</button>
                <button id="withdrawConfirm" class="btn-primary">Solicitar</button>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">💸</span>
                Transferir Prémios
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Para quem:</label>
                    <select id="transferUserSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Escolha um usuário...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor:</label>
                    <input type="number" id="transferAmount" min="1" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Máximo: <span id="maxTransferAmount">0,00 Kz</span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PIN de Segurança:</label>
                    <input type="password" id="transferPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="transferCancel" class="btn-secondary">Cancelar</button>
                <button id="transferConfirm" class="btn-primary">Transferir</button>
            </div>
        </div>
    </div>

    <!-- PIN Setup Modal -->
    <div id="pinSetupModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">🔐</span>
                Configurar PIN de Segurança
            </h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Defina um PIN de 6 dígitos para proteger suas transferências.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Novo PIN:</label>
                    <input type="password" id="newPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar PIN:</label>
                    <input type="password" id="confirmPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="pinSetupCancel" class="btn-secondary">Depois</button>
                <button id="pinSetupConfirm" class="btn-primary">Definir PIN</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">⚠️</span>
                Confirmar Ação
            </h3>
            <p id="deleteConfirmMessage" class="text-gray-600 dark:text-gray-400 mb-6">Tem certeza que quer apagar esta notificação?</p>
            <div class="flex justify-end space-x-3">
                <button id="deleteCancel" class="btn-secondary">Cancelar</button>
                <button id="deleteConfirm" class="btn-danger">Apagar</button>
            </div>
        </div>
    </div>

    <!-- Firebase and App Scripts -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, serverTimestamp, update, push, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCE_vGty5XsV1YqdCi49Ck2xJDSFq284wc",
            authDomain: "cliente-movicel.firebaseapp.com",
            databaseURL: "https://cliente-movicel-default-rtdb.firebaseio.com",
            projectId: "cliente-movicel",
            storageBucket: "cliente-movicel.firebasestorage.app",
            messagingSenderId: "215414688375",
            appId: "1:215414688375:web:2c7d20a0c03c4c0fcfd472",
            measurementId: "G-7F1RGP9GHV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // App constants
        const DAILY_LIMIT_MS = 5 * 60 * 60 * 1000; // 5 hours
        const REWARD_RATE = 40; // 40 Kz per hour
        const AUTO_SAVE_INTERVAL = 10 * 1000; // MELHORIA: Reduzido para 10 segundos
        const SYNC_CHECK_INTERVAL = 5 * 1000; // MELHORIA: Verificar sincronização a cada 5 segundos
        const MIN_WITHDRAWAL = 50;
        const REFERRAL_BONUS = 50;

        // App state
        let currentUser = null;
        let isTimerActive = false;
        let timerInterval = null;
        let autoSaveInterval = null;
        let syncCheckInterval = null; // MELHORIA: Intervalo de sincronização
        let sessionStartTime = null;
        let allUsers = [];
        let userPin = null;
        let transferEnabled = true;
        let userReferralCode = null;
        let userNotifications = [];
        let notificationListener = null;
        let userDataListener = null; // MELHORIA: Listener para dados do usuário
        let lastKnownBalance = 0; // MELHORIA: Para detectar mudanças no saldo

        // User data
        let userData = {
            todayTime: 0,
            totalRewards: 0,
            lastActiveTime: null,
            pendingWithdrawal: null,
            lastTransferDate: null,
            lastSaveDate: getTodayKey()
        };

        // MELHORIA: Sistema de sincronização
        let syncStatus = {
            isOnline: true,
            lastSync: null,
            syncError: false
        };

        // Utility functions
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function formatTime(milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-AO', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' Kz';
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString('pt-AO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function calculateRewards(timeMs) {
            const hours = timeMs / (1000 * 60 * 60);
            return Math.floor(hours * REWARD_RATE * 100) / 100;
        }

        function hashPin(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // MELHORIA: Função para atualizar indicadores de sincronização
        function updateSyncIndicator(status = 'synced', error = null) {
            const syncIndicator = document.getElementById('syncIndicator');
            const syncStatusEl = document.getElementById('syncStatus');
            
            syncIndicator.classList.remove('syncing', 'error');
            
            switch (status) {
                case 'syncing':
                    syncIndicator.classList.add('syncing');
                    syncStatusEl.title = 'Sincronizando...';
                    break;
                case 'error':
                    syncIndicator.classList.add('error');
                    syncStatusEl.title = error || 'Erro de sincronização';
                    syncStatus.syncError = true;
                    break;
                default:
                    syncStatusEl.title = 'Sincronizado';
                    syncStatus.syncError = false;
                    syncStatus.lastSync = new Date();
            }
        }

        // MELHORIA: Sistema de sincronização automática
        function startSyncCheck() {
            syncCheckInterval = setInterval(async () => {
                if (!currentUser || !syncStatus.isOnline) return;
                
                try {
                    updateSyncIndicator('syncing');
                    await checkForBalanceUpdates();
                    updateSyncIndicator('synced');
                } catch (error) {
                    console.error('Sync check error:', error);
                    updateSyncIndicator('error', 'Falha na sincronização');
                }
            }, SYNC_CHECK_INTERVAL);
        }

        function stopSyncCheck() {
            if (syncCheckInterval) {
                clearInterval(syncCheckInterval);
                syncCheckInterval = null;
            }
        }

        // MELHORIA: Verificar atualizações de saldo em tempo real
        async function checkForBalanceUpdates() {
            if (!currentUser) return;
            
            try {
                const userRef = ref(database, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const serverData = snapshot.val();
                    const serverBalance = serverData.totalRewards || 0;
                    
                    // MELHORIA: Detectar se houve mudança no saldo
                    if (serverBalance !== lastKnownBalance && lastKnownBalance > 0) {
                        const difference = serverBalance - lastKnownBalance;
                        
                        if (difference > 0) {
                            // Recebeu transferência
                            userData.totalRewards = serverBalance;
                            lastKnownBalance = serverBalance;
                            
                            showBalanceUpdateAnimation();
                            showNotification(`💰 Você recebeu ${formatCurrency(difference)}! Saldo atualizado.`, 'success', 5000);
                            updateDisplay();
                            
                            // Adicionar notificação de transferência recebida
                            await addNotificationToUser(currentUser.uid, {
                                message: `💰 Transferência recebida: ${formatCurrency(difference)}`,
                                type: 'money',
                                timestamp: Date.now(),
                                read: false
                            });
                        }
                    } else if (lastKnownBalance === 0) {
                        // Primeira carga
                        lastKnownBalance = serverBalance;
                    }
                }
            } catch (error) {
                console.error('Error checking balance updates:', error);
                throw error;
            }
        }

        // MELHORIA: Animação para atualização de saldo
        function showBalanceUpdateAnimation() {
            const elements = ['todayRewards', 'totalRewards'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('balance-update');
                    setTimeout(() => el.classList.remove('balance-update'), 1500);
                }
            });
        }

        // MELHORIA: Listener em tempo real para dados do usuário
        function startUserDataListener() {
            if (!currentUser || userDataListener) return;
            
            const userRef = ref(database, `users/${currentUser.uid}`);
            userDataListener = onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const serverData = snapshot.val();
                    const serverBalance = serverData.totalRewards || 0;
                    
                    // MELHORIA: Atualizar automaticamente se houve mudança externa
                    if (serverBalance !== userData.totalRewards && serverBalance !== lastKnownBalance) {
                        const difference = serverBalance - userData.totalRewards;
                        userData.totalRewards = serverBalance;
                        lastKnownBalance = serverBalance;
                        
                        if (difference !== 0) {
                            showBalanceUpdateAnimation();
                            if (difference > 0) {
                                showNotification(`💰 Saldo atualizado! +${formatCurrency(difference)}`, 'success');
                            }
                            updateDisplay();
                        }
                    }
                }
            }, (error) => {
                console.error('User data listener error:', error);
                updateSyncIndicator('error', 'Erro ao monitorar dados');
            });
        }

        function stopUserDataListener() {
            if (userDataListener) {
                userDataListener();
                userDataListener = null;
            }
        }

        // MELHORIA: Sincronização manual com feedback melhorado
        async function performManualSync() {
            if (!currentUser) return;
            
            const syncBtn = document.getElementById('manualSyncBtn');
            syncBtn.classList.add('loading');
            updateSyncIndicator('syncing');
            
            try {
                await checkForBalanceUpdates();
                await loadNotificationsData();
                
                updateSyncIndicator('synced');
                showNotification('✅ Sincronização concluída com sucesso!', 'success', 3000);
                
            } catch (error) {
                console.error('Manual sync error:', error);
                updateSyncIndicator('error', 'Erro na sincronização manual');
                showNotification('❌ Erro na sincronização. Tente novamente.', 'error');
            } finally {
                syncBtn.classList.remove('loading');
            }
        }

        // Make overlay functions global
        window.openOverlay = function(overlayId) {
            document.getElementById(overlayId).classList.add('show');
            
            // Load data when opening specific overlays
            if (overlayId === 'historyOverlay') {
                loadHistoryData();
            } else if (overlayId === 'leaderboardOverlay') {
                loadLeaderboardData();
            } else if (overlayId === 'notificationsOverlay') {
                loadNotificationsData();
            }
        }

        window.closeOverlay = function(overlayId) {
            document.getElementById(overlayId).classList.remove('show');
        }

        // Close overlays when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('overlay-modal')) {
                event.target.classList.remove('show');
            }
        });

        // Notification system
        function showNotification(message, type = 'success', duration = 4000) {
            const container = document.getElementById('notificationContainer');
            
            const colors = {
                success: '#10B981',
                error: '#EF4444',
                warning: '#F59E0B',
                info: '#3B82F6'
            };

            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.background = colors[type];
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 font-bold">×</button>
                </div>
            `;

            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // Custom modal dialogs
        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('deleteConfirmModal');
            const messageEl = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('deleteConfirm');
            
            messageEl.textContent = message;
            
            // Remove previous listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideModal('deleteConfirmModal');
            });
            
            showModal('deleteConfirmModal');
        }

        // Save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // MELHORIA: Função para adicionar notificação a um usuário
        async function addNotificationToUser(userId, notification) {
            try {
                const notificationsRef = ref(database, `notifications/${userId}`);
                await push(notificationsRef, notification);
            } catch (error) {
                console.error('Error adding notification:', error);
            }
        }

        // Data functions - mantendo sua lógica original mas com melhorias de sincronização
        async function saveUserData() {
            if (!currentUser) return;
            
            const today = getTodayKey();
            const userRef = ref(database, `users/${currentUser.uid}`);
            
            try {
                updateSyncIndicator('syncing');
                
                const saveData = {
                    name: currentUser.displayName,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    totalRewards: userData.totalRewards || 0,
                    todayTime: userData.todayTime || 0,
                    lastActiveTime: userData.lastActiveTime || Date.now(),
                    lastSaveDate: today,
                    lastUpdate: serverTimestamp(),
                    pin: userPin || null,
                    transferEnabled: transferEnabled !== false,
                    referralCode: userReferralCode || null,
                    lastTransferDate: userData.lastTransferDate || null,
                    pendingWithdrawal: userData.pendingWithdrawal || null,
                    accountStatus: 'active',
                    isDataPersistent: true
                };
                
                await set(userRef, saveData);
                lastKnownBalance = userData.totalRewards; // MELHORIA: Atualizar saldo conhecido
                updateSyncIndicator('synced');
                showSaveIndicator();
                
            } catch (error) {
                console.error('Error saving user data:', error);
                updateSyncIndicator('error', 'Erro ao salvar');
                showNotification('Erro ao salvar dados - tentando novamente...', 'warning');
                setTimeout(() => saveUserData(), 2000);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            const userRef = ref(database, `users/${currentUser.uid}`);
            
            try {
                updateSyncIndicator('syncing');
                
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const today = getTodayKey();
                    
                    userPin = data.pin || null;
                    transferEnabled = data.transferEnabled !== false;
                    userReferralCode = data.referralCode;
                    userData.totalRewards = data.totalRewards || 0;
                    userData.lastSaveDate = data.lastSaveDate;
                    userData.lastTransferDate = data.lastTransferDate;
                    userData.pendingWithdrawal = data.pendingWithdrawal || null;
                    
                    // MELHORIA: Definir saldo conhecido inicial
                    lastKnownBalance = userData.totalRewards;
                    
                    if (data.lastSaveDate === today) {
                        userData.todayTime = data.todayTime || 0;
                    } else {
                        userData.todayTime = 0;
                    }
                    
                    userData.lastActiveTime = data.lastActiveTime;
                } else {
                    userData = {
                        todayTime: 0,
                        totalRewards: 0,
                        lastActiveTime: Date.now(),
                        pendingWithdrawal: null,
                        lastTransferDate: null,
                        lastSaveDate: getTodayKey()
                    };
                    transferEnabled = true;
                    lastKnownBalance = 0; // MELHORIA: Inicializar saldo conhecido
                    await saveUserData();
                }
                
                updateDisplay();
                updateSyncIndicator('synced');
                
                if (!userPin) {
                    setTimeout(() => {
                        showNotification('Configure um PIN para proteger suas transferências! 🔐', 'info', 8000);
                    }, 3000);
                }

                if (!userReferralCode) {
                    await createUserReferralCode();
                } else {
                    updateReferralDisplay();
                }

                await loadUserReferrals();
                
                // MELHORIA: Iniciar listeners após carregar dados
                startUserDataListener();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                updateSyncIndicator('error', 'Erro ao carregar dados');
                showNotification('Erro ao carregar dados do usuário', 'error');
            }
        }

        // Notifications functions - mantendo sua lógica original
        async function loadNotificationsData() {
            if (!currentUser) return;

            try {
                const notificationsRef = ref(database, `notifications/${currentUser.uid}`);
                const snapshot = await get(notificationsRef);
                
                userNotifications = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        userNotifications.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }

                userNotifications.sort((a, b) => b.timestamp - a.timestamp);
                updateNotificationsDisplay();
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function updateNotificationsDisplay() {
            const container = document.getElementById('notificationsList');
            const badge = document.getElementById('notificationBadge');
            const quickNavBadge = document.getElementById('quickNavNotificationBadge');
            
            container.innerHTML = '';

            if (userNotifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <div class="text-4xl mb-2">🔔</div>
                        <p>Nenhuma notificação ainda</p>
                        <p class="text-sm mt-2">Suas notificações aparecerão aqui</p>
                    </div>
                `;
                badge.classList.add('hidden');
                quickNavBadge.classList.add('hidden');
                return;
            }

            const unreadCount = userNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
                quickNavBadge.textContent = unreadCount;
                quickNavBadge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                quickNavBadge.classList.add('hidden');
            }

            userNotifications.forEach(notification => {
                const div = document.createElement('div');
                div.className = `notification-item ${notification.read ? '' : 'unread'}`;
                
                const typeIcon = getNotificationIcon(notification.type);
                
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">${typeIcon}</div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-white">
                                    ${notification.message}
                                </div>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${formatDate(notification.timestamp)}
                                </div>
                                ${!notification.read ? '<span class="inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded-full mt-2">Nova</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        ${!notification.read ? `<button onclick="markNotificationAsRead('${notification.id}')" class="text-blue-500 hover:text-blue-700 text-sm font-medium">Marcar como lida</button>` : ''}
                        <button onclick="deleteNotification('${notification.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function getNotificationIcon(type) {
            const icons = {
                success: '✅',
                warning: '⚠️',
                error: '❌',
                info: 'ℹ️',
                money: '💰',
                gift: '🎁',
                system: '⚙️'
            };
            return icons[type] || '📢';
        }

        // Make functions global for onclick handlers
        window.markNotificationAsRead = async function(notificationId) {
            if (!currentUser) return;
            
            try {
                const notificationRef = ref(database, `notifications/${currentUser.uid}/${notificationId}`);
                await update(notificationRef, { read: true });
                
                const notification = userNotifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                }
                
                updateNotificationsDisplay();
                showNotification('Notificação marcada como lida', 'success', 2000);
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showNotification('Erro ao marcar como lida', 'error');
            }
        }

        window.deleteNotification = function(notificationId) {
            showConfirmDialog('Tem certeza que quer apagar esta notificação?', async () => {
                if (!currentUser) return;
                
                try {
                    const notificationRef = ref(database, `notifications/${currentUser.uid}/${notificationId}`);
                    await remove(notificationRef);
                    
                    userNotifications = userNotifications.filter(n => n.id !== notificationId);
                    updateNotificationsDisplay();
                    
                    showNotification('Notificação apagada', 'success', 2000);
                    
                } catch (error) {
                    console.error('Error deleting notification:', error);
                    showNotification('Erro ao apagar notificação', 'error');
                }
            });
        }

        async function markAllNotificationsAsRead() {
            if (!currentUser || userNotifications.length === 0) return;
            
            try {
                const updates = {};
                userNotifications.forEach(notification => {
                    if (!notification.read) {
                        updates[`notifications/${currentUser.uid}/${notification.id}/read`] = true;
                        notification.read = true;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await update(ref(database), updates);
                    updateNotificationsDisplay();
                    showNotification('Todas as notificações foram marcadas como lidas', 'success');
                } else {
                    showNotification('Não há notificações não lidas', 'info');
                }
                
            } catch (error) {
                console.error('Error marking all as read:', error);
                showNotification('Erro ao marcar todas como lidas', 'error');
            }
        }

        async function deleteAllNotifications() {
            if (!currentUser || userNotifications.length === 0) {
                showNotification('Não há notificações para apagar', 'info');
                return;
            }

            showConfirmDialog(`Tem certeza que quer apagar todas as ${userNotifications.length} notificações?`, async () => {
                try {
                    const notificationsRef = ref(database, `notifications/${currentUser.uid}`);
                    await remove(notificationsRef);
                    
                    userNotifications = [];
                    updateNotificationsDisplay();
                    
                    showNotification('Todas as notificações foram apagadas', 'success');
                    
                } catch (error) {
                    console.error('Error deleting all notifications:', error);
                    showNotification('Erro ao apagar notificações', 'error');
                }
            });
        }

        function startNotificationListener() {
            if (!currentUser || notificationListener) return;
            
            const notificationsRef = ref(database, `notifications/${currentUser.uid}`);
            notificationListener = onValue(notificationsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const newNotifications = [];
                    snapshot.forEach(child => {
                        newNotifications.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                    
                    const oldIds = userNotifications.map(n => n.id);
                    const newOnes = newNotifications.filter(n => !oldIds.includes(n.id));
                    
                    if (newOnes.length > 0 && userNotifications.length > 0) {
                        newOnes.forEach(notification => {
                            showNotification(`Nova notificação: ${notification.message}`, 'info', 5000);
                        });
                    }
                    
                    userNotifications = newNotifications.sort((a, b) => b.timestamp - a.timestamp);
                    updateNotificationsDisplay();
                }
            });
        }

        function stopNotificationListener() {
            if (notificationListener) {
                notificationListener();
                notificationListener = null;
            }
        }

        // Timer functions - mantendo sua lógica original
        function startTimer() {
            if (isTimerActive) return;
            
            isTimerActive = true;
            sessionStartTime = Date.now();
            userData.lastActiveTime = Date.now();
            
            document.getElementById('timerStatus').className = 'status-indicator status-active';
            document.getElementById('timerStatusIndicator').className = 'status-indicator status-active';
            timerInterval = setInterval(updateTimer, 1000);
            
            startAutoSave();
            showNotification('Timer iniciado! Comece a ganhar dinheiro! 💰', 'success');
        }

        function stopTimer() {
            if (!isTimerActive) return;
            
            const now = Date.now();
            if (sessionStartTime) {
                const sessionDuration = now - sessionStartTime;
                userData.todayTime += sessionDuration;
                sessionStartTime = null;
            }
            
            isTimerActive = false;
            userData.lastActiveTime = now;
            
            document.getElementById('timerStatus').className = 'status-indicator status-inactive';
            document.getElementById('timerStatusIndicator').className = 'status-indicator status-inactive';
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            saveUserData();
            showNotification('Timer pausado! Dados salvos automaticamente 💾', 'info');
        }

        function updateTimer() {
            if (!isTimerActive || !sessionStartTime) return;
            
            const now = Date.now();
            const currentSessionTime = now - sessionStartTime;
            const totalTodayTime = userData.todayTime + currentSessionTime;
            
            if (totalTodayTime >= DAILY_LIMIT_MS) {
                userData.todayTime = DAILY_LIMIT_MS;
                stopTimer();
                showNotification('🎉 Parabéns! Você atingiu o limite diário de 5 horas!', 'success', 6000);
                return;
            }
            
            updateDisplay();
        }

        function updateDisplay() {
            const now = Date.now();
            const currentSessionTime = isTimerActive && sessionStartTime ? now - sessionStartTime : 0;
            const totalTodayTime = userData.todayTime + currentSessionTime;
            
            document.getElementById('todayTime').textContent = formatTime(totalTodayTime);
            document.getElementById('sessionTime').textContent = formatTime(currentSessionTime);
            
            const progressPercent = (totalTodayTime / DAILY_LIMIT_MS) * 100;
            const timerCircle = document.getElementById('timerCircle');
            timerCircle.style.setProperty('--progress', `${Math.min(progressPercent, 100)}%`);
            
            document.getElementById('timeProgress').textContent = `${Math.min(progressPercent, 100).toFixed(1)}%`;
            document.getElementById('timeProgressBar').style.width = `${Math.min(progressPercent, 100)}%`;
            
            const todayRewards = calculateRewards(totalTodayTime);
            const totalAvailable = userData.totalRewards + todayRewards;
            
            document.getElementById('todayRewards').textContent = formatCurrency(todayRewards);
            document.getElementById('totalRewards').textContent = formatCurrency(totalAvailable);
            document.getElementById('todayEarnings').textContent = formatCurrency(todayRewards);
            document.getElementById('availableEarnings').textContent = formatCurrency(totalAvailable);
            document.getElementById('totalEarningsDisplay').textContent = formatCurrency(totalAvailable);
            document.getElementById('availableAmount').textContent = formatCurrency(totalAvailable);
            document.getElementById('maxTransferAmount').textContent = formatCurrency(totalAvailable);
            
            document.getElementById('userStatus').textContent = isTimerActive ? 'Trabalhando' : 'Pausado';
            document.getElementById('userStatus').className = `font-medium ${isTimerActive ? 'text-green-500' : 'text-gray-500'}`;
            document.getElementById('transferStatus').textContent = transferEnabled ? 'Habilitado' : 'Desabilitado';
            document.getElementById('transferStatus').className = `font-medium ${transferEnabled ? 'text-green-500' : 'text-red-500'}`;
            
            updatePendingDisplay();
        }

        function updatePendingDisplay() {
            const pendingInfo = document.getElementById('pendingInfo');
            
            if (userData.pendingWithdrawal) {
                pendingInfo.innerHTML = `
                    <div class="text-center">
                        <div class="text-3xl mb-2">⏳</div>
                        <div class="text-lg font-bold text-orange-500 mb-2">${formatCurrency(userData.pendingWithdrawal.amount)}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Levantamento pendente</div>
                        <div class="text-xs text-gray-500 mt-1">Aguardando aprovação</div>
                    </div>
                `;
            } else {
                pendingInfo.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                        <div class="text-3xl mb-2">✅</div>
                        <p>Nenhum pedido pendente</p>
                    </div>
                `;
            }
        }

        // Auto-save system - melhorado
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => {
                if (currentUser) {
                    saveUserData();
                    if (isTimerActive) {
                        showSaveIndicator();
                    }
                }
            }, AUTO_SAVE_INTERVAL);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        // Referral functions - mantendo sua lógica original
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function createUserReferralCode() {
            if (!currentUser) return;

            try {
                const userRef = ref(database, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.referralCode) {
                        userReferralCode = userData.referralCode;
                        updateReferralDisplay();
                        return;
                    }
                }

                let code;
                let isUnique = false;
                
                while (!isUnique) {
                    code = generateReferralCode();
                    const codeRef = ref(database, `referralCodes/${code}`);
                    const codeSnapshot = await get(codeRef);
                    isUnique = !codeSnapshot.exists();
                }

                const codeRef = ref(database, `referralCodes/${code}`);
                await set(codeRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    createdAt: Date.now()
                });

                await update(userRef, {
                    referralCode: code
                });

                userReferralCode = code;
                updateReferralDisplay();

            } catch (error) {
                console.error('Error creating referral code:', error);
            }
        }

        function updateReferralDisplay() {
            const codeEl = document.getElementById('userReferralCode');
            if (codeEl && userReferralCode) {
                codeEl.textContent = userReferralCode;
            }
        }

        async function processReferralCode(code) {
            if (!code || !currentUser) return;

            code = code.trim().toUpperCase();
            
            if (code.length !== 6) {
                showReferralStatus('Código deve ter 6 caracteres.', 'error');
                return;
            }

            try {
                const codeRef = ref(database, `referralCodes/${code}`);
                const snapshot = await get(codeRef);
                
                if (!snapshot.exists()) {
                    showReferralStatus('Código inválido.', 'error');
                    return;
                }

                const codeData = snapshot.val();
                if (codeData.userId === currentUser.uid) {
                    showReferralStatus('Não pode usar seu próprio código.', 'error');
                    return;
                }

                const userRef = ref(database, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                if (userSnapshot.exists() && userSnapshot.val().usedReferralCode) {
                    showReferralStatus('Você já usou um código.', 'warning');
                    return;
                }

                const pendingRef = ref(database, 'pendingReferrals');
                await push(pendingRef, {
                    referrerUserId: codeData.userId,
                    referrerName: codeData.userName,
                    newUserId: currentUser.uid,
                    newUserName: currentUser.displayName,
                    newUserEmail: currentUser.email,
                    code: code,
                    timestamp: Date.now(),
                    status: 'pending'
                });

                await update(userRef, {
                    usedReferralCode: code,
                    referredBy: codeData.userId
                });

                showReferralStatus('Código aplicado! Aguardando aprovação.', 'success');
                document.getElementById('newReferralCodeInput').value = '';

            } catch (error) {
                console.error('Error processing referral:', error);
                showReferralStatus('Erro ao processar código.', 'error');
            }
        }

        function showReferralStatus(message, type) {
            const statusEl = document.getElementById('referralCodeStatus');
            const colors = {
                success: 'bg-green-50 dark:bg-green-900/20 border-green-200 text-green-800',
                error: 'bg-red-50 dark:bg-red-900/20 border-red-200 text-red-800',
                warning: 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 text-yellow-800'
            };

            statusEl.className = `mt-3 p-3 border rounded-lg ${colors[type]}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');

            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        async function loadUserReferrals() {
            if (!currentUser) return;

            try {
                const referralsRef = ref(database, 'confirmedReferrals');
                const snapshot = await get(referralsRef);
                
                let confirmed = 0;
                let bonus = 0;

                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const referral = child.val();
                        if (referral.referrerUserId === currentUser.uid) {
                            confirmed++;
                            bonus += REFERRAL_BONUS;
                        }
                    });
                }

                const pendingRef = ref(database, 'pendingReferrals');
                const pendingSnapshot = await get(pendingRef);
                
                let pending = 0;
                if (pendingSnapshot.exists()) {
                    pendingSnapshot.forEach(child => {
                        const referral = child.val();
                        if (referral.referrerUserId === currentUser.uid && referral.status === 'pending') {
                            pending++;
                        }
                    });
                }

                document.getElementById('confirmedReferrals').textContent = confirmed;
                document.getElementById('pendingReferrals').textContent = pending;
                document.getElementById('referralBonus').textContent = formatCurrency(bonus);

            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        // Load other users for transfer
        async function loadUsers() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                allUsers = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        if (child.key !== currentUser?.uid) {
                            allUsers.push({
                                id: child.key,
                                ...child.val()
                            });
                        }
                    });
                }

                updateTransferUserOptions();

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function updateTransferUserOptions() {
            const select = document.getElementById('transferUserSelect');
            select.innerHTML = '<option value="">Escolha um usuário...</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                select.appendChild(option);
            });
        }

        // History and leaderboard - mantendo sua lógica original
        window.loadHistoryData = async function() {
            if (!currentUser) return;
            
            try {
                const historyRef = ref(database, `transferHistory/${currentUser.uid}`);
                const snapshot = await get(historyRef);
                
                const history = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        history.push(child.val());
                    });
                }

                history.sort((a, b) => b.timestamp - a.timestamp);
                
                const container = document.getElementById('historyList');
                container.innerHTML = '';

                if (history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📋</div>
                            <p>Nenhuma atividade ainda</p>
                            <p class="text-sm mt-2">Suas transferências aparecerão aqui</p>
                        </div>
                    `;
                    return;
                }

                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    const typeText = item.type === 'sent' ? 'Enviado para' : 'Recebido de';
                    const typeColor = item.type === 'sent' ? 'text-red-500' : 'text-green-500';
                    const typeIcon = item.type === 'sent' ? '📤' : '📥';
                    const otherUser = item.type === 'sent' ? item.toName : item.fromName;
                    
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-lg">${typeIcon}</span>
                                <div class="font-medium text-gray-900 dark:text-white">${typeText} ${otherUser}</div>
                            </div>
                            <div class="text-sm text-gray-500 ml-7">${formatDate(item.timestamp)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${typeColor} text-lg">${formatCurrency(item.amount)}</div>
                            <div class="text-xs text-gray-500">Concluído ✅</div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });

            } catch (error) {
                console.error('Error loading history:', error);
                showNotification('Erro ao carregar histórico', 'error');
            }
        }

        window.loadLeaderboardData = async function() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                const users = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        users.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }

                users.sort((a, b) => (b.totalRewards || 0) - (a.totalRewards || 0));
                
                const container = document.getElementById('leaderboardList');
                container.innerHTML = '';

                if (users.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">🏆</div>
                            <p>Nenhum usuário ainda</p>
                        </div>
                    `;
                    return;
                }

                users.slice(0, 10).forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-row';
                    
                    if (user.id === currentUser?.uid) {
                        div.style.background = 'linear-gradient(135deg, #DBEAFE 0%, #93C5FD 100%)';
                        div.style.borderLeft = '4px solid #3B82F6';
                    }
                    
                    const medals = ['🥇', '🥈', '🥉'];
                    const position = index < 3 ? medals[index] : `${index + 1}º`;
                    
                    div.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="text-2xl mr-4 font-bold">${position}</div>
                            <img class="w-12 h-12 rounded-full mr-3 border-2 border-gray-200" src="${user.photoURL}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"48\" height=\"48\" fill=\"%23999\" viewBox=\"0 0 24 24\"><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\"/></svg>'">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-white flex items-center">
                                    ${user.name} 
                                    ${user.id === currentUser?.uid ? '<span class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full">Você</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-500">
                                    Tempo hoje: ${formatTime(user.todayTime || 0)}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-primary text-lg">${formatCurrency(user.totalRewards || 0)}</div>
                            <div class="text-xs text-gray-500">Total ganho</div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showNotification('Erro ao carregar ranking', 'error');
            }
        }

        // Withdrawal functions - mantendo sua lógica original mas com melhorias de feedback
        async function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const details = document.getElementById('paymentDetails').value.trim();
            
            if (!amount || isNaN(amount) || amount <= 0) {
                showNotification('Digite um valor válido!', 'error');
                return;
            }
            
            if (amount < MIN_WITHDRAWAL) {
                showNotification(`Valor mínimo: ${formatCurrency(MIN_WITHDRAWAL)}`, 'error');
                return;
            }
            
            if (!method) {
                showNotification('Selecione um método de pagamento!', 'error');
                return;
            }
            
            if (!details || details.length < 5) {
                showNotification('Digite um número/conta válido!', 'error');
                return;
            }
            
            const currentSessionTime = isTimerActive && sessionStartTime ? Date.now() - sessionStartTime : 0;
            const todayRewards = calculateRewards(userData.todayTime + currentSessionTime);
            const totalAvailable = userData.totalRewards + todayRewards;
            
            if (amount > totalAvailable) {
                showNotification(`Valor insuficiente! Disponível: ${formatCurrency(totalAvailable)}`, 'error');
                return;
            }

            if (userData.pendingWithdrawal) {
                showNotification('Você já tem um levantamento pendente!', 'warning');
                return;
            }

            try {
                const methodNames = {
                    'multicaixa': 'Multicaixa Express',
                    'unitel': 'Unitel Money',
                    'afrimoney': 'Afrimoney',
                    'banco': 'Transferência Bancária'
                };

                const withdrawalData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    amount: amount,
                    paymentMethod: methodNames[method],
                    paymentDetails: details,
                    status: 'pending',
                    requestDate: Date.now()
                };

                const withdrawalRef = ref(database, 'withdrawalRequests');
                const newWithdrawalRef = await push(withdrawalRef, withdrawalData);

                userData.pendingWithdrawal = {
                    id: newWithdrawalRef.key,
                    amount: amount,
                    timestamp: Date.now()
                };

                const remainingRewards = totalAvailable - amount;
                userData.totalRewards = Math.max(0, remainingRewards);
                userData.todayTime = 0;
                lastKnownBalance = userData.totalRewards; // MELHORIA: Atualizar saldo conhecido

                await saveUserData();
                updateDisplay();
                hideModal('withdrawModal');
                
                showNotification(`✅ Levantamento de ${formatCurrency(amount)} solicitado com sucesso!`, 'success', 6000);
                
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('paymentMethod').value = '';
                document.getElementById('paymentDetails').value = '';
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showNotification('❌ Erro ao solicitar levantamento! Tente novamente.', 'error');
            }
        }

        // Transfer functions - mantendo sua lógica original mas com melhorias de sincronização
        function canTransferToday() {
            const today = getTodayKey();
            return userData.lastTransferDate !== today;
        }

        async function processTransfer() {
            if (!canTransferToday()) {
                showNotification('⏰ Você já transferiu hoje! Tente amanhã.', 'warning');
                return;
            }

            const recipientId = document.getElementById('transferUserSelect').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const pin = document.getElementById('transferPin').value;
            
            if (!recipientId) {
                showNotification('Selecione um usuário para receber a transferência!', 'error');
                return;
            }
            
            if (!amount || isNaN(amount) || amount <= 0) {
                showNotification('Digite um valor válido!', 'error');
                return;
            }
            
            if (!pin || pin.length !== 6) {
                showNotification('Digite o PIN de 6 dígitos!', 'error');
                return;
            }

            if (!userPin) {
                showNotification('Configure seu PIN primeiro!', 'warning');
                showModal('pinSetupModal');
                return;
            }

            if (hashPin(pin) !== userPin) {
                showNotification('❌ PIN incorreto! Tente novamente.', 'error');
                document.getElementById('transferPin').value = '';
                return;
            }

            const currentSessionTime = isTimerActive && sessionStartTime ? Date.now() - sessionStartTime : 0;
            const todayRewards = calculateRewards(userData.todayTime + currentSessionTime);
            const totalAvailable = userData.totalRewards + todayRewards;
            
            if (amount > totalAvailable) {
                showNotification(`❌ Valor insuficiente! Disponível: ${formatCurrency(totalAvailable)}`, 'error');
                return;
            }

            if (!transferEnabled) {
                showNotification('❌ Transferências desabilitadas pelo administrador!', 'error');
                return;
            }

            try {
                const recipient = allUsers.find(user => user.id === recipientId);
                if (!recipient) {
                    showNotification('❌ Usuário destinatário não encontrado!', 'error');
                    return;
                }

                const now = Date.now();
                const today = getTodayKey();
                
                if (sessionStartTime) {
                    const currentSession = now - sessionStartTime;
                    userData.todayTime += currentSession;
                    sessionStartTime = now;
                }
                
                const newSenderTotal = totalAvailable - amount;
                userData.totalRewards = Math.max(0, newSenderTotal);
                userData.todayTime = 0;
                userData.lastTransferDate = today;
                
                const updates = {};
                
                // Update sender
                updates[`users/${currentUser.uid}/totalRewards`] = newSenderTotal;
                updates[`users/${currentUser.uid}/todayTime`] = 0;
                updates[`users/${currentUser.uid}/lastTransferDate`] = today;
                updates[`users/${currentUser.uid}/lastUpdate`] = serverTimestamp();
                
                // Update recipient
                const recipientRef = ref(database, `users/${recipientId}`);
                const recipientSnapshot = await get(recipientRef);
                const recipientData = recipientSnapshot.val() || {};
                const newRecipientTotal = (recipientData.totalRewards || 0) + amount;
                
                updates[`users/${recipientId}/totalRewards`] = newRecipientTotal;
                updates[`users/${recipientId}/lastUpdate`] = serverTimestamp();
                
                // Add transfer history for both users
                const historyData = {
                    from: currentUser.uid,
                    fromName: currentUser.displayName,
                    to: recipientId,
                    toName: recipient.name,
                    amount: amount,
                    timestamp: now
                };
                
                // Sender history
                const senderHistoryRef = push(ref(database, `transferHistory/${currentUser.uid}`));
                updates[`transferHistory/${currentUser.uid}/${senderHistoryRef.key}`] = {
                    ...historyData,
                    type: 'sent'
                };
                
                // Recipient history
                const recipientHistoryRef = push(ref(database, `transferHistory/${recipientId}`));
                updates[`transferHistory/${recipientId}/${recipientHistoryRef.key}`] = {
                    ...historyData,
                    type: 'received'
                };

                // Send notification to recipient
                const recipientNotifRef = push(ref(database, `notifications/${recipientId}`));
                updates[`notifications/${recipientId}/${recipientNotifRef.key}`] = {
                    message: `💰 ${currentUser.displayName} enviou ${formatCurrency(amount)} para você!`,
                    type: 'money',
                    timestamp: now,
                    read: false
                };
                
                // MELHORIA: Executar todas as atualizações atomicamente
                await update(ref(database), updates);
                
                // MELHORIA: Atualizar saldo conhecido local
                lastKnownBalance = newSenderTotal;
                
                updateDisplay();
                hideModal('transferModal');
                
                showNotification(`✅ Transferência de ${formatCurrency(amount)} realizada com sucesso para ${recipient.name}! 🚀`, 'success', 6000);
                
                // Clear form
                document.getElementById('transferUserSelect').value = '';
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferPin').value = '';
                
            } catch (error) {
                console.error('Error processing transfer:', error);
                showNotification('❌ Erro ao processar transferência! Tente novamente.', 'error');
            }
        }

        // PIN functions - mantendo sua lógica original
        async function setupPin() {
            const pin1 = document.getElementById('newPin').value;
            const pin2 = document.getElementById('confirmPin').value;
            
            if (!pin1 || pin1.length !== 6 || !/^\d{6}$/.test(pin1)) {
                showNotification('❌ PIN deve ter exatamente 6 dígitos numéricos!', 'error');
                return;
            }
            
            if (!pin2 || pin1 !== pin2) {
                showNotification('❌ PINs não coincidem! Digite novamente.', 'error');
                return;
            }
            
            try {
                userPin = hashPin(pin1);
                
                const userRef = ref(database, `users/${currentUser.uid}`);
                await update(userRef, {
                    pin: userPin,
                    pinSetupDate: Date.now(),
                    lastUpdate: serverTimestamp()
                });
                
                hideModal('pinSetupModal');
                document.getElementById('newPin').value = '';
                document.getElementById('confirmPin').value = '';
                
                showNotification('✅ PIN configurado e salvo com sucesso! Suas transferências estão protegidas! 🔐', 'success', 5000);
                
            } catch (error) {
                console.error('Error setting up PIN:', error);
                showNotification('❌ Erro ao configurar PIN! Tente novamente.', 'error');
            }
        }

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                const referralCode = document.getElementById('referralCodeInput').value.trim().toUpperCase();
                await signInWithPopup(auth, provider);
                
                if (referralCode) {
                    setTimeout(() => {
                        processReferralCode(referralCode);
                    }, 2000);
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('❌ Erro no login! Tente novamente.', 'error');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                if (isTimerActive) {
                    stopTimer();
                }
                stopAutoSave();
                stopSyncCheck(); // MELHORIA: Parar verificação de sincronização
                stopNotificationListener();
                stopUserDataListener(); // MELHORIA: Parar listener de dados
                await saveUserData();
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // MELHORIA: Event listener para sincronização manual
        document.getElementById('manualSyncBtn').addEventListener('click', performManualSync);

        // Timer click
        document.getElementById('timerCircle').addEventListener('click', () => {
            if (isTimerActive) {
                stopTimer();
            } else {
                startTimer();
            }
        });

        // Action buttons
        document.getElementById('withdrawBtn').addEventListener('click', () => {
            if (userData.pendingWithdrawal) {
                showNotification('⏳ Você já tem um levantamento pendente!', 'warning');
                return;
            }
            showModal('withdrawModal');
        });

        document.getElementById('transferBtn').addEventListener('click', () => {
            if (!userPin) {
                showNotification('🔐 Configure seu PIN primeiro para proteger as transferências!', 'warning');
                showModal('pinSetupModal');
                return;
            }
            if (!transferEnabled) {
                showNotification('❌ Transferências desabilitadas pelo administrador!', 'error');
                return;
            }
            showModal('transferModal');
        });

        // Modal buttons
        document.getElementById('withdrawCancel').addEventListener('click', () => hideModal('withdrawModal'));
        document.getElementById('withdrawConfirm').addEventListener('click', processWithdrawal);
        document.getElementById('transferCancel').addEventListener('click', () => hideModal('transferModal'));
        document.getElementById('transferConfirm').addEventListener('click', processTransfer);
        document.getElementById('pinSetupCancel').addEventListener('click', () => hideModal('pinSetupModal'));
        document.getElementById('pinSetupConfirm').addEventListener('click', setupPin);
        document.getElementById('deleteCancel').addEventListener('click', () => hideModal('deleteConfirmModal'));

        // Notification actions
        document.getElementById('markAllAsRead').addEventListener('click', markAllNotificationsAsRead);
        document.getElementById('deleteAllNotifications').addEventListener('click', deleteAllNotifications);

        // Referral actions
        document.getElementById('copyReferralCode').addEventListener('click', () => {
            if (userReferralCode) {
                navigator.clipboard.writeText(userReferralCode).then(() => {
                    showNotification('📋 Código copiado para a área de transferência!', 'success');
                });
            }
        });

        document.getElementById('submitReferralCode').addEventListener('click', () => {
            const code = document.getElementById('newReferralCodeInput').value.trim();
            if (code) {
                processReferralCode(code);
            }
        });

        // Format inputs
        document.getElementById('referralCodeInput').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        document.getElementById('newReferralCodeInput').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (currentUser) {
                    saveUserData();
                }
            } else if (currentUser) {
                // MELHORIA: Verificar atualizações quando a página voltar a ficar visível
                performManualSync();
            }
        });

        // Before unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                saveUserData();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.overlay-modal.show').forEach(overlay => {
                    overlay.classList.remove('show');
                });
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            loadingScreen.classList.add('hidden');
            
            if (user) {
                currentUser = user;
                
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;
                
                await loadUserData();
                await loadUsers();
                await loadNotificationsData();
                
                // MELHORIA: Iniciar sistemas de monitoramento
                startAutoSave();
                startSyncCheck();
                startNotificationListener();
                
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                showNotification(`🎉 Bem-vindo de volta, ${user.displayName.split(' ')[0]}!`, 'success');
                
            } else {
                currentUser = null;
                if (isTimerActive) {
                    stopTimer();
                }
                stopAutoSave();
                stopSyncCheck(); // MELHORIA: Parar verificação de sincronização
                stopNotificationListener();
                stopUserDataListener(); // MELHORIA: Parar listener de dados
                
                // Reset state
                userData = {
                    todayTime: 0,
                    totalRewards: 0,
                    lastActiveTime: null,
                    pendingWithdrawal: null,
                    lastTransferDate: null,
                    lastSaveDate: getTodayKey()
                };
                userPin = null;
                transferEnabled = true;
                userReferralCode = null;
                userNotifications = [];
                lastKnownBalance = 0; // MELHORIA: Reset saldo conhecido
                
                updateDisplay();
                
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

        // Initial display update
        updateDisplay();
    </script>
</body>
</html>
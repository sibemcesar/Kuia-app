<!DOCTYPE html>
<html lang="pt-AO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuia+ Monetiza - Ganhe Dinheiro</title>
    
    <!-- WebView compatibility -->
    <meta http-equiv="Content-Security-Policy" content="default-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline';">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        kuia: {
                            red: '#CE1126',
                            yellow: '#FFCD00',
                            blue: '#0066CC'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'bounce-subtle': 'bounceSubtle 0.6s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', transform: 'scale(1)' },
                            '50%': { opacity: '0.8', transform: 'scale(1.05)' }
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #0066CC 0%, #5D5CDE 50%, #FFCD00 100%);
        }

        .kuia-logo {
            background: linear-gradient(45deg, #0066CC, #5D5CDE);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .kuia-logo:hover {
            transform: rotate(360deg) scale(1.1);
        }

        .timer-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #5D5CDE var(--progress), #E5E7EB var(--progress));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(93, 92, 222, 0.4);
        }

        .timer-circle:active {
            transform: scale(0.98);
        }

        .timer-inner {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dark .timer-inner {
            background: #1F2937;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .dark .card {
            background: #1F2937;
            border-color: #374151;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(93, 92, 222, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: #5D5CDE;
            border: 2px solid #5D5CDE;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #5D5CDE;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(93, 92, 222, 0.3);
        }

        .dark .btn-secondary {
            background: #1F2937;
            color: #A78BFA;
            border-color: #A78BFA;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-1px);
        }

        .tab-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 2px solid #5D5CDE;
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .tab-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(93, 92, 222, 0.1), transparent);
            transition: left 0.5s;
        }

        .tab-card:hover::before {
            left: 100%;
        }

        .tab-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(93, 92, 222, 0.2);
            border-color: #7C3AED;
        }

        .dark .tab-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%);
            border-color: #A78BFA;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #10B981;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #EF4444;
        }

        .referral-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 3px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 20px;
            border-radius: 12px;
            border: 3px solid #000;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: #10B981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .overlay-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 95vw;
            max-height: 95vh;
            width: 100%;
            height: 100%;
            margin: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .overlay-modal.show .overlay-content {
            transform: scale(1);
        }

        .dark .overlay-content {
            background: #1F2937;
        }

        .overlay-header {
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .overlay-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            margin: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .dark .modal-content {
            background: #1F2937;
        }

        .history-item, .notification-item, .leaderboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin: 8px 0;
            border-radius: 12px;
            background: #F8FAFC;
            border-left: 4px solid #5D5CDE;
            transition: all 0.3s ease;
        }

        .history-item:hover, .notification-item:hover, .leaderboard-row:hover {
            background: #E2E8F0;
            transform: translateX(4px);
        }

        .dark .history-item, .dark .notification-item, .dark .leaderboard-row {
            background: #374151;
        }

        .dark .history-item:hover, .dark .notification-item:hover, .dark .leaderboard-row:hover {
            background: #4B5563;
        }

        .notification-item.unread {
            background: #EFF6FF;
            border-left-color: #3B82F6;
        }

        .dark .notification-item.unread {
            background: rgba(30, 58, 138, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .quick-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .dark .quick-nav {
            background: rgba(31, 41, 55, 0.9);
        }

        .quick-nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5D5CDE 0%, #7C3AED 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .quick-nav-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 4px 20px rgba(93, 92, 222, 0.4);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .overlay-content {
                margin: 10px;
                border-radius: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-nav {
                bottom: 10px;
                padding: 6px;
            }
            
            .quick-nav-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }
    </script>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">
        💾 Dados salvos automaticamente
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="kuia-logo mx-auto mb-4 animate-pulse-glow">K+</div>
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400 text-lg animate-fade-in">Carregando Kuia+ Monetiza...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-40 hidden">
        <div style="display:none;"  class="card max-w-md w-full mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <div class="kuia-logo mx-auto mb-4 animate-bounce-subtle">K+</div>
                <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Kuia+ Monetiza</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Transforme seu tempo em dinheiro</p>
            </div>
            
            <!-- Referral Code Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">🎁 Código de Convite (Opcional):</label>
                <input type="text" id="referralCodeInput" maxlength="6" placeholder="Digite aqui..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono font-bold uppercase">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Ganhe 50 Kz de bônus!</p>
            </div>
            
            <button id="loginBtn" class="w-full btn-primary text-lg">
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header style="display:none;" class="gradient-bg text-white p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="kuia-logo">K+</div>
                    <div>
                        <h1 class="text-xl font-bold">Kuia+ Monetiza</h1>
                        <p class="text-sm opacity-90">Ganhe dinheiro com seu tempo</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="flex items-center space-x-2">
                        <img id="userPhoto" class="w-10 h-10 rounded-full border-2 border-white" src="" alt="Utilizador">
                        <div class="text-right">
                            <div id="userName" class="font-medium"></div>
                            <div class="text-xs opacity-90">Membro</div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>
<script>
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(function() {
                var el = document.getElementById("timerCircle");
                if (el) {
                    el.click();
                    console.log("Clique automático no #timerCircle executado.");
                } else {
                    console.warn("Elemento #timerCircle não encontrado.");
                }
            }, 5000);
        });
        </script>
        
        <main class="max-w-6xl mx-auto p-4 space-y-6 pb-32">
            <!-- Timer Section -->
            <div class="text-center animate-fade-in">
                <div class="timer-circle mx-auto mb-6" id="timerCircle" style="--progress: 0%;">
                    <div class="timer-inner">
                        <div class="flex items-center mb-2">
                            <div id="timerStatus" class="status-indicator status-inactive"></div>
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Status</span>
                        </div>
                        <div id="todayTime" class="text-3xl font-bold text-gray-900 dark:text-white">00:00:00</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Hoje</div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Clique no timer para iniciar/parar</p>
                    <div class="flex items-center justify-center space-x-4">
                        <div class="text-center">
                            <div class="text-lg font-bold text-primary" id="todayRewards">0,00 Kz</div>
                            <div class="text-xs text-gray-500">Ganho Hoje</div>
                        </div>
                        <div class="w-px h-8 bg-gray-300"></div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-500" id="totalRewards">0,00 Kz</div>
                            <div class="text-xs text-gray-500">Total</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-4 animate-slide-up">
                <button id="withdrawBtn" class="btn-primary flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <span>Levantar</span>
                </button>
                <button id="transferBtn" class="btn-secondary flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span>Transferir</span>
                </button>
            </div>

            <!-- Navigation Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 animate-slide-up">
                <!-- Stats Card -->
                <div id="statsCard" class="tab-card cursor-pointer" onclick="openOverlay('statsOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">📊</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Estatísticas</h3>
                    </div>
                </div>

                <!-- Referral Card -->
                <div id="referralCard" class="tab-card cursor-pointer" onclick="openOverlay('referralOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🎁</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Indicações</h3>
                    </div>
                </div>

                <!-- History Card -->
                <div id="historyCard" class="tab-card cursor-pointer" onclick="openOverlay('historyOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">📋</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Histórico</h3>
                    </div>
                </div>

                <!-- Notifications Card -->
                <div id="notificationsCard" class="tab-card cursor-pointer relative" onclick="openOverlay('notificationsOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🔔</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Notificações</h3>
                        <span id="notificationBadge" class="notification-badge hidden">0</span>
                    </div>
                </div>

                <!-- Leaderboard Card -->
                <div style="display:none;" id="leaderboardCard" class="tab-card cursor-pointer col-span-2 md:col-span-1" onclick="openOverlay('leaderboardOverlay')">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🏆</div>
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Ranking</h3>
                    </div>
                </div>
            </div>
        </main>

        <!-- Quick Navigation -->
        <div class="quick-nav">
            <button class="quick-nav-btn" onclick="openOverlay('statsOverlay')" title="Estatísticas">
                📊
            </button>
            <button class="quick-nav-btn" onclick="openOverlay('referralOverlay')" title="Indicações">
                🎁
            </button>
            <button class="quick-nav-btn" onclick="openOverlay('historyOverlay')" title="Histórico">
                📋
            </button>
            <button class="quick-nav-btn relative" onclick="openOverlay('notificationsOverlay')" title="Notificações">
                🔔
                <span id="quickNavNotificationBadge" class="notification-badge hidden">0</span>
            </button>
            <button style="display:none;" class="quick-nav-btn" onclick="openOverlay('leaderboardOverlay')" title="Ranking">
                🏆
            </button>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div id="statsOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">📊</div>
                        <h2 class="text-xl font-bold">Estatísticas</h2>
                    </div>
                    <button onclick="closeOverlay('statsOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="stats-grid">
                    <!-- Progress Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⏱️</span>
                            Progresso Diário
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600 dark:text-gray-400">Tempo Trabalhado</span>
                                    <span id="timeProgress" class="font-medium">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                    <div id="timeProgressBar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">Limite: 5h diárias</div>
                            </div>
                            <div class="pt-2">
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Sessão Atual:</div>
                                <div id="sessionTime" class="text-lg font-bold text-purple-600">00:00:00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">💰</span>
                            Ganhos
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Hoje:</span>
                                <span id="todayEarnings" class="font-bold text-green-500">0,00 Kz</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Disponível:</span>
                                <span id="availableEarnings" class="font-bold text-blue-500">0,00 Kz</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Taxa:</span>
                                <span class="font-medium text-purple-600">40 Kz/hora</span>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between text-lg">
                                <span class="text-gray-900 dark:text-white font-semibold">Total Ganho:</span>
                                <span id="totalEarningsDisplay" class="font-bold text-primary">0,00 Kz</span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⚡</span>
                            Status do Sistema
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Timer:</span>
                                <div class="flex items-center">
                                    <div id="timerStatusIndicator" class="status-indicator status-inactive"></div>
                                    <span id="userStatus" class="font-medium text-gray-500">Pausado</span>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Transferências:</span>
                                <span id="transferStatus" class="font-medium text-green-500">Habilitado</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Conta:</span>
                                <span class="font-medium text-green-500">Ativa</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Última sessão:</span>
                                <span class="font-medium text-gray-700 dark:text-gray-300" id="lastSession">Agora</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">⏳</span>
                            Pedidos Pendentes
                        </h3>
                        <div class="space-y-3">
                            <div id="pendingInfo">
                                <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                    <div class="text-3xl mb-2">✅</div>
                                    <p>Nenhum pedido pendente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Overlay -->
    <div id="referralOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🎁</div>
                        <h2 class="text-xl font-bold">Sistema de Indicações</h2>
                    </div>
                    <button onclick="closeOverlay('referralOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="stats-grid">
                    <!-- My Code Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">🔑</span>
                            Meu Código de Convite
                        </h3>
                        <div class="text-center">
                            <div id="userReferralCode" class="referral-code mb-4">CARREGANDO...</div>
                            <button id="copyReferralCode" class="btn-primary w-full mb-2">
                                📋 Copiar Código
                            </button>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                Compartilhe este código para ganhar bônus!
                            </p>
                        </div>
                    </div>

                    <!-- Referral Stats Card -->
                    <div class="card">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">📈</span>
                            Minhas Indicações
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Confirmadas:</span>
                                <div class="text-center">
                                    <span id="confirmedReferrals" class="font-bold text-green-500 text-lg">0</span>
                                    <div class="text-xs text-gray-500">pessoas</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Pendentes:</span>
                                <div class="text-center">
                                    <span id="pendingReferrals" class="font-bold text-yellow-500 text-lg">0</span>
                                    <div class="text-xs text-gray-500">aguardando</div>
                                </div>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900 dark:text-white font-semibold">Bônus Total:</span>
                                <div class="text-center">
                                    <span id="referralBonus" class="font-bold text-blue-500 text-lg">0,00 Kz</span>
                                    <div class="text-xs text-gray-500">ganho</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Use Code Card -->
                    <div class="card col-span-full">
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <span class="mr-2">💎</span>
                            Usar Código de Convite
                        </h3>
                        <div class="max-w-md mx-auto">
                            <div class="space-y-4">
                                <div class="text-center mb-4">
                                    <div class="text-3xl mb-2">🎯</div>
                                    <p class="text-gray-600 dark:text-gray-400">
                                        Digite um código para ganhar <strong>50 Kz</strong> de bônus!
                                    </p>
                                </div>
                                <input type="text" id="newReferralCodeInput" maxlength="6" placeholder="Digite o código..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono font-bold uppercase">
                                <button id="submitReferralCode" class="w-full btn-primary">
                                    🎁 Aplicar Código (Ganhe 50 Kz!)
                                </button>
                            </div>
                            <div id="referralCodeStatus" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Overlay -->
    <div id="historyOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">📋</div>
                        <h2 class="text-xl font-bold">Histórico de Atividades</h2>
                    </div>
                    <button onclick="closeOverlay('historyOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2">💸</span>
                            Transferências Realizadas
                        </h3>
                        <button onclick="loadHistoryData()" class="btn-secondary text-sm">
                            🔄 Atualizar
                        </button>
                    </div>
                    <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- History items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Overlay -->
    <div id="notificationsOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🔔</div>
                        <h2 class="text-xl font-bold">Central de Notificações</h2>
                    </div>
                    <button onclick="closeOverlay('notificationsOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2">📥</span>
                            Suas Notificações
                        </h3>
                        <div class="flex space-x-2">
                            <button id="markAllAsRead" class="btn-secondary text-sm">
                                ✅ Marcar todas como lidas
                            </button>
                            <button id="deleteAllNotifications" class="btn-danger text-sm">
                                🗑️ Apagar todas
                            </button>
                        </div>
                    </div>
                    <div id="notificationsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Overlay -->
    <div id="leaderboardOverlay" class="overlay-modal">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">🏆</div>
                        <h2 class="text-xl font-bold">Ranking de Usuários</h2>
                    </div>
                    <button onclick="closeOverlay('leaderboardOverlay')" class="text-white hover:text-gray-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overlay-body">
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="mr-2">🥇</span>
                            Top 10 Maiores Ganhos
                        </h3>
                        <button onclick="loadLeaderboardData()" class="btn-secondary text-sm">
                            🔄 Atualizar
                        </button>
                    </div>
                    <div id="leaderboardList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Leaderboard items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">💳</span>
                Solicitar Levantamento
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor disponível:</label>
                    <p id="availableAmount" class="text-2xl font-bold text-green-500">0,00 Kz</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor a levantar:</label>
                    <input type="number" id="withdrawAmount" min="50" step="0.01" placeholder="Mín: 50,00 Kz" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Método de pagamento:</label>
                    <select id="paymentMethod" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Selecione...</option>
                        <option value="multicaixa">Multicaixa Express</option>
                        <option value="unitel">Unitel Money</option>
                        <option value="afrimoney">Afrimoney</option>
                        <option value="banco">Transferência Bancária</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número/Conta:</label>
                    <input type="text" id="paymentDetails" placeholder="Digite o número..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="withdrawCancel" class="btn-secondary">Cancelar</button>
                <button id="withdrawConfirm" class="btn-primary">Solicitar</button>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">💸</span>
                Transferir Prémios
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Para quem:</label>
                    <select id="transferUserSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Escolha um usuário...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor:</label>
                    <input type="number" id="transferAmount" min="1" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Máximo: <span id="maxTransferAmount">0,00 Kz</span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PIN de Segurança:</label>
                    <input type="password" id="transferPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="transferCancel" class="btn-secondary">Cancelar</button>
                <button id="transferConfirm" class="btn-primary">Transferir</button>
            </div>
        </div>
    </div>

    <!-- PIN Setup Modal -->
    <div id="pinSetupModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">🔐</span>
                Configurar PIN de Segurança
            </h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Defina um PIN de 6 dígitos para proteger suas transferências.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Novo PIN:</label>
                    <input type="password" id="newPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar PIN:</label>
                    <input type="password" id="confirmPin" maxlength="6" placeholder="000000" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base text-center font-mono">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="pinSetupCancel" class="btn-secondary">Depois</button>
                <button id="pinSetupConfirm" class="btn-primary">Definir PIN</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <span class="mr-2">⚠️</span>
                Confirmar Ação
            </h3>
            <p id="deleteConfirmMessage" class="text-gray-600 dark:text-gray-400 mb-6">Tem certeza que quer apagar esta notificação?</p>
            <div class="flex justify-end space-x-3">
                <button id="deleteCancel" class="btn-secondary">Cancelar</button>
                <button id="deleteConfirm" class="btn-danger">Apagar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts (ES5 Compatible) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCE_vGty5XsV1YqdCi49Ck2xJDSFq284wc",
            authDomain: "cliente-movicel.firebaseapp.com",
            databaseURL: "https://cliente-movicel-default-rtdb.firebaseio.com",
            projectId: "cliente-movicel",
            storageBucket: "cliente-movicel.firebasestorage.app",
            messagingSenderId: "215414688375",
            appId: "1:215414688375:web:2c7d20a0c03c4c0fcfd472",
            measurementId: "G-7F1RGP9GHV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var database = firebase.database();
        var provider = new firebase.auth.GoogleAuthProvider();

        // App constants
        var DAILY_LIMIT_MS = 5 * 60 * 60 * 1000; // 5 hours
        var REWARD_RATE = 40; // 40 Kz per hour
        var AUTO_SAVE_INTERVAL = 30 * 1000; // 30 seconds
        var MIN_WITHDRAWAL = 50;
        var REFERRAL_BONUS = 50;

        // App state
        var currentUser = null;
        var isTimerActive = false;
        var timerInterval = null;
        var autoSaveInterval = null;
        var sessionStartTime = null;
        var allUsers = [];
        var userPin = null;
        var transferEnabled = true;
        var userReferralCode = null;
        var userNotifications = [];
        var notificationListener = null;

        // User data
        var userData = {
            todayTime: 0,
            totalRewards: 0,
            lastActiveTime: null,
            pendingWithdrawal: null,
            lastTransferDate: null,
            lastSaveDate: getTodayKey()
        };

        // Utility functions
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function formatTime(milliseconds) {
            var hours = Math.floor(milliseconds / (1000 * 60 * 60));
            var minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);
            return padStart(hours, 2, '0') + ':' + padStart(minutes, 2, '0') + ':' + padStart(seconds, 2, '0');
        }

        function padStart(str, length, char) {
            str = String(str);
            while (str.length < length) {
                str = char + str;
            }
            return str;
        }

        function formatCurrency(amount) {
            return amount.toFixed(2).replace('.', ',') + ' Kz';
        }

        function formatDate(timestamp) {
            var date = new Date(timestamp);
            return padStart(date.getDate(), 2, '0') + '/' + 
                   padStart(date.getMonth() + 1, 2, '0') + '/' + 
                   date.getFullYear() + ' ' + 
                   padStart(date.getHours(), 2, '0') + ':' + 
                   padStart(date.getMinutes(), 2, '0');
        }

        function calculateRewards(timeMs) {
            var hours = timeMs / (1000 * 60 * 60);
            return Math.floor(hours * REWARD_RATE * 100) / 100;
        }

        function hashPin(pin) {
            var hash = 0;
            for (var i = 0; i < pin.length; i++) {
                var char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Make overlay functions global
        function openOverlay(overlayId) {
            document.getElementById(overlayId).classList.add('show');
            
            // Load data when opening specific overlays
            if (overlayId === 'historyOverlay') {
                loadHistoryData();
            } else if (overlayId === 'leaderboardOverlay') {
                loadLeaderboardData();
            } else if (overlayId === 'notificationsOverlay') {
                loadNotificationsData();
            }
        }

        function closeOverlay(overlayId) {
            document.getElementById(overlayId).classList.remove('show');
        }

        // Close overlays when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('overlay-modal')) {
                event.target.classList.remove('show');
            }
        });

        // Notification system
        function showNotification(message, type, duration) {
            type = type || 'success';
            duration = duration || 4000;
            
            var container = document.getElementById('notificationContainer');
            
            var colors = {
                success: '#10B981',
                error: '#EF4444',
                warning: '#F59E0B',
                info: '#3B82F6'
            };

            var notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.background = colors[type];
            notification.innerHTML = '<div class="flex items-center justify-between"><span>' + message + '</span><button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 font-bold">×</button></div>';

            container.appendChild(notification);

            setTimeout(function() {
                notification.classList.add('show');
            }, 100);

            setTimeout(function() {
                notification.classList.remove('show');
                setTimeout(function() {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // Custom modal dialogs
        function showConfirmDialog(message, onConfirm) {
            var modal = document.getElementById('deleteConfirmModal');
            var messageEl = document.getElementById('deleteConfirmMessage');
            var confirmBtn = document.getElementById('deleteConfirm');
            
            messageEl.textContent = message;
            
            // Remove previous listeners
            var newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', function() {
                onConfirm();
                hideModal('deleteConfirmModal');
            });
            
            showModal('deleteConfirmModal');
        }

        // Save indicator
        function showSaveIndicator() {
            var indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(function() {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Notifications functions
        function loadNotificationsData() {
            if (!currentUser) return;

            try {
                database.ref('notifications/' + currentUser.uid).once('value', function(snapshot) {
                    userNotifications = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(function(child) {
                            userNotifications.push({
                                id: child.key,
                                message: child.val().message,
                                type: child.val().type,
                                timestamp: child.val().timestamp,
                                read: child.val().read
                            });
                        });
                    }

                    userNotifications.sort(function(a, b) { return b.timestamp - a.timestamp; });
                    updateNotificationsDisplay();
                });
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function updateNotificationsDisplay() {
            var container = document.getElementById('notificationsList');
            var badge = document.getElementById('notificationBadge');
            var quickNavBadge = document.getElementById('quickNavNotificationBadge');
            
            container.innerHTML = '';

            if (userNotifications.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><div class="text-4xl mb-2">🔔</div><p>Nenhuma notificação ainda</p><p class="text-sm mt-2">Suas notificações aparecerão aqui</p></div>';
                badge.classList.add('hidden');
                quickNavBadge.classList.add('hidden');
                return;
            }

            var unreadCount = 0;
            for (var i = 0; i < userNotifications.length; i++) {
                if (!userNotifications[i].read) unreadCount++;
            }
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
                quickNavBadge.textContent = unreadCount;
                quickNavBadge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                quickNavBadge.classList.add('hidden');
            }

            for (var i = 0; i < userNotifications.length; i++) {
                var notification = userNotifications[i];
                var div = document.createElement('div');
                div.className = 'notification-item ' + (notification.read ? '' : 'unread');
                
                var typeIcon = getNotificationIcon(notification.type);
                
                div.innerHTML = '<div class="flex-1"><div class="flex items-start space-x-3"><div class="text-2xl">' + typeIcon + '</div><div class="flex-1"><div class="font-medium text-gray-900 dark:text-white">' + notification.message + '</div><div class="text-sm text-gray-500 mt-1">' + formatDate(notification.timestamp) + '</div>' + (!notification.read ? '<span class="inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded-full mt-2">Nova</span>' : '') + '</div></div></div><div class="flex items-center space-x-2 ml-4">' + (!notification.read ? '<button onclick="markNotificationAsRead(\'' + notification.id + '\')" class="text-blue-500 hover:text-blue-700 text-sm font-medium">Marcar como lida</button>' : '') + '<button onclick="deleteNotification(\'' + notification.id + '\')" class="text-red-500 hover:text-red-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>';
                
                container.appendChild(div);
            }
        }

        function getNotificationIcon(type) {
            var icons = {
                success: '✅',
                warning: '⚠️',
                error: '❌',
                info: 'ℹ️',
                money: '💰',
                gift: '🎁',
                system: '⚙️'
            };
            return icons[type] || '📢';
        }

        // Make functions global for onclick handlers
        function markNotificationAsRead(notificationId) {
            if (!currentUser) return;
            
            try {
                database.ref('notifications/' + currentUser.uid + '/' + notificationId).update({ read: true });
                
                // Update local state
                for (var i = 0; i < userNotifications.length; i++) {
                    if (userNotifications[i].id === notificationId) {
                        userNotifications[i].read = true;
                        break;
                    }
                }
                
                updateNotificationsDisplay();
                showNotification('Notificação marcada como lida', 'success', 2000);
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showNotification('Erro ao marcar como lida', 'error');
            }
        }

        function deleteNotification(notificationId) {
            showConfirmDialog('Tem certeza que quer apagar esta notificação?', function() {
                if (!currentUser) return;
                
                try {
                    database.ref('notifications/' + currentUser.uid + '/' + notificationId).remove();
                    
                    // Update local state
                    userNotifications = userNotifications.filter(function(n) { return n.id !== notificationId; });
                    updateNotificationsDisplay();
                    
                    showNotification('Notificação apagada', 'success', 2000);
                    
                } catch (error) {
                    console.error('Error deleting notification:', error);
                    showNotification('Erro ao apagar notificação', 'error');
                }
            });
        }

        function markAllNotificationsAsRead() {
            if (!currentUser || userNotifications.length === 0) return;
            
            try {
                var updates = {};
                var hasUnread = false;
                
                for (var i = 0; i < userNotifications.length; i++) {
                    if (!userNotifications[i].read) {
                        updates['notifications/' + currentUser.uid + '/' + userNotifications[i].id + '/read'] = true;
                        userNotifications[i].read = true;
                        hasUnread = true;
                    }
                }
                
                if (hasUnread) {
                    database.ref().update(updates);
                    updateNotificationsDisplay();
                    showNotification('Todas as notificações foram marcadas como lidas', 'success');
                } else {
                    showNotification('Não há notificações não lidas', 'info');
                }
                
            } catch (error) {
                console.error('Error marking all as read:', error);
                showNotification('Erro ao marcar todas como lidas', 'error');
            }
        }

        function deleteAllNotifications() {
            if (!currentUser || userNotifications.length === 0) {
                showNotification('Não há notificações para apagar', 'info');
                return;
            }

            showConfirmDialog('Tem certeza que quer apagar todas as ' + userNotifications.length + ' notificações?', function() {
                try {
                    database.ref('notifications/' + currentUser.uid).remove();
                    
                    userNotifications = [];
                    updateNotificationsDisplay();
                    
                    showNotification('Todas as notificações foram apagadas', 'success');
                    
                } catch (error) {
                    console.error('Error deleting all notifications:', error);
                    showNotification('Erro ao apagar notificações', 'error');
                }
            });
        }

        function startNotificationListener() {
            if (!currentUser || notificationListener) return;
            
            notificationListener = database.ref('notifications/' + currentUser.uid).on('value', function(snapshot) {
                if (snapshot.exists()) {
                    var newNotifications = [];
                    snapshot.forEach(function(child) {
                        newNotifications.push({
                            id: child.key,
                            message: child.val().message,
                            type: child.val().type,
                            timestamp: child.val().timestamp,
                            read: child.val().read
                        });
                    });
                    
                    // Check for new notifications
                    var oldIds = userNotifications.map(function(n) { return n.id; });
                    var newOnes = newNotifications.filter(function(n) { return oldIds.indexOf(n.id) === -1; });
                    
                    if (newOnes.length > 0 && userNotifications.length > 0) {
                        for (var i = 0; i < newOnes.length; i++) {
                            showNotification('Nova notificação: ' + newOnes[i].message, 'info', 5000);
                        }
                    }
                    
                    userNotifications = newNotifications.sort(function(a, b) { return b.timestamp - a.timestamp; });
                    updateNotificationsDisplay();
                }
            });
        }

        function stopNotificationListener() {
            if (notificationListener) {
                database.ref('notifications/' + currentUser.uid).off('value', notificationListener);
                notificationListener = null;
            }
        }

        // Timer functions
        function startTimer() {
            if (isTimerActive) return;
            
            isTimerActive = true;
            sessionStartTime = Date.now();
            userData.lastActiveTime = Date.now();
            
            document.getElementById('timerStatus').className = 'status-indicator status-active';
            document.getElementById('timerStatusIndicator').className = 'status-indicator status-active';
            timerInterval = setInterval(updateTimer, 1000);
            
            startAutoSave();
            showNotification('Timer iniciado! Comece a ganhar dinheiro! 💰', 'success');
        }

        function stopTimer() {
            if (!isTimerActive) return;
            
            var now = Date.now();
            if (sessionStartTime) {
                var sessionDuration = now - sessionStartTime;
                userData.todayTime += sessionDuration;
                sessionStartTime = null;
            }
            
            isTimerActive = false;
            userData.lastActiveTime = now;
            
            document.getElementById('timerStatus').className = 'status-indicator status-inactive';
            document.getElementById('timerStatusIndicator').className = 'status-indicator status-inactive';
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            saveUserData();
            showNotification('Timer pausado! Dados salvos automaticamente 💾', 'info');
        }

        function updateTimer() {
            if (!isTimerActive || !sessionStartTime) return;
            
            var now = Date.now();
            var currentSessionTime = now - sessionStartTime;
            var totalTodayTime = userData.todayTime + currentSessionTime;
            
            if (totalTodayTime >= DAILY_LIMIT_MS) {
                userData.todayTime = DAILY_LIMIT_MS;
                stopTimer();
                showNotification('🎉 Parabéns! Você atingiu o limite diário de 5 horas!', 'success', 6000);
                return;
            }
            
            updateDisplay();
        }

        function updateDisplay() {
            var now = Date.now();
            var currentSessionTime = isTimerActive && sessionStartTime ? now - sessionStartTime : 0;
            var totalTodayTime = userData.todayTime + currentSessionTime;
            
            // Update timer display
            document.getElementById('todayTime').textContent = formatTime(totalTodayTime);
            document.getElementById('sessionTime').textContent = formatTime(currentSessionTime);
            
            // Update progress
            var progressPercent = (totalTodayTime / DAILY_LIMIT_MS) * 100;
            var timerCircle = document.getElementById('timerCircle');
            timerCircle.style.setProperty('--progress', Math.min(progressPercent, 100) + '%');
            
            document.getElementById('timeProgress').textContent = Math.min(progressPercent, 100).toFixed(1) + '%';
            document.getElementById('timeProgressBar').style.width = Math.min(progressPercent, 100) + '%';
            
            // Update rewards
            var todayRewards = calculateRewards(totalTodayTime);
            var totalAvailable = userData.totalRewards + todayRewards;
            
            document.getElementById('todayRewards').textContent = formatCurrency(todayRewards);
            document.getElementById('totalRewards').textContent = formatCurrency(totalAvailable);
            document.getElementById('todayEarnings').textContent = formatCurrency(todayRewards);
            document.getElementById('availableEarnings').textContent = formatCurrency(totalAvailable);
            document.getElementById('totalEarningsDisplay').textContent = formatCurrency(totalAvailable);
            document.getElementById('availableAmount').textContent = formatCurrency(totalAvailable);
            document.getElementById('maxTransferAmount').textContent = formatCurrency(totalAvailable);
            
            // Update status
            document.getElementById('userStatus').textContent = isTimerActive ? 'Trabalhando' : 'Pausado';
            document.getElementById('userStatus').className = 'font-medium ' + (isTimerActive ? 'text-green-500' : 'text-gray-500');
            document.getElementById('transferStatus').textContent = transferEnabled ? 'Habilitado' : 'Desabilitado';
            document.getElementById('transferStatus').className = 'font-medium ' + (transferEnabled ? 'text-green-500' : 'text-red-500');
            
            // Update pending
            updatePendingDisplay();
        }

        function updatePendingDisplay() {
            var pendingInfo = document.getElementById('pendingInfo');
            
            if (userData.pendingWithdrawal) {
                pendingInfo.innerHTML = '<div class="text-center"><div class="text-3xl mb-2">⏳</div><div class="text-lg font-bold text-orange-500 mb-2">' + formatCurrency(userData.pendingWithdrawal.amount) + '</div><div class="text-sm text-gray-600 dark:text-gray-400">Levantamento pendente</div><div class="text-xs text-gray-500 mt-1">Aguardando aprovação</div></div>';
            } else {
                pendingInfo.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4"><div class="text-3xl mb-2">✅</div><p>Nenhum pedido pendente</p></div>';
            }
        }

        // Auto-save system
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(function() {
                if (currentUser && isTimerActive) {
                    saveUserData();
                    showSaveIndicator();
                }
            }, AUTO_SAVE_INTERVAL);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        // Data functions
        function saveUserData() {
            if (!currentUser) return;
            
            var today = getTodayKey();
            
            try {
                var saveData = {
                    name: currentUser.displayName,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    totalRewards: userData.totalRewards,
                    todayTime: userData.todayTime,
                    lastActiveTime: userData.lastActiveTime || Date.now(),
                    lastSaveDate: today,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                    pin: userPin,
                    transferEnabled: transferEnabled,
                    referralCode: userReferralCode,
                    lastTransferDate: userData.lastTransferDate,
                    pendingWithdrawal: userData.pendingWithdrawal
                };
                
                database.ref('users/' + currentUser.uid).set(saveData);
                
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        function loadUserData() {
            if (!currentUser) return;
            
            try {
                database.ref('users/' + currentUser.uid).once('value', function(snapshot) {
                    if (snapshot.exists()) {
                        var data = snapshot.val();
                        var today = getTodayKey();
                        
                        userPin = data.pin;
                        transferEnabled = data.transferEnabled !== false;
                        userReferralCode = data.referralCode;
                        userData.totalRewards = data.totalRewards || 0;
                        userData.lastSaveDate = data.lastSaveDate;
                        userData.lastTransferDate = data.lastTransferDate;
                        userData.pendingWithdrawal = data.pendingWithdrawal || null;
                        
                        if (data.lastSaveDate === today) {
                            userData.todayTime = data.todayTime || 0;
                        } else {
                            userData.todayTime = 0;
                        }
                        
                        userData.lastActiveTime = data.lastActiveTime;
                    } else {
                        userData = {
                            todayTime: 0,
                            totalRewards: 0,
                            lastActiveTime: Date.now(),
                            pendingWithdrawal: null,
                            lastTransferDate: null,
                            lastSaveDate: getTodayKey()
                        };
                        transferEnabled = true;
                    }
                    
                    updateDisplay();
                    
                    if (!userPin) {
                        setTimeout(function() { showModal('pinSetupModal'); }, 2000);
                    }

                    if (!userReferralCode) {
                        createUserReferralCode();
                    } else {
                        updateReferralDisplay();
                    }

                    loadUserReferrals();
                });
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Referral functions
        function generateReferralCode() {
            var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            var result = '';
            for (var i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function createUserReferralCode() {
            if (!currentUser) return;

            try {
                database.ref('users/' + currentUser.uid).once('value', function(snapshot) {
                    if (snapshot.exists()) {
                        var userData = snapshot.val();
                        if (userData.referralCode) {
                            userReferralCode = userData.referralCode;
                            updateReferralDisplay();
                            return;
                        }
                    }

                    function tryCreateCode() {
                        var code = generateReferralCode();
                        database.ref('referralCodes/' + code).once('value', function(codeSnapshot) {
                            if (!codeSnapshot.exists()) {
                                database.ref('referralCodes/' + code).set({
                                    userId: currentUser.uid,
                                    userName: currentUser.displayName,
                                    createdAt: Date.now()
                                });

                                database.ref('users/' + currentUser.uid).update({
                                    referralCode: code
                                });

                                userReferralCode = code;
                                updateReferralDisplay();
                            } else {
                                tryCreateCode(); // Try again with different code
                            }
                        });
                    }

                    tryCreateCode();
                });

            } catch (error) {
                console.error('Error creating referral code:', error);
            }
        }

        function updateReferralDisplay() {
            var codeEl = document.getElementById('userReferralCode');
            if (codeEl && userReferralCode) {
                codeEl.textContent = userReferralCode;
            }
        }

        function processReferralCode(code) {
            if (!code || !currentUser) return;

            code = code.trim().toUpperCase();
            
            if (code.length !== 6) {
                showReferralStatus('Código deve ter 6 caracteres.', 'error');
                return;
            }

            try {
                database.ref('referralCodes/' + code).once('value', function(snapshot) {
                    if (!snapshot.exists()) {
                        showReferralStatus('Código inválido.', 'error');
                        return;
                    }

                    var codeData = snapshot.val();
                    if (codeData.userId === currentUser.uid) {
                        showReferralStatus('Não pode usar seu próprio código.', 'error');
                        return;
                    }

                    database.ref('users/' + currentUser.uid).once('value', function(userSnapshot) {
                        if (userSnapshot.exists() && userSnapshot.val().usedReferralCode) {
                            showReferralStatus('Você já usou um código.', 'warning');
                            return;
                        }

                        database.ref('pendingReferrals').push({
                            referrerUserId: codeData.userId,
                            referrerName: codeData.userName,
                            newUserId: currentUser.uid,
                            newUserName: currentUser.displayName,
                            newUserEmail: currentUser.email,
                            code: code,
                            timestamp: Date.now(),
                            status: 'pending'
                        });

                        database.ref('users/' + currentUser.uid).update({
                            usedReferralCode: code,
                            referredBy: codeData.userId
                        });

                        showReferralStatus('Código aplicado! Aguardando aprovação.', 'success');
                        document.getElementById('newReferralCodeInput').value = '';
                    });
                });

            } catch (error) {
                console.error('Error processing referral:', error);
                showReferralStatus('Erro ao processar código.', 'error');
            }
        }

        function showReferralStatus(message, type) {
            var statusEl = document.getElementById('referralCodeStatus');
            var colors = {
                success: 'bg-green-50 dark:bg-green-900/20 border-green-200 text-green-800',
                error: 'bg-red-50 dark:bg-red-900/20 border-red-200 text-red-800',
                warning: 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 text-yellow-800'
            };

            statusEl.className = 'mt-3 p-3 border rounded-lg ' + colors[type];
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');

            setTimeout(function() {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        function loadUserReferrals() {
            if (!currentUser) return;

            try {
                database.ref('confirmedReferrals').once('value', function(snapshot) {
                    var confirmed = 0;
                    var bonus = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(function(child) {
                            var referral = child.val();
                            if (referral.referrerUserId === currentUser.uid) {
                                confirmed++;
                                bonus += REFERRAL_BONUS;
                            }
                        });
                    }

                    database.ref('pendingReferrals').once('value', function(pendingSnapshot) {
                        var pending = 0;
                        if (pendingSnapshot.exists()) {
                            pendingSnapshot.forEach(function(child) {
                                var referral = child.val();
                                if (referral.referrerUserId === currentUser.uid && referral.status === 'pending') {
                                    pending++;
                                }
                            });
                        }

                        document.getElementById('confirmedReferrals').textContent = confirmed;
                        document.getElementById('pendingReferrals').textContent = pending;
                        document.getElementById('referralBonus').textContent = formatCurrency(bonus);
                    });
                });

            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        // Load other users for transfer
        function loadUsers() {
            try {
                database.ref('users').once('value', function(snapshot) {
                    allUsers = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(function(child) {
                            if (child.key !== (currentUser ? currentUser.uid : null)) {
                                allUsers.push({
                                    id: child.key,
                                    name: child.val().name,
                                    email: child.val().email,
                                    photoURL: child.val().photoURL,
                                    totalRewards: child.val().totalRewards,
                                    todayTime: child.val().todayTime
                                });
                            }
                        });
                    }

                    updateTransferUserOptions();
                });

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function updateTransferUserOptions() {
            var select = document.getElementById('transferUserSelect');
            select.innerHTML = '<option value="">Escolha um usuário...</option>';
            
            for (var i = 0; i < allUsers.length; i++) {
                var option = document.createElement('option');
                option.value = allUsers[i].id;
                option.textContent = allUsers[i].name;
                select.appendChild(option);
            }
        }

        // History and leaderboard
        function loadHistoryData() {
            if (!currentUser) return;
            
            try {
                database.ref('transferHistory/' + currentUser.uid).once('value', function(snapshot) {
                    var history = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(function(child) {
                            history.push(child.val());
                        });
                    }

                    history.sort(function(a, b) { return b.timestamp - a.timestamp; });
                    
                    var container = document.getElementById('historyList');
                    container.innerHTML = '';

                    if (history.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-2">📋</div><p>Nenhuma atividade ainda</p><p class="text-sm mt-2">Suas transferências aparecerão aqui</p></div>';
                        return;
                    }

                    for (var i = 0; i < history.length; i++) {
                        var item = history[i];
                        var div = document.createElement('div');
                        div.className = 'history-item';
                        
                        var typeText = item.type === 'sent' ? 'Enviado para' : 'Recebido de';
                        var typeColor = item.type === 'sent' ? 'text-red-500' : 'text-green-500';
                        var typeIcon = item.type === 'sent' ? '📤' : '📥';
                        var otherUser = item.type === 'sent' ? item.toName : item.fromName;
                        
                        div.innerHTML = '<div class="flex-1"><div class="flex items-center space-x-2 mb-1"><span class="text-lg">' + typeIcon + '</span><div class="font-medium text-gray-900 dark:text-white">' + typeText + ' ' + otherUser + '</div></div><div class="text-sm text-gray-500 ml-7">' + formatDate(item.timestamp) + '</div></div><div class="text-right"><div class="font-bold ' + typeColor + ' text-lg">' + formatCurrency(item.amount) + '</div><div class="text-xs text-gray-500">Concluído ✅</div></div>';
                        
                        container.appendChild(div);
                    }
                });

            } catch (error) {
                console.error('Error loading history:', error);
                showNotification('Erro ao carregar histórico', 'error');
            }
        }

        function loadLeaderboardData() {
            try {
                database.ref('users').once('value', function(snapshot) {
                    var users = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(function(child) {
                            users.push({
                                id: child.key,
                                name: child.val().name,
                                photoURL: child.val().photoURL,
                                totalRewards: child.val().totalRewards || 0,
                                todayTime: child.val().todayTime || 0
                            });
                        });
                    }

                    users.sort(function(a, b) { return (b.totalRewards || 0) - (a.totalRewards || 0); });
                    
                    var container = document.getElementById('leaderboardList');
                    container.innerHTML = '';

                    if (users.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-2">🏆</div><p>Nenhum usuário ainda</p></div>';
                        return;
                    }

                    var topUsers = users.slice(0, 10);
                    for (var i = 0; i < topUsers.length; i++) {
                        var user = topUsers[i];
                        var div = document.createElement('div');
                        div.className = 'leaderboard-row';
                        
                        if (user.id === (currentUser ? currentUser.uid : null)) {
                            div.style.background = 'linear-gradient(135deg, #DBEAFE 0%, #93C5FD 100%)';
                            div.style.borderLeft = '4px solid #3B82F6';
                        }
                        
                        var medals = ['🥇', '🥈', '🥉'];
                        var position = i < 3 ? medals[i] : (i + 1) + 'º';
                        
                        div.innerHTML = '<div class="flex items-center flex-1"><div class="text-2xl mr-4 font-bold">' + position + '</div><img class="w-12 h-12 rounded-full mr-3 border-2 border-gray-200" src="' + user.photoURL + '" alt="" onerror="this.src=\'data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"48\\" height=\\"48\\" fill=\\"%23999\\" viewBox=\\"0 0 24 24\\"><path d=\\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\\"/></svg>\'"><div class="flex-1"><div class="font-medium text-gray-900 dark:text-white flex items-center">' + user.name + ' ' + (user.id === (currentUser ? currentUser.uid : null) ? '<span class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full">Você</span>' : '') + '</div><div class="text-sm text-gray-500">Tempo hoje: ' + formatTime(user.todayTime || 0) + '</div></div></div><div class="text-right"><div class="font-bold text-primary text-lg">' + formatCurrency(user.totalRewards || 0) + '</div><div class="text-xs text-gray-500">Total ganho</div></div>';
                        
                        container.appendChild(div);
                    }
                });

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showNotification('Erro ao carregar ranking', 'error');
            }
        }

        // Withdrawal functions
        function processWithdrawal() {
            var amount = parseFloat(document.getElementById('withdrawAmount').value);
            var method = document.getElementById('paymentMethod').value;
            var details = document.getElementById('paymentDetails').value.trim();
            
            if (!amount || amount < MIN_WITHDRAWAL) {
                showNotification('Valor mínimo: ' + formatCurrency(MIN_WITHDRAWAL), 'error');
                return;
            }
            
            if (!method || !details) {
                showNotification('Preencha todos os campos!', 'error');
                return;
            }
            
            var currentSessionTime = isTimerActive && sessionStartTime ? Date.now() - sessionStartTime : 0;
            var todayRewards = calculateRewards(userData.todayTime + currentSessionTime);
            var totalAvailable = userData.totalRewards + todayRewards;
            
            if (amount > totalAvailable) {
                showNotification('Valor insuficiente!', 'error');
                return;
            }

            try {
                var methodNames = {
                    'multicaixa': 'Multicaixa Express',
                    'unitel': 'Unitel Money',
                    'banco': 'Transferência Bancária'
                };

                var withdrawalData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    amount: amount,
                    paymentMethod: methodNames[method],
                    paymentDetails: details,
                    status: 'pending',
                    requestDate: Date.now()
                };

                database.ref('withdrawalRequests').push(withdrawalData).then(function(newWithdrawalRef) {
                    userData.totalRewards = 0;
                    userData.todayTime = 0;
                    userData.pendingWithdrawal = {
                        id: newWithdrawalRef.key,
                        amount: amount,
                        timestamp: Date.now()
                    };

                    saveUserData();
                    updateDisplay();
                    hideModal('withdrawModal');
                    
                    if (isTimerActive) {
                        stopTimer();
                    }
                    
                    showNotification('Levantamento de ' + formatCurrency(amount) + ' solicitado! ⏳', 'success');
                    
                    // Clear form
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('paymentMethod').value = '';
                    document.getElementById('paymentDetails').value = '';
                });
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showNotification('Erro ao solicitar levantamento!', 'error');
            }
        }

        // Transfer functions
        function canTransferToday() {
            var today = getTodayKey();
            return userData.lastTransferDate !== today;
        }

        function processTransfer() {
            if (!canTransferToday()) {
                showNotification('Você já transferiu hoje! Tente amanhã.', 'warning');
                return;
            }

            var recipientId = document.getElementById('transferUserSelect').value;
            var amount = parseFloat(document.getElementById('transferAmount').value);
            var pin = document.getElementById('transferPin').value;
            
            if (!recipientId || !amount || !pin) {
                showNotification('Preencha todos os campos!', 'error');
                return;
            }

            if (pin.length !== 6 || hashPin(pin) !== userPin) {
                showNotification('PIN incorreto!', 'error');
                return;
            }

            var currentSessionTime = isTimerActive && sessionStartTime ? Date.now() - sessionStartTime : 0;
            var todayRewards = calculateRewards(userData.todayTime + currentSessionTime);
            var totalAvailable = userData.totalRewards + todayRewards;
            
            if (amount > totalAvailable) {
                showNotification('Valor insuficiente!', 'error');
                return;
            }

            try {
                var recipient = null;
                for (var i = 0; i < allUsers.length; i++) {
                    if (allUsers[i].id === recipientId) {
                        recipient = allUsers[i];
                        break;
                    }
                }
                
                var now = Date.now();
                var today = getTodayKey();
                
                if (sessionStartTime) {
                    var currentSession = now - sessionStartTime;
                    userData.todayTime += currentSession;
                    sessionStartTime = now;
                }
                
                var newSenderTotal = totalAvailable - amount;
                userData.totalRewards = newSenderTotal;
                userData.todayTime = 0;
                userData.lastTransferDate = today;
                
                database.ref('users/' + currentUser.uid).update({
                    totalRewards: newSenderTotal,
                    todayTime: 0,
                    lastTransferDate: today,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });
                
                database.ref('users/' + recipientId).once('value', function(recipientSnapshot) {
                    var recipientData = recipientSnapshot.val();
                    var newRecipientTotal = (recipientData.totalRewards || 0) + amount;
                    database.ref('users/' + recipientId).update({
                        totalRewards: newRecipientTotal,
                        lastUpdate: firebase.database.ServerValue.TIMESTAMP
                    });
                });
                
                // Add transfer history
                database.ref('transferHistory/' + currentUser.uid).push({
                    from: currentUser.uid,
                    fromName: currentUser.displayName,
                    to: recipientId,
                    toName: recipient.name,
                    amount: amount,
                    timestamp: now,
                    type: 'sent'
                });
                
                database.ref('transferHistory/' + recipientId).push({
                    from: currentUser.uid,
                    fromName: currentUser.displayName,
                    to: recipientId,
                    toName: recipient.name,
                    amount: amount,
                    timestamp: now,
                    type: 'received'
                });

                // Send notification to recipient
                database.ref('notifications/' + recipientId).push({
                    message: '💰 ' + currentUser.displayName + ' enviou ' + formatCurrency(amount) + ' para você!',
                    type: 'money',
                    timestamp: now,
                    read: false
                });
                
                updateDisplay();
                hideModal('transferModal');
                
                showNotification('Transferência de ' + formatCurrency(amount) + ' realizada! 🚀', 'success');
                
                // Clear form
                document.getElementById('transferUserSelect').value = '';
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferPin').value = '';
                
            } catch (error) {
                console.error('Error processing transfer:', error);
                showNotification('Erro ao transferir!', 'error');
            }
        }

        // PIN functions
        function setupPin() {
            var pin1 = document.getElementById('newPin').value;
            var pin2 = document.getElementById('confirmPin').value;
            
            if (pin1.length !== 6 || !/^\d{6}$/.test(pin1)) {
                showNotification('PIN deve ter 6 dígitos!', 'error');
                return;
            }
            
            if (pin1 !== pin2) {
                showNotification('PINs não coincidem!', 'error');
                return;
            }
            
            userPin = hashPin(pin1);
            saveUserData();
            
            hideModal('pinSetupModal');
            document.getElementById('newPin').value = '';
            document.getElementById('confirmPin').value = '';
            
            showNotification('PIN configurado com sucesso! 🔐', 'success');
        }

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', function() {
            try {
                var referralCode = document.getElementById('referralCodeInput').value.trim().toUpperCase();
                auth.signInWithPopup(provider).then(function() {
                    if (referralCode) {
                        setTimeout(function() {
                            processReferralCode(referralCode);
                        }, 2000);
                    }
                }).catch(function(error) {
                    console.error('Login error:', error);
                    showNotification('Erro no login!', 'error');
                });
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Erro no login!', 'error');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            try {
                if (isTimerActive) {
                    stopTimer();
                }
                stopAutoSave();
                stopNotificationListener();
                saveUserData();
                auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Timer click
        document.getElementById('timerCircle').addEventListener('click', function() {
            if (isTimerActive) {
                stopTimer();
            } else {
                startTimer();
            }
        });

        // Action buttons
        document.getElementById('withdrawBtn').addEventListener('click', function() {
            if (userData.pendingWithdrawal) {
                showNotification('Você já tem um levantamento pendente!', 'warning');
                return;
            }
            showModal('withdrawModal');
        });

        document.getElementById('transferBtn').addEventListener('click', function() {
            if (!userPin) {
                showNotification('Configure seu PIN primeiro!', 'warning');
                showModal('pinSetupModal');
                return;
            }
            if (!transferEnabled) {
                showNotification('Transferências desabilitadas pelo admin!', 'error');
                return;
            }
            showModal('transferModal');
        });

        // Modal buttons
        document.getElementById('withdrawCancel').addEventListener('click', function() { hideModal('withdrawModal'); });
        document.getElementById('withdrawConfirm').addEventListener('click', processWithdrawal);
        document.getElementById('transferCancel').addEventListener('click', function() { hideModal('transferModal'); });
        document.getElementById('transferConfirm').addEventListener('click', processTransfer);
        document.getElementById('pinSetupCancel').addEventListener('click', function() { hideModal('pinSetupModal'); });
        document.getElementById('pinSetupConfirm').addEventListener('click', setupPin);
        document.getElementById('deleteCancel').addEventListener('click', function() { hideModal('deleteConfirmModal'); });

        // Notification actions
        document.getElementById('markAllAsRead').addEventListener('click', markAllNotificationsAsRead);
        document.getElementById('deleteAllNotifications').addEventListener('click', deleteAllNotifications);

        // Referral actions
        document.getElementById('copyReferralCode').addEventListener('click', function() {
            if (userReferralCode) {
                // Fallback for older browsers
                var textArea = document.createElement('textarea');
                textArea.value = userReferralCode;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Código copiado! 📋', 'success');
                } catch (err) {
                    showNotification('Erro ao copiar código', 'error');
                }
                document.body.removeChild(textArea);
            }
        });

        document.getElementById('submitReferralCode').addEventListener('click', function() {
            var code = document.getElementById('newReferralCodeInput').value.trim();
            if (code) {
                processReferralCode(code);
            }
        });

        // Format inputs
        document.getElementById('referralCodeInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        document.getElementById('newReferralCodeInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (isTimerActive) {
                    saveUserData();
                }
            } else if (currentUser) {
                updateDisplay();
            }
        });

        // Before unload
        window.addEventListener('beforeunload', function() {
            if (isTimerActive) {
                saveUserData();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close any open overlays
                var overlays = document.querySelectorAll('.overlay-modal.show');
                for (var i = 0; i < overlays.length; i++) {
                    overlays[i].classList.remove('show');
                }
                // Close any open modals
                var modals = document.querySelectorAll('.modal.show');
                for (var i = 0; i < modals.length; i++) {
                    modals[i].classList.remove('show');
                }
            }
        });

        // Auth state listener
        auth.onAuthStateChanged(function(user) {
            var loadingScreen = document.getElementById('loadingScreen');
            var loginScreen = document.getElementById('loginScreen');
            var mainApp = document.getElementById('mainApp');
            
            loadingScreen.classList.add('hidden');
            
            if (user) {
                currentUser = user;
                
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;
                
                loadUserData();
                loadUsers();
                loadNotificationsData();
                
                startAutoSave();
                startNotificationListener();
                
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                showNotification('Bem-vindo de volta, ' + user.displayName.split(' ')[0] + '! 🎉', 'success');
                
            } else {
                currentUser = null;
                if (isTimerActive) {
                    stopTimer();
                }
                stopAutoSave();
                stopNotificationListener();
                
                userData = {
                    todayTime: 0,
                    totalRewards: 0,
                    lastActiveTime: null,
                    pendingWithdrawal: null,
                    lastTransferDate: null,
                    lastSaveDate: getTodayKey()
                };
                userPin = null;
                transferEnabled = true;
                userReferralCode = null;
                userNotifications = [];
                
                updateDisplay();
                
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

        // Initial display update
        updateDisplay();
    </script>
</body>
</html>